<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Hibt Trading</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: #0f0f0f; 
            color: #fff; 
        }
        
        .login-container { 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 20px; 
        }
        .login-box { 
            background: #1a1a1a; 
            border-radius: 20px; 
            padding: 40px; 
            width: 90%; 
            max-width: 400px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); 
        }
        .login-title { 
            font-size: 28px; 
            font-weight: bold; 
            margin-bottom: 30px; 
            text-align: center; 
            color: #4285f4; 
        }
        
        .admin-panel { display: none; min-height: 100vh; }
        .admin-panel.active { display: block; }
        
        .header { 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); 
            padding: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .header h1 { font-size: 24px; }
        
        .container { 
            padding: 20px; 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        .input-group { margin-bottom: 20px; }
        label { 
            display: block; 
            margin-bottom: 8px; 
            color: #aaa; 
            font-weight: 500; 
        }
        input, select { 
            width: 100%; 
            padding: 15px; 
            border: 2px solid #2a2a2a; 
            border-radius: 12px; 
            font-size: 16px; 
            background: #0f0f0f; 
            color: #fff; 
        }
        input:focus, select:focus { outline: none; border-color: #4285f4; }
        
        .btn { 
            padding: 15px 30px; 
            border: none; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
        }
        .btn-primary { background: #4285f4; color: white; width: 100%; }
        .btn-primary:hover { background: #3367d6; }
        .btn-small { padding: 8px 16px; font-size: 14px; }
        .btn-success { background: #4caf50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        
        .message { 
            padding: 15px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            font-weight: 500; 
        }
        .error { background: #fee; color: #c33; border: 1px solid #fcc; }
        .success { background: #efe; color: #363; border: 1px solid #cfc; }
        
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .stat-card { 
            background: #1a1a1a; 
            padding: 20px; 
            border-radius: 15px; 
            text-align: center; 
        }
        .stat-value { 
            font-size: 32px; 
            font-weight: bold; 
            color: #4285f4; 
            margin-bottom: 5px; 
        }
        .stat-label { color: #888; font-size: 14px; }
        
        .filters { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
        }
        .filter-btn { 
            padding: 12px 24px; 
            background: #1a1a1a; 
            border: 2px solid #2a2a2a; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 600; 
            color: #fff; 
        }
        .filter-btn.active { background: #4285f4; border-color: #4285f4; }
        
        .data-table { 
            background: #1a1a1a; 
            border-radius: 15px; 
            overflow: hidden; 
            margin-bottom: 20px;
        }
        .table-header { 
            display: grid; 
            gap: 15px; 
            padding: 15px 20px; 
            background: #2a2a2a; 
            font-weight: 600; 
            font-size: 14px; 
        }
        .table-row { 
            display: grid; 
            gap: 15px; 
            padding: 15px 20px; 
            border-bottom: 1px solid #2a2a2a; 
            align-items: center; 
        }
        .table-row:hover { background: #2a2a2a; }
        
        .status-badge { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 600; 
            text-align: center; 
        }
        .status-pending { background: #ff9800; color: #fff; }
        .status-approved { background: #4caf50; color: #fff; }
        .status-rejected { background: #f44336; color: #fff; }
        .status-win { background: #4caf50; color: #fff; }
        .status-loss { background: #f44336; color: #fff; }
        
        .action-btns { display: flex; gap: 8px; flex-wrap: wrap; }
        
        .search-box { 
            background: #1a1a1a; 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px; 
        }
        
        .no-data { 
            text-align: center; 
            padding: 40px; 
            color: #666; 
        }
        
        .toggle-switch { 
            position: relative; 
            display: inline-block; 
            width: 60px; 
            height: 30px; 
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { 
            position: absolute; 
            cursor: pointer; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: #f44336; 
            transition: .4s; 
            border-radius: 30px; 
        }
        .slider:before { 
            position: absolute; 
            content: ""; 
            height: 22px; 
            width: 22px; 
            left: 4px; 
            bottom: 4px; 
            background-color: white; 
            transition: .4s; 
            border-radius: 50%; 
        }
        input:checked + .slider { background-color: #4caf50; }
        input:checked + .slider:before { transform: translateX(30px); }
        
        .section { display: none; }
        .section.active { display: block; }
        
        .detail-box {
            background: #2a2a2a;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 5px 0;
            font-size: 13px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
        }
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title { font-size: 24px; font-weight: 600; }
        .close-btn {
            background: none;
            border: none;
            font-size: 32px;
            cursor: pointer;
            color: #888;
            line-height: 1;
        }
        
        .chat-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: 600px;
        }
        
        .chat-users {
            background: #1a1a1a;
            border-radius: 15px;
            padding: 15px;
            overflow-y: auto;
        }
        
        .chat-user-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #2a2a2a;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .chat-user-item.active {
            background: #4285f4;
        }
        
        .chat-messages {
            background: #1a1a1a;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #0f0f0f;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .chat-container {
                grid-template-columns: 1fr;
                height: auto;
            }
            .chat-users {
                max-height: 200px;
            }
            .table-row, .table-header {
                font-size: 12px;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h1 class="login-title">üîê Admin Panel</h1>
            <div style="background: #2a2a2a; padding: 10px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ff9800; font-size: 13px;">
                ‚ö†Ô∏è <strong>Restricted Access:</strong> Admin accounts only.
            </div>
            <div id="loginMessage"></div>
            <div class="input-group">
                <label>Admin Email</label>
                <input type="email" id="adminEmail" placeholder="Enter admin email">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="adminPassword" placeholder="Enter password">
            </div>
            <button class="btn btn-primary" onclick="adminLogin()">Login</button>
        </div>
    </div>

    <div class="admin-panel" id="adminPanel">
        <div class="header">
            <h1>‚ö° Admin Control Panel</h1>
            <button class="btn btn-small btn-danger" onclick="adminLogout()">Logout</button>
        </div>

        <div class="container">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalTrades">0</div>
                    <div class="stat-label">Total Trades</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pendingWithdrawals">0</div>
                    <div class="stat-label">Pending Withdrawals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalWithdrawnAmount">$0</div>
                    <div class="stat-label">Total Withdrawn</div>
                </div>
            </div>

            <div class="filters">
                <button class="filter-btn active" onclick="showSection('users')">Users</button>
                <button class="filter-btn" onclick="showSection('trades')">Trades</button>
                <button class="filter-btn" onclick="showSection('transactions')">Transactions</button>
                <button class="filter-btn" onclick="showSection('withdrawals')">Withdrawals</button>
                <button class="filter-btn" onclick="showSection('chat')">Support Chat</button>
            </div>

            <div id="adminMessage"></div>

            <!-- Users Section -->
            <div id="usersSection" class="section active">
                <h2 style="margin-bottom: 20px;">User Management</h2>
                <div class="search-box">
                    <input type="text" id="userSearchInput" placeholder="Search by User ID or Email..." oninput="searchUsers()">
                </div>
                <div class="data-table">
                    <div class="table-header" style="grid-template-columns: 80px 120px 180px 100px 150px 200px;">
                        <div>User ID</div>
                        <div>Name</div>
                        <div>Email</div>
                        <div>Balance</div>
                        <div>Win/Loss Mode</div>
                        <div>Actions</div>
                    </div>
                    <div id="usersContainer"></div>
                </div>
            </div>

            <!-- Trades Section -->
            <div id="tradesSection" class="section">
                <h2 style="margin-bottom: 20px;">Trade Management</h2>
                <div class="data-table">
                    <div class="table-header" style="grid-template-columns: 100px 120px 150px 100px 100px 100px 120px;">
                        <div>User ID</div>
                        <div>Name</div>
                        <div>Coin</div>
                        <div>Amount</div>
                        <div>Direction</div>
                        <div>Status</div>
                        <div>Time</div>
                    </div>
                    <div id="tradesContainer"></div>
                </div>
            </div>

            <!-- Transactions Section -->
            <div id="transactionsSection" class="section">
                <h2 style="margin-bottom: 20px;">All Transactions (Deposits, Withdrawals, Trades)</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="filter-btn active" id="allTransBtn" onclick="filterTransactions('all')">All</button>
                    <button class="filter-btn" id="depositTransBtn" onclick="filterTransactions('deposit')">Deposits</button>
                    <button class="filter-btn" id="withdrawalTransBtn" onclick="filterTransactions('withdrawal')">Withdrawals</button>
                    <button class="filter-btn" id="tradeTransBtn" onclick="filterTransactions('trade')">Trades</button>
                </div>
                <div class="data-table">
                    <div class="table-header" style="grid-template-columns: 100px 120px 100px 100px 120px 150px;">
                        <div>User ID</div>
                        <div>Name</div>
                        <div>Type</div>
                        <div>Amount</div>
                        <div>Status</div>
                        <div>Time</div>
                    </div>
                    <div id="transactionsContainer"></div>
                </div>
            </div>

            <!-- Withdrawals Section -->
            <div id="withdrawalsSection" class="section">
                <h2 style="margin-bottom: 20px;">Withdrawal Management</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="filter-btn active" id="pendingWithdrawBtn" onclick="filterWithdrawals('pending')">Pending</button>
                    <button class="filter-btn" id="approvedWithdrawBtn" onclick="filterWithdrawals('approved')">Approved</button>
                    <button class="filter-btn" id="rejectedWithdrawBtn" onclick="filterWithdrawals('rejected')">Rejected</button>
                </div>
                <div class="data-table">
                    <div class="table-header" style="grid-template-columns: 100px 120px 100px 150px 100px 120px 180px;">
                        <div>User ID</div>
                        <div>Name</div>
                        <div>Method</div>
                        <div>Details</div>
                        <div>Amount</div>
                        <div>Status</div>
                        <div>Actions</div>
                    </div>
                    <div id="withdrawalsContainer"></div>
                </div>
            </div>

            <!-- Chat Section -->
            <div id="chatSection" class="section">
                <h2 style="margin-bottom: 20px;">Support Chat</h2>
                <div class="chat-container">
                    <div class="chat-users">
                        <h3 style="margin-bottom: 15px;">Active Chats</h3>
                        <div id="chatUsersList">Loading...</div>
                    </div>
                    <div class="chat-messages">
                        <div id="selectedUserInfo" style="padding-bottom: 15px; border-bottom: 2px solid #2a2a2a; margin-bottom: 15px;">
                            Select a user to view chat
                        </div>
                        <div class="chat-messages-list" id="adminChatMessages"></div>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="adminChatInput" placeholder="Type your message..." style="flex: 1; padding: 12px; border: 2px solid #2a2a2a; border-radius: 12px; background: #0f0f0f; color: #fff;" onkeypress="if(event.key==='Enter') sendAdminMessage()">
                            <button class="btn btn-small btn-success" style="padding: 12px 24px;" onclick="sendAdminMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Crypto Modal -->
    <div class="modal" id="addCryptoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Crypto to User</h2>
                <button class="close-btn" onclick="closeAddCrypto()">&times;</button>
            </div>
            <div id="cryptoMessage"></div>
            <div class="input-group">
                <label>Select Cryptocurrency</label>
                <select id="cryptoType">
                    <option value="usdt">USDT</option>
                    <option value="btc">Bitcoin (BTC)</option>
                    <option value="eth">Ethereum (ETH)</option>
                    <option value="xrp">Ripple (XRP)</option>
                    <option value="doge">Dogecoin (DOGE)</option>
                    <option value="ada">Cardano (ADA)</option>
                    <option value="bnb">Binance Coin (BNB)</option>
                    <option value="sol">Solana (SOL)</option>
                    <option value="link">Chainlink (LINK)</option>
                    <option value="dot">Polkadot (DOT)</option>
                    <option value="ltc">Litecoin (LTC)</option>
                </select>
            </div>
            <div class="input-group">
                <label>Amount</label>
                <input type="number" id="cryptoAmount" placeholder="Enter amount" step="0.00000001">
            </div>
            <button class="btn btn-primary" onclick="addCryptoToUser()">Add Crypto</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDWQBTrvvxCL5Qd23iSMTQlWkaPKZgjhqw",
            authDomain: "trading-dapp-d5aa4.firebaseapp.com",
            projectId: "trading-dapp-d5aa4",
            storageBucket: "trading-dapp-d5aa4.firebasestorage.app",
            messagingSenderId: "690266747119",
            appId: "1:690266747119:web:0f22d45fbee53ee3c3eb1a"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let allTrades = [];
        let allUsers = [];
        let allWithdrawals = [];
        let allTransactions = [];
        let withdrawalFilter = 'pending';
        let transactionFilter = 'all';
        let selectedChatUserId = null;
        let chatUsersListener = null;
        let chatMessagesListener = null;
        let selectedUserId = null;

        const ADMIN_EMAIL = 'dawitamene1122@gmail.com';

        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            if (el) {
                el.innerHTML = `<div class="message ${type}">${message}</div>`;
                setTimeout(() => { el.innerHTML = ''; }, 4000);
            }
        }

        async function adminLogin() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;

            if (!email || !password) {
                showMessage('loginMessage', 'Please fill all fields', 'error');
                return;
            }
            
            if (email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
                showMessage('loginMessage', 'Access denied. Not an admin account.', 'error');
                return;
            }

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                if (userCredential.user.email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
                    await auth.signOut();
                    showMessage('loginMessage', 'Access denied. Admin privileges required.', 'error');
                    return;
                }
                
                showMessage('loginMessage', 'Admin login successful!', 'success');
            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    showMessage('loginMessage', 'Admin account not found.', 'error');
                } else if (error.code === 'auth/wrong-password') {
                    showMessage('loginMessage', 'Invalid password', 'error');
                } else {
                    showMessage('loginMessage', 'Login failed: ' + error.message, 'error');
                }
            }
        }

        function adminLogout() {
            auth.signOut();
        }

        async function loadDashboard() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminPanel').classList.add('active');
            
            await loadStats();
            await loadUsers();
            
            setInterval(loadStats, 30000);
        }

        function showLogin() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('adminPanel').classList.remove('active');
        }

        async function loadStats() {
            try {
                const tradesSnapshot = await db.collection('trades').get();
                const usersSnapshot = await db.collection('users').get();
                const withdrawalsSnapshot = await db.collection('withdrawals').get();
                
                let pendingWithdrawCount = 0;
                let totalWithdrawn = 0;

                withdrawalsSnapshot.forEach(doc => {
                    const withdrawal = doc.data();
                    if (withdrawal.status === 'pending') {
                        pendingWithdrawCount++;
                    } else if (withdrawal.status === 'approved') {
                        totalWithdrawn += withdrawal.amount || 0;
                    }
                });

                document.getElementById('totalTrades').textContent = tradesSnapshot.size;
                document.getElementById('totalUsers').textContent = usersSnapshot.size;
                document.getElementById('pendingWithdrawals').textContent = pendingWithdrawCount;
                document.getElementById('totalWithdrawnAmount').textContent = '$' + totalWithdrawn.toFixed(2);
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function showSection(section) {
            document.querySelectorAll('.filters .filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(section + 'Section').classList.add('active');

            if (section === 'users') loadUsers();
            else if (section === 'trades') loadTrades();
            else if (section === 'transactions') loadTransactions();
            else if (section === 'withdrawals') loadWithdrawals();
            else if (section === 'chat') loadChatUsers();
        }

        async function loadUsers() {
            try {
                const usersSnapshot = await db.collection('users').get();
                allUsers = [];
                usersSnapshot.forEach(doc => {
                    allUsers.push({ uid: doc.id, ...doc.data() });
                });
                renderUsers();
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function renderUsers() {
            let filteredUsers = allUsers;

            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            if (searchTerm) {
                filteredUsers = allUsers.filter(user => 
                    user.userId?.toString().includes(searchTerm) ||
                    user.email?.toLowerCase().includes(searchTerm) ||
                    user.name?.toLowerCase().includes(searchTerm)
                );
            }

            const html = filteredUsers.map(user => {
                const tradingMode = user.tradingMode || 'loss';
                const isWinMode = tradingMode === 'win';
                
                return `
                <div class="table-row" style="grid-template-columns: 80px 120px 180px 100px 150px 200px;">
                    <div>${user.userId || 'N/A'}</div>
                    <div>${user.name || 'N/A'}</div>
                    <div style="font-size: 12px;">${user.email || 'N/A'}</div>
                    <div style="font-weight: 600; color: #4caf50;">$${(user.balance || 0).toFixed(2)}</div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label class="toggle-switch">
                            <input type="checkbox" ${isWinMode ? 'checked' : ''} onchange="toggleTradingMode('${user.uid}', this.checked)">
                            <span class="slider"></span>
                        </label>
                        <span style="color: ${isWinMode ? '#4caf50' : '#f44336'}; font-weight: 600; min-width: 45px;" id="mode-${user.uid}">
                            ${isWinMode ? 'WIN' : 'LOSS'}
                        </span>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-small btn-success" onclick="openAddCrypto('${user.uid}')">+üí∞</button>
                        <button class="btn btn-small btn-danger" onclick="adjustBalance('${user.uid}', 'remove')">-$</button>
                    </div>
                </div>
            `;
            }).join('');

            document.getElementById('usersContainer').innerHTML = html || '<div class="no-data">No users found</div>';
        }

        function searchUsers() {
            renderUsers();
        }

        function openAddCrypto(userId) {
            selectedUserId = userId;
            document.getElementById('addCryptoModal').classList.add('active');
            document.getElementById('cryptoAmount').value = '';
            document.getElementById('cryptoType').value = 'usdt';
        }

        function closeAddCrypto() {
            document.getElementById('addCryptoModal').classList.remove('active');
            selectedUserId = null;
        }

        async function addCryptoToUser() {
            if (!selectedUserId) return;

            const cryptoType = document.getElementById('cryptoType').value;
            const amount = parseFloat(document.getElementById('cryptoAmount').value);

            if (!amount || amount <= 0) {
                showMessage('cryptoMessage', 'Please enter a valid amount', 'error');
                return;
            }

            try {
                const userDoc = await db.collection('users').doc(selectedUserId).get();
                if (!userDoc.exists) {
                    showMessage('cryptoMessage', 'User not found', 'error');
                    return;
                }

                const userData = userDoc.data();
                const currentBalance = userData.balance || 0;
                const currentCryptoBalances = userData.cryptoBalances || {};

                if (cryptoType === 'usdt') {
                    // Add to USDT balance
                    await db.collection('users').doc(selectedUserId).update({
                        balance: currentBalance + amount
                    });
                } else {
                    // Add to crypto balance
                    currentCryptoBalances[cryptoType] = (currentCryptoBalances[cryptoType] || 0) + amount;
                    await db.collection('users').doc(selectedUserId).update({
                        cryptoBalances: currentCryptoBalances
                    });
                }

                // Create deposit transaction
                await db.collection('transactions').add({
                    userId: selectedUserId,
                    userIdNumber: userData.userId,
                    type: 'deposit',
                    crypto: cryptoType,
                    amount: amount,
                    status: 'approved',
                    note: `Admin added ${amount} ${cryptoType.toUpperCase()} to account`,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showMessage('cryptoMessage', `Successfully added ${amount} ${cryptoType.toUpperCase()}!`, 'success');
                setTimeout(() => {
                    closeAddCrypto();
                    loadUsers();
                    loadStats();
                }, 2000);

            } catch (error) {
                showMessage('cryptoMessage', 'Error: ' + error.message, 'error');
            }
        }

        async function adjustBalance(userId, action) {
            const amount = prompt(`Enter USDT amount to ${action}:`);
            if (!amount || isNaN(amount)) {
                alert('Invalid amount');
                return;
            }

            const amountNum = parseFloat(amount);
            if (amountNum <= 0) {
                alert('Amount must be positive');
                return;
            }

            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) {
                    alert('User not found');
                    return;
                }

                const userData = userDoc.data();
                const currentBalance = userData.balance || 0;
                const newBalance = Math.max(0, currentBalance - amountNum);

                await db.collection('users').doc(userId).update({ balance: newBalance });
                
                showMessage('adminMessage', `Balance removed successfully!`, 'success');
                await loadUsers();
                await loadStats();
            } catch (error) {
                showMessage('adminMessage', 'Error: ' + error.message, 'error');
            }
        }

        async function toggleTradingMode(userId, isWinMode) {
            const mode = isWinMode ? 'win' : 'loss';
            
            try {
                await db.collection('users').doc(userId).update({ 
                    tradingMode: mode 
                });
                
                const label = document.getElementById(`mode-${userId}`);
                if (label) {
                    label.textContent = mode.toUpperCase();
                    label.style.color = isWinMode ? '#4caf50' : '#f44336';
                }
                
                showMessage('adminMessage', `Trading mode set to ${mode.toUpperCase()}`, 'success');
            } catch (error) {
                showMessage('adminMessage', 'Error: ' + error.message, 'error');
            }
        }

        async function loadTrades() {
            try {
                const tradesSnapshot = await db.collection('trades')
                    .limit(100)
                    .get();

                allTrades = [];
                tradesSnapshot.forEach(doc => {
                    allTrades.push({ id: doc.id, ...doc.data() });
                });

                allTrades.sort((a, b) => {
                    const timeA = a.createdAt?.toMillis() || 0;
                    const timeB = b.createdAt?.toMillis() || 0;
                    return timeB - timeA;
                });

                renderTrades();
            } catch (error) {
                console.error('Error loading trades:', error);
            }
        }

        function renderTrades() {
            const html = allTrades.map(trade => {
                const dateStr = trade.createdAt ? new Date(trade.createdAt.toMillis()).toLocaleString() : 'N/A';
                let statusBadge = '';
                
                if (trade.status === 'pending') {
                    statusBadge = `<span class="status-badge status-pending">PENDING</span>`;
                } else if (trade.status === 'win') {
                    statusBadge = `<span class="status-badge status-win">WIN</span>`;
                } else if (trade.status === 'loss') {
                    statusBadge = `<span class="status-badge status-loss">LOSS</span>`;
                }

                return `
                    <div class="table-row" style="grid-template-columns: 100px 120px 150px 100px 100px 100px 120px;">
                        <div>${trade.userIdNumber || 'N/A'}</div>
                        <div>${trade.userName || 'N/A'}</div>
                        <div><strong>${trade.coin}</strong></div>
                        <div>$${trade.amount.toFixed(2)}</div>
                        <div style="color: ${trade.direction === 'up' ? '#4caf50' : '#f44336'}; font-weight: 600;">${trade.direction.toUpperCase()}</div>
                        <div>${statusBadge}</div>
                        <div style="font-size: 12px; color: #888;">${dateStr}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('tradesContainer').innerHTML = html || '<div class="no-data">No trades found</div>';
        }

        async function loadTransactions() {
            try {
                const transSnapshot = await db.collection('transactions')
                    .limit(200)
                    .get();

                allTransactions = [];
                transSnapshot.forEach(doc => {
                    allTransactions.push({ id: doc.id, ...doc.data() });
                });

                allTransactions.sort((a, b) => {
                    const timeA = a.createdAt?.toMillis() || 0;
                    const timeB = b.createdAt?.toMillis() || 0;
                    return timeB - timeA;
                });

                renderTransactions();
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        function filterTransactions(type) {
            transactionFilter = type;
            document.querySelectorAll('#transactionsSection .filter-btn').forEach(btn => btn.classList.remove('active'));
            
            if (type === 'all') document.getElementById('allTransBtn').classList.add('active');
            else if (type === 'deposit') document.getElementById('depositTransBtn').classList.add('active');
            else if (type === 'withdrawal') document.getElementById('withdrawalTransBtn').classList.add('active');
            else if (type === 'trade') document.getElementById('tradeTransBtn').classList.add('active');
            
            renderTransactions();
        }

        function renderTransactions() {
            let filtered = allTransactions;
            if (transactionFilter !== 'all') {
                filtered = allTransactions.filter(t => t.type === transactionFilter);
            }

            const html = filtered.map(trans => {
                const dateStr = trans.createdAt ? new Date(trans.createdAt.toMillis()).toLocaleString() : 'N/A';
                
                let statusBadge = '';
                if (trans.status === 'pending') {
                    statusBadge = `<span class="status-badge status-pending">PENDING</span>`;
                } else if (trans.status === 'approved') {
                    statusBadge = `<span class="status-badge status-approved">APPROVED</span>`;
                } else if (trans.status === 'rejected') {
                    statusBadge = `<span class="status-badge status-rejected">REJECTED</span>`;
                }

                const cryptoLabel = trans.crypto ? ` (${trans.crypto.toUpperCase()})` : '';

                return `
                    <div class="table-row" style="grid-template-columns: 100px 120px 100px 100px 120px 150px;">
                        <div>${trans.userIdNumber || 'N/A'}</div>
                        <div>${trans.userName || 'User'}</div>
                        <div>${trans.type?.toUpperCase()}${cryptoLabel}</div>
                        <div>$${trans.amount.toFixed(2)}</div>
                        <div>${statusBadge}</div>
                        <div style="font-size: 12px; color: #888;">${dateStr}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('transactionsContainer').innerHTML = html || '<div class="no-data">No transactions found</div>';
        }

        async function loadWithdrawals() {
            try {
                const withdrawalsSnapshot = await db.collection('withdrawals').get();
                allWithdrawals = [];
                withdrawalsSnapshot.forEach(doc => {
                    allWithdrawals.push({ id: doc.id, ...doc.data() });
                });

                allWithdrawals.sort((a, b) => {
                    const timeA = a.createdAt?.toMillis() || 0;
                    const timeB = b.createdAt?.toMillis() || 0;
                    return timeB - timeA;
                });

                renderWithdrawals();
            } catch (error) {
                console.error('Error loading withdrawals:', error);
            }
        }

        function filterWithdrawals(status) {
            withdrawalFilter = status;
            document.querySelectorAll('#withdrawalsSection .filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(status + 'WithdrawBtn').classList.add('active');
            renderWithdrawals();
        }

        function renderWithdrawals() {
            const filtered = allWithdrawals.filter(w => w.status === withdrawalFilter);

            const html = filtered.map(withdrawal => {
                const dateStr = withdrawal.createdAt ? new Date(withdrawal.createdAt.toMillis()).toLocaleString() : 'N/A';
                
                let detailsHtml = '';
                if (withdrawal.method === 'crypto') {
                    detailsHtml = `
                        <div class="detail-box">
                            <div><strong>${withdrawal.crypto?.toUpperCase()}</strong></div>
                            <div style="font-size: 11px; word-break: break-all;">${withdrawal.address}</div>
                        </div>
                    `;
                } else {
                    detailsHtml = `
                        <div class="detail-box">
                            <div><strong>${withdrawal.bankName}</strong></div>
                            <div style="font-size: 11px;">${withdrawal.accountNumber}</div>
                            <div style="font-size: 11px;">${withdrawal.accountName}</div>
                        </div>
                    `;
                }

                let statusBadge = '';
                if (withdrawal.status === 'pending') {
                    statusBadge = `<span class="status-badge status-pending">PENDING</span>`;
                } else if (withdrawal.status === 'approved') {
                    statusBadge = `<span class="status-badge status-approved">APPROVED</span>`;
                } else if (withdrawal.status === 'rejected') {
                    statusBadge = `<span class="status-badge status-rejected">REJECTED</span>`;
                }

                let actionsHtml = '';
                if (withdrawal.status === 'pending') {
                    actionsHtml = `
                        <div class="action-btns">
                            <button class="btn btn-small btn-success" onclick="approveWithdrawal('${withdrawal.id}', ${withdrawal.amount}, '${withdrawal.userId}', '${withdrawal.crypto || 'usdt'}')">Approve</button>
                            <button class="btn btn-small btn-danger" onclick="rejectWithdrawal('${withdrawal.id}')">Reject</button>
                        </div>
                    `;
                } else {
                    actionsHtml = `<div style="font-size: 12px; color: #888;">${dateStr}</div>`;
                }

                return `
                    <div class="table-row" style="grid-template-columns: 100px 120px 100px 150px 100px 120px 180px;">
                        <div>${withdrawal.userIdNumber || 'N/A'}</div>
                        <div>${withdrawal.userName || 'N/A'}</div>
                        <div>${withdrawal.method?.toUpperCase() || 'N/A'}</div>
                        <div>${detailsHtml}</div>
                        <div style="font-weight: 600;">$${withdrawal.amount.toFixed(2)}</div>
                        <div>${statusBadge}</div>
                        <div>${actionsHtml}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('withdrawalsContainer').innerHTML = html || '<div class="no-data">No withdrawals found</div>';
        }

        async function approveWithdrawal(withdrawalId, amount, userId, crypto) {
            if (!confirm(`Approve withdrawal of ${amount} ${crypto.toUpperCase()}?`)) return;

            try {
                await db.collection('withdrawals').doc(withdrawalId).update({
                    status: 'approved',
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    if (crypto === 'usdt') {
                        const currentBalance = userDoc.data().balance || 0;
                        const newBalance = Math.max(0, currentBalance - amount);
                        await db.collection('users').doc(userId).update({ balance: newBalance });
                    } else {
                        const currentCryptoBalances = userDoc.data().cryptoBalances || {};
                        currentCryptoBalances[crypto] = Math.max(0, (currentCryptoBalances[crypto] || 0) - amount);
                        await db.collection('users').doc(userId).update({ cryptoBalances: currentCryptoBalances });
                    }
                }

                const transSnapshot = await db.collection('transactions')
                    .where('userId', '==', userId)
                    .where('type', '==', 'withdrawal')
                    .where('amount', '==', amount)
                    .where('status', '==', 'pending')
                    .limit(1)
                    .get();

                if (!transSnapshot.empty) {
                    await db.collection('transactions').doc(transSnapshot.docs[0].id).update({
                        status: 'approved'
                    });
                }

                showMessage('adminMessage', 'Withdrawal approved successfully!', 'success');
                await loadWithdrawals();
                await loadStats();
                await loadTransactions();
            } catch (error) {
                showMessage('adminMessage', 'Error: ' + error.message, 'error');
            }
        }

        async function rejectWithdrawal(withdrawalId) {
            if (!confirm('Reject this withdrawal?')) return;

            try {
                await db.collection('withdrawals').doc(withdrawalId).update({
                    status: 'rejected',
                    rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                const withdrawal = allWithdrawals.find(w => w.id === withdrawalId);
                if (withdrawal) {
                    const transSnapshot = await db.collection('transactions')
                        .where('userId', '==', withdrawal.userId)
                        .where('type', '==', 'withdrawal')
                        .where('amount', '==', withdrawal.amount)
                        .where('status', '==', 'pending')
                        .limit(1)
                        .get();

                    if (!transSnapshot.empty) {
                        await db.collection('transactions').doc(transSnapshot.docs[0].id).update({
                            status: 'rejected'
                        });
                    }
                }

                showMessage('adminMessage', 'Withdrawal rejected!', 'success');
                await loadWithdrawals();
                await loadStats();
                await loadTransactions();
            } catch (error) {
                showMessage('adminMessage', 'Error: ' + error.message, 'error');
            }
        }

        function loadChatUsers() {
            if (chatUsersListener) chatUsersListener();
            
            chatUsersListener = db.collection('chats')
                .onSnapshot(snapshot => {
                    const userChats = {};
                    
                    snapshot.forEach(doc => {
                        const chat = doc.data();
                        if (!userChats[chat.userId]) {
                            userChats[chat.userId] = {
                                userId: chat.userId,
                                userIdNumber: chat.userIdNumber,
                                userName: chat.userName,
                                userEmail: chat.userEmail,
                                lastMessage: chat.message,
                                timestamp: chat.timestamp,
                                unread: !chat.read && chat.senderType === 'user'
                            };
                        }
                    });

                    const chatUsersList = document.getElementById('chatUsersList');
                    const users = Object.values(userChats);
                    
                    if (users.length === 0) {
                        chatUsersList.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No chats yet</div>';
                        return;
                    }

                    chatUsersList.innerHTML = users.map(user => `
                        <div class="chat-user-item ${selectedChatUserId === user.userId ? 'active' : ''}" onclick="selectChatUser('${user.userId}')">
                            <div style="font-weight: 600; margin-bottom: 5px;">${user.userName}</div>
                            <div style="font-size: 11px; color: #aaa;">ID: ${user.userIdNumber}</div>
                            ${user.unread ? '<div style="font-size: 10px; color: #4caf50; margin-top: 5px;">‚óè New message</div>' : ''}
                        </div>
                    `).join('');
                });
        }

        function selectChatUser(userId) {
            selectedChatUserId = userId;
            loadChatMessages(userId);
            loadChatUsers();
        }

        function loadChatMessages(userId) {
            if (chatMessagesListener) chatMessagesListener();

            db.collection('chats')
                .where('userId', '==', userId)
                .limit(1)
                .get()
                .then(snapshot => {
                    if (!snapshot.empty) {
                        const userData = snapshot.docs[0].data();
                        document.getElementById('selectedUserInfo').innerHTML = `
                            <div style="font-weight: 600; font-size: 16px;">${userData.userName}</div>
                            <div style="font-size: 12px; color: #aaa;">ID: ${userData.userIdNumber} | ${userData.userEmail}</div>
                        `;
                    }
                });
            
            chatMessagesListener = db.collection('chats')
                .where('userId', '==', userId)
                .onSnapshot(snapshot => {
                    const adminChatMessages = document.getElementById('adminChatMessages');
                    
                    if (snapshot.empty) {
                        adminChatMessages.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No messages yet</div>';
                        return;
                    }

                    const messages = [];
                    snapshot.forEach(doc => {
                        messages.push({ id: doc.id, ...doc.data() });
                    });

                    messages.sort((a, b) => {
                        const timeA = a.timestamp?.toMillis() || 0;
                        const timeB = b.timestamp?.toMillis() || 0;
                        return timeA - timeB;
                    });

                    let html = '';
                    messages.forEach(msg => {
                        const isUser = msg.senderType === 'user';
                        const time = msg.timestamp ? new Date(msg.timestamp.toMillis()).toLocaleTimeString() : '';
                        
                        html += `
                            <div style="margin-bottom: 15px; text-align: ${isUser ? 'left' : 'right'};">
                                <div style="display: inline-block; max-width: 70%; padding: 10px 15px; border-radius: 12px; background: ${isUser ? '#2a2a2a' : '#4285f4'}; color: #fff; text-align: left;">
                                    <div style="font-weight: 600; font-size: 12px; margin-bottom: 5px; opacity: 0.8;">${isUser ? msg.userName : 'Admin'}</div>
                                    <div>${msg.message}</div>
                                    <div style="font-size: 10px; margin-top: 5px; opacity: 0.7;">${time}</div>
                                </div>
                            </div>
                        `;

                        if (isUser && !msg.read) {
                            db.collection('chats').doc(msg.id).update({ read: true });
                        }
                    });

                    adminChatMessages.innerHTML = html;
                    adminChatMessages.scrollTop = adminChatMessages.scrollHeight;
                });
        }

        async function sendAdminMessage() {
            if (!selectedChatUserId) {
                alert('Please select a user first');
                return;
            }

            const input = document.getElementById('adminChatInput');
            const message = input.value.trim();

            if (!message) return;

            try {
                const userChats = await db.collection('chats')
                    .where('userId', '==', selectedChatUserId)
                    .limit(1)
                    .get();

                let userData = { userName: 'User', userIdNumber: 'N/A', userEmail: 'N/A' };
                if (!userChats.empty) {
                    userData = userChats.docs[0].data();
                }

                await db.collection('chats').add({
                    userId: selectedChatUserId,
                    userIdNumber: userData.userIdNumber,
                    userName: userData.userName,
                    userEmail: userData.userEmail,
                    message: message,
                    senderType: 'admin',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false
                });

                input.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message');
            }
        }

        auth.onAuthStateChanged((user) => {
            if (user) {
                if (user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                    loadDashboard();
                } else {
                    auth.signOut();
                    showLogin();
                    showMessage('loginMessage', 'Access denied. Admin account required.', 'error');
                }
            } else {
                showLogin();
            }
        });
    </script>
</body>
</html>
