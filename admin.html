<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Hibt Trading</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #1a1a1a; color: #fff; }
        
        .login-container { min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .login-box { background: #2a2a2a; border-radius: 20px; padding: 40px; width: 90%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .login-title { font-size: 28px; font-weight: bold; margin-bottom: 30px; text-align: center; color: #4285f4; }
        
        .admin-panel { display: none; min-height: 100vh; }
        .admin-panel.active { display: block; }
        
        .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 24px; }
        
        .container { padding: 20px; max-width: 1400px; margin: 0 auto; }
        
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #aaa; font-weight: 500; }
        input { width: 100%; padding: 15px; border: 2px solid #444; border-radius: 12px; font-size: 16px; background: #333; color: #fff; }
        input:focus { outline: none; border-color: #4285f4; }
        
        .btn { padding: 15px 30px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #4285f4; color: white; width: 100%; }
        .btn-primary:hover { background: #3367d6; }
        .btn-small { padding: 8px 16px; font-size: 14px; }
        .btn-success { background: #4caf50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        
        .message { padding: 15px; border-radius: 12px; margin-bottom: 20px; font-weight: 500; }
        .error { background: #fee; color: #c33; border: 1px solid #fcc; }
        .success { background: #efe; color: #363; border: 1px solid #cfc; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #2a2a2a; padding: 20px; border-radius: 15px; text-align: center; }
        .stat-value { font-size: 32px; font-weight: bold; color: #4285f4; margin-bottom: 5px; }
        .stat-label { color: #888; font-size: 14px; }
        
        .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn { padding: 12px 24px; background: #2a2a2a; border: 2px solid #444; border-radius: 12px; cursor: pointer; font-weight: 600; color: #fff; }
        .filter-btn.active { background: #4285f4; border-color: #4285f4; }
        
        .trades-table { background: #2a2a2a; border-radius: 15px; overflow: hidden; }
        .table-header { display: grid; grid-template-columns: 100px 120px 150px 100px 100px 100px 120px 180px; gap: 15px; padding: 15px 20px; background: #333; font-weight: 600; font-size: 14px; }
        .table-row { display: grid; grid-template-columns: 100px 120px 150px 100px 100px 100px 120px 180px; gap: 15px; padding: 15px 20px; border-bottom: 1px solid #333; align-items: center; }
        .table-row:hover { background: #333; }
        
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-align: center; }
        .status-pending { background: #ff9800; color: #fff; }
        .status-win { background: #4caf50; color: #fff; }
        .status-loss { background: #f44336; color: #fff; }
        
        .action-btns { display: flex; gap: 8px; }
        
        .search-box { background: #2a2a2a; padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .search-input { background: #333; border: 2px solid #444; }
        
        .no-data { text-align: center; padding: 40px; color: #666; }
        
        .countdown { color: #ff9800; font-weight: 600; }
        
        .user-row { padding: 15px; background: #2a2a2a; border-radius: 8px; margin-bottom: 10px; }
        .user-row:hover { background: #333; }
        
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 30px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #f44336; transition: .4s; border-radius: 30px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4caf50; }
        input:checked + .slider:before { transform: translateX(30px); }
        .mode-label { font-size: 12px; font-weight: 600; margin-left: 8px; }
        .mode-label.win { color: #4caf50; }
        .mode-label.loss { color: #f44336; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h1 class="login-title">üîê Admin Panel</h1>
            <div style="background: #fff3cd; padding: 10px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107; font-size: 13px;">
                ‚ö†Ô∏è <strong>Restricted Access:</strong> Admin accounts only. Unauthorized access is prohibited.
            </div>
            <div id="loginMessage"></div>
            <div class="input-group">
                <label>Admin Email</label>
                <input type="email" id="adminEmail" placeholder="Enter admin email">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="adminPassword" placeholder="Enter password">
            </div>
            <button class="btn btn-primary" onclick="adminLogin()">Login</button>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="header">
            <h1>‚ö° Admin Control Panel</h1>
            <button class="btn btn-small btn-danger" onclick="adminLogout()">Logout</button>
        </div>

        <div class="container">
            <!-- Stats -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalTrades">0</div>
                    <div class="stat-label">Total Trades</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pendingTrades">0</div>
                    <div class="stat-label">Pending Trades</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeTrades">0</div>
                    <div class="stat-label">Active Now</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <button class="filter-btn active" onclick="filterTrades('all')">All Trades</button>
                <button class="filter-btn" onclick="filterTrades('pending')">Pending</button>
                <button class="filter-btn" onclick="filterTrades('win')">Winners</button>
                <button class="filter-btn" onclick="filterTrades('loss')">Losers</button>
                <button class="filter-btn" onclick="showUserManagement()" style="background: #4285f4; color: white;">Manage Users</button>
            </div>

            <!-- Search -->
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="Search by User ID, Email, or Trade ID..." oninput="searchTrades()">
            </div>

            <div id="adminMessage"></div>

            <!-- User Management Section -->
            <div id="userManagementSection" style="display: none;">
                <h2 style="margin-bottom: 20px; color: #fff;">User Management</h2>
                <div class="search-box">
                    <input type="text" class="search-input" id="userSearchInput" placeholder="Search by User ID or Email..." oninput="searchUsers()">
                </div>
                <div class="trades-table">
                    <div class="table-header" style="grid-template-columns: 100px 150px 200px 120px 120px 180px;">
                        <div>User ID</div>
                        <div>Name</div>
                        <div>Email</div>
                        <div>Balance</div>
                        <div>Win/Loss Mode</div>
                        <div>Actions</div>
                    </div>
                    <div id="usersContainer"></div>
                </div>
                <button class="btn btn-small btn-warning" onclick="showTradesSection()" style="margin-top: 20px;">Back to Trades</button>
            </div>

            <!-- Trades Section -->
            <div id="tradesSection">
                <h2 style="margin-bottom: 20px; color: #fff;">Trade Management</h2>

            <!-- Trades Table -->
            <div class="trades-table">
                <div class="table-header">
                    <div>User ID</div>
                    <div>User Name</div>
                    <div>Email</div>
                    <div>Coin</div>
                    <div>Amount</div>
                    <div>Direction</div>
                    <div>Status</div>
                    <div>Actions</div>
                </div>
                <div id="tradesContainer"></div>
            </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config (Same as your main app)
        const firebaseConfig = {
            apiKey: "AIzaSyDWQBTrvvxCL5Qd23iSMTQlWkaPKZgjhqw",
            authDomain: "trading-dapp-d5aa4.firebaseapp.com",
            projectId: "trading-dapp-d5aa4",
            storageBucket: "trading-dapp-d5aa4.firebasestorage.app",
            messagingSenderId: "690266747119",
            appId: "1:690266747119:web:0f22d45fbee53ee3c3eb1a"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentFilter = 'all';
        let allTrades = [];
        let allUsers = [];
        let countdownIntervals = {};

        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            if (el) {
                el.innerHTML = `<div class="message ${type}">${message}</div>`;
                setTimeout(() => { el.innerHTML = ''; }, 4000);
            }
        }

        async function adminLogin() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;

            if (!email || !password) {
                showMessage('loginMessage', 'Please fill all fields', 'error');
                return;
            }

            // SECURE: Only allow specific admin email
            const ADMIN_EMAIL = 'dawitamene1122@gmail.com'; // Change this to YOUR admin email
            
            if (email !== ADMIN_EMAIL) {
                showMessage('loginMessage', 'Access denied. Not an admin account.', 'error');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                
                // Double check after login
                if (auth.currentUser.email !== ADMIN_EMAIL) {
                    await auth.signOut();
                    showMessage('loginMessage', 'Access denied. Admin privileges required.', 'error');
                    return;
                }
                
                showMessage('loginMessage', 'Login successful!', 'success');
            } catch (error) {
                showMessage('loginMessage', 'Invalid credentials: ' + error.message, 'error');
            }
        }

        function adminLogout() {
            auth.signOut();
        }

        async function loadDashboard() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminPanel').classList.add('active');
            
            await loadStats();
            await loadTrades();
            
            // Auto-refresh every 10 seconds
            setInterval(loadTrades, 10000);
        }

        function showLogin() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('adminPanel').classList.remove('active');
        }

        async function loadStats() {
            try {
                const tradesSnapshot = await db.collection('trades').get();
                const usersSnapshot = await db.collection('users').get();
                
                let pendingCount = 0;
                let activeCount = 0;
                const now = Date.now();

                tradesSnapshot.forEach(doc => {
                    const trade = doc.data();
                    if (trade.status === 'pending') {
                        pendingCount++;
                        const tradeTime = trade.createdAt?.toMillis() || 0;
                        const endTime = tradeTime + (trade.timeFrame * 1000);
                        if (now < endTime) activeCount++;
                    }
                });

                document.getElementById('totalTrades').textContent = tradesSnapshot.size;
                document.getElementById('pendingTrades').textContent = pendingCount;
                document.getElementById('totalUsers').textContent = usersSnapshot.size;
                document.getElementById('activeTrades').textContent = activeCount;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadTrades() {
            try {
                const tradesSnapshot = await db.collection('trades')
                    .orderBy('createdAt', 'desc')
                    .limit(100)
                    .get();

                allTrades = [];
                tradesSnapshot.forEach(doc => {
                    allTrades.push({ id: doc.id, ...doc.data() });
                });

                renderTrades();
            } catch (error) {
                console.error('Error loading trades:', error);
                document.getElementById('tradesContainer').innerHTML = '<div class="no-data">Error loading trades</div>';
            }
        }

        function renderTrades() {
            Object.values(countdownIntervals).forEach(clearInterval);
            countdownIntervals = {};

            let filteredTrades = allTrades;

            // Apply filter
            if (currentFilter !== 'all') {
                filteredTrades = allTrades.filter(trade => trade.status === currentFilter);
            }

            // Apply search
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filteredTrades = filteredTrades.filter(trade => 
                    trade.userIdNumber?.toString().includes(searchTerm) ||
                    trade.userEmail?.toLowerCase().includes(searchTerm) ||
                    trade.userName?.toLowerCase().includes(searchTerm) ||
                    trade.id.includes(searchTerm)
                );
            }

            if (filteredTrades.length === 0) {
                document.getElementById('tradesContainer').innerHTML = '<div class="no-data">No trades found</div>';
                return;
            }

            const now = Date.now();
            const html = filteredTrades.map(trade => {
                const tradeTime = trade.createdAt?.toMillis() || 0;
                const endTime = tradeTime + (trade.timeFrame * 1000);
                const remainingMs = endTime - now;
                const remainingSec = Math.max(0, Math.floor(remainingMs / 1000));
                
                let statusBadge = '';
                if (trade.status === 'pending') {
                    statusBadge = `<span class="status-badge status-pending">PENDING</span>`;
                } else if (trade.status === 'win') {
                    statusBadge = `<span class="status-badge status-win">WIN</span>`;
                } else if (trade.status === 'loss') {
                    statusBadge = `<span class="status-badge status-loss">LOSS</span>`;
                }

                let actions = '';
                if (trade.status === 'pending' && remainingSec > 0) {
                    actions = `
                        <div class="countdown" id="countdown-${trade.id}">${remainingSec}s</div>
                        <div style="font-size: 11px; color: #888; margin-top: 5px;">Auto-processing based on user mode</div>
                    `;
                    
                    // Start countdown
                    startCountdown(trade.id, endTime);
                } else if (trade.status === 'pending') {
                    actions = `<span style="color: #ff9800;">Processing...</span>`;
                } else {
                    actions = `<span style="color: #666;">Finished</span>`;
                }

                return `
                    <div class="table-row">
                        <div>${trade.userIdNumber || 'N/A'}</div>
                        <div>${trade.userName || 'N/A'}</div>
                        <div style="font-size: 12px;">${trade.userEmail || 'N/A'}</div>
                        <div><strong>${trade.coin}</strong></div>
                        <div>${trade.amount.toFixed(2)}</div>
                        <div style="color: ${trade.direction === 'up' ? '#4caf50' : '#f44336'}; font-weight: 600;">${trade.direction.toUpperCase()}</div>
                        <div>${statusBadge}</div>
                        <div>${actions}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('tradesContainer').innerHTML = html;
        }

        function startCountdown(tradeId, endTime) {
            countdownIntervals[tradeId] = setInterval(() => {
                const now = Date.now();
                const remainingMs = endTime - now;
                const remainingSec = Math.max(0, Math.floor(remainingMs / 1000));

                const countdownEl = document.getElementById(`countdown-${tradeId}`);
                if (countdownEl) {
                    countdownEl.textContent = `${remainingSec}s`;
                    
                    if (remainingSec <= 0) {
                        clearInterval(countdownIntervals[tradeId]);
                        delete countdownIntervals[tradeId];
                        loadTrades();
                    }
                }
            }, 1000);
        }

        function filterTrades(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderTrades();
        }

        function searchTrades() {
            renderTrades();
        }

        // User Management Functions
        function showUserManagement() {
            document.getElementById('tradesSection').style.display = 'none';
            document.getElementById('userManagementSection').style.display = 'block';
            loadUsers();
        }

        function showTradesSection() {
            document.getElementById('tradesSection').style.display = 'block';
            document.getElementById('userManagementSection').style.display = 'none';
        }

        async function loadUsers() {
            try {
                const usersSnapshot = await db.collection('users').get();
                allUsers = [];
                usersSnapshot.forEach(doc => {
                    allUsers.push({ uid: doc.id, ...doc.data() });
                });
                renderUsers();
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function renderUsers() {
            let filteredUsers = allUsers;

            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            if (searchTerm) {
                filteredUsers = allUsers.filter(user => 
                    user.userId?.toString().includes(searchTerm) ||
                    user.email?.toLowerCase().includes(searchTerm) ||
                    user.name?.toLowerCase().includes(searchTerm)
                );
            }

            const html = filteredUsers.map(user => `
                <div class="table-row" style="grid-template-columns: 100px 150px 200px 150px 200px;">
                    <div>${user.userId || 'N/A'}</div>
                    <div>${user.name || 'N/A'}</div>
                    <div style="font-size: 12px;">${user.email || 'N/A'}</div>
                    <div style="font-weight: 600;">${(user.balance || 0).toFixed(2)}</div>
                    <div>
                        <button class="btn btn-small btn-success" onclick="adjustBalance('${user.uid}', 'add')">Add $</button>
                        <button class="btn btn-small btn-danger" onclick="adjustBalance('${user.uid}', 'remove')">Remove $</button>
                    </div>
                </div>
            `).join('');

            document.getElementById('usersContainer').innerHTML = html || '<div class="no-data">No users found</div>';
        }

        function searchUsers() {
            renderUsers();
        }

        async function adjustBalance(userId, action) {
            const amount = prompt(`Enter amount to ${action}:`);
            if (!amount || isNaN(amount)) {
                alert('Invalid amount');
                return;
            }

            const amountNum = parseFloat(amount);
            if (amountNum <= 0) {
                alert('Amount must be positive');
                return;
            }

            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) {
                    alert('User not found');
                    return;
                }

                const currentBalance = userDoc.data().balance || 0;
                let newBalance;

                if (action === 'add') {
                    newBalance = currentBalance + amountNum;
                } else {
                    newBalance = Math.max(0, currentBalance - amountNum);
                }

                await db.collection('users').doc(userId).update({ balance: newBalance });
                
                showMessage('adminMessage', `Balance ${action === 'add' ? 'added' : 'removed'} successfully!`, 'success');
                await loadUsers();
                await loadStats();
            } catch (error) {
                showMessage('adminMessage', 'Error: ' + error.message, 'error');
            }
        }

        async function toggleTradingMode(userId, isWinMode) {
            const mode = isWinMode ? 'win' : 'loss';
            
            try {
                await db.collection('users').doc(userId).update({ 
                    tradingMode: mode 
                });
                
                // Update the label
                const label = document.getElementById(`mode-${userId}`);
                if (label) {
                    label.textContent = mode.toUpperCase();
                    label.className = `mode-label ${mode}`;
                }
                
                showMessage('adminMessage', `User trading mode set to ${mode.toUpperCase()}`, 'success');
                
                // Update local data
                const userIndex = allUsers.findIndex(u => u.uid === userId);
                if (userIndex !== -1) {
                    allUsers[userIndex].tradingMode = mode;
                }
            } catch (error) {
                showMessage('adminMessage', 'Error: ' + error.message, 'error');
            }
        }

        // Auth state listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                loadDashboard();
            } else {
                showLogin();
            }
        });
    </script>
</body>
</html>
