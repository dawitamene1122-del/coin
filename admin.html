<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Hibt Trading</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #1a1a1a; color: #fff; }
        
        .login-container { min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .login-box { background: #2a2a2a; border-radius: 20px; padding: 40px; width: 90%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .login-title { font-size: 28px; font-weight: bold; margin-bottom: 30px; text-align: center; color: #4285f4; }
        
        .admin-panel { display: none; min-height: 100vh; }
        .admin-panel.active { display: block; }
        
        .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 24px; }
        
        .container { padding: 20px; max-width: 1400px; margin: 0 auto; }
        
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #aaa; font-weight: 500; }
        input, select { width: 100%; padding: 15px; border: 2px solid #444; border-radius: 12px; font-size: 16px; background: #333; color: #fff; }
        input:focus, select:focus { outline: none; border-color: #4285f4; }
        
        .btn { padding: 15px 30px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #4285f4; color: white; width: 100%; }
        .btn-primary:hover { background: #3367d6; }
        .btn-small { padding: 8px 16px; font-size: 14px; }
        .btn-success { background: #4caf50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-info { background: #2196f3; color: white; }
        
        .message { padding: 15px; border-radius: 12px; margin-bottom: 20px; font-weight: 500; }
        .error { background: #fee; color: #c33; border: 1px solid #fcc; }
        .success { background: #efe; color: #363; border: 1px solid #cfc; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #2a2a2a; padding: 20px; border-radius: 15px; text-align: center; }
        .stat-value { font-size: 32px; font-weight: bold; color: #4285f4; margin-bottom: 5px; }
        .stat-label { color: #888; font-size: 14px; }
        
        .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn { padding: 12px 24px; background: #2a2a2a; border: 2px solid #444; border-radius: 12px; cursor: pointer; font-weight: 600; color: #fff; }
        .filter-btn.active { background: #4285f4; border-color: #4285f4; }
        
        .trades-table { background: #2a2a2a; border-radius: 15px; overflow: hidden; }
        .table-header { display: grid; gap: 15px; padding: 15px 20px; background: #333; font-weight: 600; font-size: 14px; }
        .table-row { display: grid; gap: 15px; padding: 15px 20px; border-bottom: 1px solid #333; align-items: center; }
        .table-row:hover { background: #333; }
        
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-align: center; display: inline-block; }
        .status-pending { background: #ff9800; color: #fff; }
        .status-win { background: #4caf50; color: #fff; }
        .status-loss { background: #f44336; color: #fff; }
        .status-approved { background: #4caf50; color: #fff; }
        .status-rejected { background: #f44336; color: #fff; }
        
        .action-btns { display: flex; gap: 8px; flex-wrap: wrap; }
        
        .search-box { background: #2a2a2a; padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .search-input { background: #333; border: 2px solid #444; }
        
        .no-data { text-align: center; padding: 40px; color: #666; }
        
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 30px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #f44336; transition: .4s; border-radius: 30px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4caf50; }
        input:checked + .slider:before { transform: translateX(30px); }
        .mode-label { font-size: 12px; font-weight: 600; margin-left: 8px; }
        .mode-label.win { color: #4caf50; }
        .mode-label.loss { color: #f44336; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto; }
        .modal.active { display: flex; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: #2a2a2a; border-radius: 20px; padding: 30px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 24px; font-weight: 600; }
        .close-btn { background: none; border: none; font-size: 32px; cursor: pointer; color: #888; line-height: 1; }
    </style>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h1 class="login-title">üîê Admin Panel</h1>
            <div style="background: #fff3cd; padding: 10px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107; font-size: 13px; color: #333;">
                ‚ö†Ô∏è <strong>Restricted Access:</strong> Admin accounts only.
            </div>
            <div id="loginMessage"></div>
            <div class="input-group">
                <label>Admin Email</label>
                <input type="email" id="adminEmail" placeholder="Enter admin email">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="adminPassword" placeholder="Enter password">
            </div>
            <button class="btn btn-primary" onclick="adminLogin()">Login</button>
        </div>
    </div>

    <div class="admin-panel" id="adminPanel">
        <div class="header">
            <h1>‚ö° Admin Control Panel</h1>
            <button class="btn btn-small btn-danger" onclick="adminLogout()">Logout</button>
        </div>

        <div class="container">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalTrades">0</div>
                    <div class="stat-label">Total Trades</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pendingTrades">0</div>
                    <div class="stat-label">Pending Trades</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pendingWithdrawals">0</div>
                    <div class="stat-label">Pending Withdrawals</div>
                </div>
            </div>

            <div class="filters">
                <button class="filter-btn active" onclick="showTradesSection()">Trades</button>
                <button class="filter-btn" onclick="showUserManagement()">Users</button>
                <button class="filter-btn" onclick="showWithdrawalManagement()">Withdrawals</button>
                <button class="filter-btn" onclick="showChatSupport()">Support Chat</button>
            </div>

            <div id="adminMessage"></div>

            <!-- Trades Section -->
            <div id="tradesSection">
                <h2 style="margin-bottom: 20px;">Trade Management</h2>
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search by User ID, Email, or Trade ID..." oninput="searchTrades()">
                </div>
                <div class="trades-table">
                    <div class="table-header" style="grid-template-columns: 100px 120px 150px 100px 100px 100px 120px;">
                        <div>User ID</div>
                        <div>User Name</div>
                        <div>Email</div>
                        <div>Coin</div>
                        <div>Amount</div>
                        <div>Direction</div>
                        <div>Status</div>
                    </div>
                    <div id="tradesContainer"></div>
                </div>
            </div>

            <!-- User Management Section -->
            <div id="userManagementSection" style="display: none;">
                <h2 style="margin-bottom: 20px;">User Management</h2>
                <div class="search-box">
                    <input type="text" class="search-input" id="userSearchInput" placeholder="Search by User ID or Email..." oninput="searchUsers()">
                </div>
                <div class="trades-table">
                    <div class="table-header" style="grid-template-columns: 80px 120px 180px 100px 150px 200px;">
                        <div>User ID</div>
                        <div>Name</div>
                        <div>Email</div>
                        <div>Balance</div>
                        <div>Win/Loss Mode</div>
                        <div>Actions</div>
                    </div>
                    <div id="usersContainer"></div>
                </div>
            </div>

            <!-- Withdrawal Management Section -->
            <div id="withdrawalManagementSection" style="display: none;">
                <h2 style="margin-bottom: 20px;">Withdrawal Management</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-small btn-warning" onclick="filterWithdrawals('pending')">Pending</button>
                    <button class="btn btn-small btn-success" onclick="filterWithdrawals('approved')">Approved</button>
                    <button class="btn btn-small btn-danger" onclick="filterWithdrawals('rejected')">Rejected</button>
                    <button class="btn btn-small btn-info" onclick="filterWithdrawals('all')">All</button>
                </div>
                <div class="trades-table">
                    <div class="table-header" style="grid-template-columns: 80px 120px 100px 100px 200px 120px 200px;">
                        <div>User ID</div>
                        <div>Name</div>
                        <div>Method</div>
                        <div>Amount</div>
                        <div>Details</div>
                        <div>Status</div>
                        <div>Actions</div>
                    </div>
                    <div id="withdrawalsContainer"></div>
                </div>
            </div>

            <!-- Chat Support Section -->
            <div id="chatSupportSection" style="display: none;">
                <h2 style="margin-bottom: 20px;">Support Chat</h2>
                <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: 600px;">
                    <div style="background: #2a2a2a; border-radius: 15px; padding: 15px; overflow-y: auto;">
                        <h3 style="margin-bottom: 15px;">Active Chats</h3>
                        <div id="chatUsersList">Loading...</div>
                    </div>
                    <div style="background: #2a2a2a; border-radius: 15px; padding: 20px; display: flex; flex-direction: column;">
                        <div id="selectedUserInfo" style="padding-bottom: 15px; border-bottom: 2px solid #444; margin-bottom: 15px;">
                            Select a user to view chat
                        </div>
                        <div id="adminChatMessages" style="flex: 1; overflow-y: auto; padding: 15px; background: #1a1a1a; border-radius: 12px; margin-bottom: 15px;"></div>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="adminChatInput" placeholder="Type your message..." style="flex: 1; padding: 12px; border: 2px solid #444; border-radius: 12px; background: #333; color: #fff;" onkeypress="if(event.key==='Enter') sendAdminMessage()">
                            <button class="btn btn-small btn-success" style="padding: 12px 24px;" onclick="sendAdminMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Crypto Modal -->
    <div class="modal" id="addCryptoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Crypto to User</h2>
                <button class="close-btn" onclick="closeAddCryptoModal()">&times;</button>
            </div>
            <div id="addCryptoMessage"></div>
            <div class="input-group">
                <label>Select Cryptocurrency</label>
                <select id="cryptoType" style="width: 100%;">
                    <option value="btc">Bitcoin (BTC)</option>
                    <option value="eth">Ethereum (ETH)</option>
                    <option value="usdt">Tether (USDT)</option>
                </select>
            </div>
            <div class="input-group">
                <label>Amount</label>
                <input type="number" id="cryptoAmount" placeholder="Enter amount" step="0.00000001">
            </div>
            <button class="btn btn-primary" onclick="submitAddCrypto()">Add Crypto</button>
        </div>
    </div>

    <!-- Withdrawal Detail Modal -->
    <div class="modal" id="withdrawalDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Withdrawal Details</h2>
                <button class="close-btn" onclick="closeWithdrawalDetail()">&times;</button>
            </div>
            <div id="withdrawalDetailContent"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" style="flex: 1;" onclick="approveWithdrawal()">Approve</button>
                <button class="btn btn-danger" style="flex: 1;" onclick="rejectWithdrawal()">Reject</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDWQBTrvvxCL5Qd23iSMTQlWkaPKZgjhqw",
            authDomain: "trading-dapp-d5aa4.firebaseapp.com",
            projectId: "trading-dapp-d5aa4",
            storageBucket: "trading-dapp-d5aa4.firebasestorage.app",
            messagingSenderId: "690266747119",
            appId: "1:690266747119:web:0f22d45fbee53ee3c3eb1a"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let allTrades = [];
        let allUsers = [];
        let allWithdrawals = [];
        let selectedChatUserId = null;
        let chatUsersListener = null;
        let chatMessagesListener = null;
        let withdrawalFilter = 'pending';
        let selectedUserId = null;
        let selectedWithdrawalId = null;

        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            if (el) {
                el.innerHTML = `<div class="message ${type}">${message}</div>`;
                setTimeout(() => { el.innerHTML = ''; }, 4000);
            }
        }

        async function adminLogin() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;

            if (!email || !password) {
                showMessage('loginMessage', 'Please fill all fields', 'error');
                return;
            }

            const ADMIN_EMAIL = 'dawitamene1122@gmail.com';
            
            if (email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
                showMessage('loginMessage', 'Access denied. Not an admin account.', 'error');
                return;
            }

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                if (userCredential.user.email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
                    await auth.signOut();
                    showMessage('loginMessage', 'Access denied. Admin privileges required.', 'error');
                    return;
                }
                
                showMessage('loginMessage', 'Admin login successful!', 'success');
            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    showMessage('loginMessage', 'Admin account not found. Please register this email first in the main app.', 'error');
                } else if (error.code === 'auth/wrong-password') {
                    showMessage('loginMessage', 'Invalid password', 'error');
                } else {
                    showMessage('loginMessage', 'Login failed: ' + error.message, 'error');
                }
            }
        }

        function adminLogout() {
            if (chatUsersListener) chatUsersListener();
            if (chatMessagesListener) chatMessagesListener();
            auth.signOut();
        }

        async function loadDashboard() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminPanel').classList.add('active');
            
            await loadStats();
            await loadTrades();
            
            setInterval(loadStats, 10000);
            setInterval(loadTrades, 10000);
        }

        function showLogin() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('adminPanel').classList.remove('active');
        }

        async function loadStats() {
            try {
                const tradesSnapshot = await db.collection('trades').get();
                const usersSnapshot = await db.collection('users').get();
                const withdrawalsSnapshot = await db.collection('withdrawals').get();
                
                let pendingTradesCount = 0;
                let pendingWithdrawalsCount = 0;

                tradesSnapshot.forEach(doc => {
                    if (doc.data().status === 'pending') pendingTradesCount++;
                });

                withdrawalsSnapshot.forEach(doc => {
                    if (doc.data().status === 'pending') pendingWithdrawalsCount++;
                });

                document.getElementById('totalTrades').textContent = tradesSnapshot.size;
                document.getElementById('pendingTrades').textContent = pendingTradesCount;
                document.getElementById('totalUsers').textContent = usersSnapshot.size;
                document.getElementById('pendingWithdrawals').textContent = pendingWithdrawalsCount;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadTrades() {
            try {
                const tradesSnapshot = await db.collection('trades').get();

                allTrades = [];
                tradesSnapshot.forEach(doc => {
                    allTrades.push({ id: doc.id, ...doc.data() });
                });

                allTrades.sort((a, b) => {
                    const timeA = a.createdAt?.toMillis() || 0;
                    const timeB = b.createdAt?.toMillis() || 0;
                    return timeB - timeA;
                });

                renderTrades();
            } catch (error) {
                console.error('Error loading trades:', error);
                document.getElementById('tradesContainer').innerHTML = '<div class="no-data">Error loading trades</div>';
            }
        }

        function renderTrades() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            let filteredTrades = allTrades;

            if (searchTerm) {
                filteredTrades = allTrades.filter(trade => 
                    trade.userIdNumber?.toString().includes(searchTerm) ||
                    trade.userEmail?.toLowerCase().includes(searchTerm) ||
                    trade.userName?.toLowerCase().includes(searchTerm) ||
                    trade.id.includes(searchTerm)
                );
            }

            if (filteredTrades.length === 0) {
                document.getElementById('tradesContainer').innerHTML = '<div class="no-data">No trades found</div>';
                return;
            }

            const html = filteredTrades.slice(0, 50).map(trade => {
                let statusBadge = '';
                if (trade.status === 'pending') {
                    statusBadge = `<span class="status-badge status-pending">PENDING</span>`;
                } else if (trade.status === 'win') {
                    statusBadge = `<span class="status-badge status-win">WIN</span>`;
                } else if (trade.status === 'loss') {
                    statusBadge = `<span class="status-badge status-loss">LOSS</span>`;
                }

                return `
                    <div class="table-row" style="grid-template-columns: 100px 120px 150px 100px 100px 100px 120px;">
                        <div>${trade.userIdNumber || 'N/A'}</div>
                        <div>${trade.userName || 'N/A'}</div>
                        <div style="font-size: 12px;">${trade.userEmail || 'N/A'}</div>
                        <div><strong>${trade.coin}</strong></div>
                        <div>${trade.amount.toFixed(2)}</div>
                        <div style="color: ${trade.direction === 'up' ? '#4caf50' : '#f44336'}; font-weight: 600;">${trade.direction.toUpperCase()}</div>
                        <div>${statusBadge}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('tradesContainer').innerHTML = html;
        }

        function searchTrades() {
            renderTrades();
        }

        function showTradesSection() {
            document.getElementById('tradesSection').style.display = 'block';
            document.getElementById('userManagementSection').style.display = 'none';
            document.getElementById('withdrawalManagementSection').style.display = 'none';
            document.getElementById('chatSupportSection').style.display = 'none';
            
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            loadTrades();
        }

        function showUserManagement() {
            document.getElementById('tradesSection').style.display = 'none';
            document.getElementById('userManagementSection').style.display = 'block';
            document.getElementById('withdrawalManagementSection').style.display = 'none';
            document.getElementById('chatSupportSection').style.display = 'none';
            
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            loadUsers();
        }

        function showWithdrawalManagement() {
            document.getElementById('tradesSection').style.display = 'none';
            document.getElementById('userManagementSection').style.display = 'none';
            document.getElementById('withdrawalManagementSection').style.display = 'block';
            document.getElementById('chatSupportSection').style.display = 'none';
            
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            loadWithdrawals();
        }

        function showChatSupport() {
            document.getElementById('tradesSection').style.display = 'none';
            document.getElementById('userManagementSection').style.display = 'none';
            document.getElementById('withdrawalManagementSection').style.display = 'none';
            document.getElementById('chatSupportSection').style.display = 'block';
            
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            loadChatUsers();
        }

        async function loadUsers() {
            try {
                const usersSnapshot = await db.collection('users').get();
                allUsers = [];
                usersSnapshot.forEach(doc => {
                    allUsers.push({ uid: doc.id, ...doc.data() });
                });
                renderUsers();
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function renderUsers() {
            let filteredUsers = allUsers;

            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            if (searchTerm) {
                filteredUsers = allUsers.filter(user => 
                    user.userId?.toString().includes(searchTerm) ||
                    user.email?.toLowerCase().includes(searchTerm) ||
                    user.name?.toLowerCase().includes(searchTerm)
                );
            }

            const html = filteredUsers.map(user => {
                const tradingMode = user.tradingMode || 'loss';
                const isWinMode = tradingMode === 'win';
                
                return `
                <div class="table-row" style="grid-template-columns: 80px 120px 180px 100px 150px 200px; align-items: center;">
                    <div>${user.userId || 'N/A'}</div>
                    <div>${user.name || 'N/A'}</div>
                    <div style="font-size: 11px;">${user.email || 'N/A'}</div>
                    <div style="font-weight: 600; color: #4caf50;">${(user.balance || 0).toFixed(2)}</div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label class="toggle-switch">
                            <input type="checkbox" ${isWinMode ? 'checked' : ''} onchange="toggleTradingMode('${user.uid}', this.checked)">
                            <span class="slider"></span>
                        </label>
                        <span class="mode-label ${isWinMode ? 'win' : 'loss'}" id="mode-${user.uid}">
                            ${isWinMode ? 'WIN' : 'LOSS'}
                        </span>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-small btn-success" onclick="adjustBalance('${user.uid}', 'add')">+$</button>
                        <button class="btn btn-small btn-danger" onclick="adjustBalance('${user.uid}', 'remove')">-$</button>
                        <button class="btn btn-small btn-info" onclick="openAddCrypto('${user.uid}')">+Crypto</button>
                    </div>
                </div>
            `;
            }).join('');

            document.getElementById('usersContainer').innerHTML = html || '<div class="no-data">No users found</div>';
        }

        function searchUsers() {
            renderUsers();
        }

        async function adjustBalance(userId, action) {
            const amount = prompt(`Enter amount to ${action}:`);
            if (!amount || isNaN(amount)) {
                alert('Invalid amount');
                return;
            }

            const amountNum = parseFloat(amount);
            if (amountNum <= 0) {
                alert('Amount must be positive');
                return;
            }

            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) {
                    alert('User not found');
                    return;
                }

                const currentBalance = userDoc.data().balance || 0;
                let newBalance;

                if (action === 'add') {
                    newBalance = currentBalance + amountNum;
                } else {
                    newBalance = Math.max(0, currentBalance - amountNum);
                }

                await db.collection('users').doc(userId).update({ balance: newBalance });
                
                showMessage('adminMessage', `Balance ${action === 'add' ? 'added' : 'removed'} successfully!`, 'success');
                await loadUsers();
                await loadStats();
            } catch (error) {
                showMessage('adminMessage', 'Error: ' + error.message, 'error');
            }
        }

        async function toggleTradingMode(userId, isWinMode) {
            const mode = isWinMode ? 'win' : 'loss';
            
            try {
                await db.collection('users').doc(userId).update({ 
                    tradingMode: mode 
                });
                
                const label = document.getElementById(`mode-${userId}`);
                if (label) {
                    label.textContent = mode.toUpperCase();
                    label.className = `mode-label ${mode}`;
                }
                
                showMessage('adminMessage', `User trading mode set to ${mode.toUpperCase()}`, 'success');
                
                const userIndex = allUsers.findIndex(u => u.uid === userId);
                if (userIndex !== -1) {
                    allUsers[userIndex].tradingMode = mode;
                }
            } catch (error) {
                showMessage('adminMessage', 'Error: ' + error.message, 'error');
            }
        }

        function openAddCrypto(userId) {
            selectedUserId = userId;
            document.getElementById('addCryptoModal').classList.add('active');
            document.getElementById('cryptoAmount').value = '';
        }

        function closeAddCryptoModal() {
            document.getElementById('addCryptoModal').classList.remove('active');
            selectedUserId = null;
        }

        async function submitAddCrypto() {
            const cryptoType = document.getElementById('cryptoType').value;
            const amount = parseFloat(document.getElementById('cryptoAmount').value);

            if (!amount || amount <= 0) {
                showMessage('addCryptoMessage', 'Please enter a valid amount', 'error');
                return;
            }

            try {
                const userDoc = await db.collection('users').doc(selectedUserId).get();
                if (!userDoc.exists) {
                    showMessage('addCryptoMessage', 'User not found', 'error');
                    return;
                }

                const userData = userDoc.data();
                const updates = {};

                if (cryptoType === 'btc') {
                    updates.btcBalance = (userData.btcBalance || 0) + amount;
                } else if (cryptoType === 'eth') {
                    updates.ethBalance = (userData.ethBalance || 0) + amount;
                } else if (cryptoType === 'usdt') {
                    updates.usdtBalance = (userData.usdtBalance || 0) + amount;
                }

                await db.collection('users').doc(selectedUserId).update(updates);
                
                showMessage('addCryptoMessage', `${amount} ${cryptoType.toUpperCase()} added successfully!`, 'success');
                setTimeout(() => closeAddCryptoModal(), 2000);
                await loadUsers();
            } catch (error) {
                showMessage('addCryptoMessage', 'Error: ' + error.message, 'error');
            }
        }

        async function loadWithdrawals() {
            try {
                const withdrawalsSnapshot = await db.collection('withdrawals').get();
                allWithdrawals = [];
                withdrawalsSnapshot.forEach(doc => {
                    allWithdrawals.push({ id: doc.id, ...doc.data() });
                });
                
                allWithdrawals.sort((a, b) => {
                    const timeA = a.createdAt?.toMillis() || 0;
                    const timeB = b.createdAt?.toMillis() || 0;
                    return timeB - timeA;
                });
                
                renderWithdrawals();
            } catch (error) {
                console.error('Error loading withdrawals:', error);
            }
        }

        function filterWithdrawals(filter) {
            withdrawalFilter = filter;
            renderWithdrawals();
        }

        function renderWithdrawals() {
            let filteredWithdrawals = allWithdrawals;

            if (withdrawalFilter !== 'all') {
                filteredWithdrawals = allWithdrawals.filter(w => w.status === withdrawalFilter);
            }

            if (filteredWithdrawals.length === 0) {
                document.getElementById('withdrawalsContainer').innerHTML = '<div class="no-data">No withdrawals found</div>';
                return;
            }

            const html = filteredWithdrawals.map(w => {
                let statusBadge = '';
                if (w.status === 'pending') {
                    statusBadge = `<span class="status-badge status-pending">PENDING</span>`;
                } else if (w.status === 'approved') {
                    statusBadge = `<span class="status-badge status-approved">APPROVED</span>`;
                } else if (w.status === 'rejected') {
                    statusBadge = `<span class="status-badge status-rejected">REJECTED</span>`;
                }

                let details = '';
                if (w.method === 'crypto') {
                    details = `${w.crypto}: ${w.address.substring(0, 15)}...`;
                } else {
                    details = `${w.bankName} - ${w.accountNumber}`;
                }

                let actions = '';
                if (w.status === 'pending') {
                    actions = `
                        <div class="action-btns">
                            <button class="btn btn-small btn-info" onclick="viewWithdrawalDetail('${w.id}')">View</button>
                            <button class="btn btn-small btn-success" onclick="quickApprove('${w.id}')">Approve</button>
                            <button class="btn btn-small btn-danger" onclick="quickReject('${w.id}')">Reject</button>
                        </div>
                    `;
                } else {
                    actions = `<span style="color: #666;">Processed</span>`;
                }

                return `
                    <div class="table-row" style="grid-template-columns: 80px 120px 100px 100px 200px 120px 200px;">
                        <div>${w.userIdNumber || 'N/A'}</div>
                        <div>${w.userName || 'N/A'}</div>
                        <div>${w.method.toUpperCase()}</div>
                        <div>${w.amount.toFixed(2)}</div>
                        <div style="font-size: 11px;">${details}</div>
                        <div>${statusBadge}</div>
                        <div>${actions}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('withdrawalsContainer').innerHTML = html;
        }

        function viewWithdrawalDetail(withdrawalId) {
            selectedWithdrawalId = withdrawalId;
            const withdrawal = allWithdrawals.find(w => w.id === withdrawalId);
            
            if (!withdrawal) return;

            let detailsHtml = `
                <div style="background: #333; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #aaa;">User ID:</span>
                        <span style="font-weight: 600;">${withdrawal.userIdNumber}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #aaa;">Name:</span>
                        <span style="font-weight: 600;">${withdrawal.userName}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #aaa;">Email:</span>
                        <span style="font-weight: 600;">${withdrawal.userEmail}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #aaa;">Amount:</span>
                        <span style="font-weight: 600; color: #4285f4; font-size: 18px;">${withdrawal.amount.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #aaa;">Method:</span>
                        <span style="font-weight: 600;">${withdrawal.method.toUpperCase()}</span>
                    </div>
            `;

            if (withdrawal.method === 'crypto') {
                detailsHtml += `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #aaa;">Crypto:</span>
                        <span style="font-weight: 600;">${withdrawal.crypto}</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="color: #aaa; margin-bottom: 5px;">Wallet Address:</div>
                        <div style="background: #1a1a1a; padding: 10px; border-radius: 8px; word-break: break-all; font-family: monospace; font-size: 12px;">${withdrawal.address}</div>
                    </div>
                `;
            } else {
                detailsHtml += `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #aaa;">Bank:</span>
                        <span style="font-weight: 600;">${withdrawal.bankName}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #aaa;">Account:</span>
                        <span style="font-weight: 600;">${withdrawal.accountNumber}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #aaa;">Holder:</span>
                        <span style="font-weight: 600;">${withdrawal.accountHolder}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #aaa;">SWIFT/IBAN:</span>
                        <span style="font-weight: 600;">${withdrawal.swiftCode}</span>
                    </div>
                `;
            }

            detailsHtml += `</div>`;

            document.getElementById('withdrawalDetailContent').innerHTML = detailsHtml;
            document.getElementById('withdrawalDetailModal').classList.add('active');
        }

        function closeWithdrawalDetail() {
            document.getElementById('withdrawalDetailModal').classList.remove('active');
            selectedWithdrawalId = null;
        }

        async function approveWithdrawal() {
            if (!selectedWithdrawalId) return;

            if (!confirm('Are you sure you want to approve this withdrawal?')) return;

            try {
                await db.collection('withdrawals').doc(selectedWithdrawalId).update({
                    status: 'approved',
                    processedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showMessage('adminMessage', 'Withdrawal approved successfully!', 'success');
                closeWithdrawalDetail();
                await loadWithdrawals();
                await loadStats();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function rejectWithdrawal() {
            if (!selectedWithdrawalId) return;

            if (!confirm('Are you sure you want to reject this withdrawal? The amount will be refunded to the user.')) return;

            try {
                const withdrawalDoc = await db.collection('withdrawals').doc(selectedWithdrawalId).get();
                if (!withdrawalDoc.exists) {
                    alert('Withdrawal not found');
                    return;
                }

                const withdrawal = withdrawalDoc.data();
                const userDoc = await db.collection('users').doc(withdrawal.userId).get();
                
                if (userDoc.exists) {
                    const currentBalance = userDoc.data().balance || 0;
                    await db.collection('users').doc(withdrawal.userId).update({
                        balance: currentBalance + withdrawal.amount
                    });
                }

                await db.collection('withdrawals').doc(selectedWithdrawalId).update({
                    status: 'rejected',
                    processedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showMessage('adminMessage', 'Withdrawal rejected and amount refunded!', 'success');
                closeWithdrawalDetail();
                await loadWithdrawals();
                await loadStats();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function quickApprove(withdrawalId) {
            selectedWithdrawalId = withdrawalId;
            await approveWithdrawal();
        }

        async function quickReject(withdrawalId) {
            selectedWithdrawalId = withdrawalId;
            await rejectWithdrawal();
        }

        function loadChatUsers() {
            if (chatUsersListener) chatUsersListener();
            
            chatUsersListener = db.collection('chats')
                .onSnapshot(snapshot => {
                    const userChats = {};
                    
                    snapshot.forEach(doc => {
                        const chat = doc.data();
                        if (!userChats[chat.userId]) {
                            userChats[chat.userId] = {
                                userId: chat.userId,
                                userIdNumber: chat.userIdNumber,
                                userName: chat.userName,
                                userEmail: chat.userEmail,
                                lastMessage: chat.message,
                                timestamp: chat.timestamp,
                                unread: !chat.read && chat.senderType === 'user'
                            };
                        }
                    });

                    const chatUsersList = document.getElementById('chatUsersList');
                    const users = Object.values(userChats);
                    
                    if (users.length === 0) {
                        chatUsersList.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No chats yet</div>';
                        return;
                    }

                    chatUsersList.innerHTML = users.map(user => `
                        <div onclick="selectChatUser('${user.userId}')" style="padding: 12px; margin-bottom: 8px; background: ${selectedChatUserId === user.userId ? '#4285f4' : '#333'}; border-radius: 8px; cursor: pointer; ${user.unread ? 'border-left: 3px solid #4caf50;' : ''}">
                            <div style="font-weight: 600; margin-bottom: 5px;">${user.userName}</div>
                            <div style="font-size: 11px; color: #aaa;">ID: ${user.userIdNumber}</div>
                            ${user.unread ? '<div style="font-size: 10px; color: #4caf50; margin-top: 5px;">‚óè New message</div>' : ''}
                        </div>
                    `).join('');
                });
        }

        function selectChatUser(userId) {
            selectedChatUserId = userId;
            loadChatMessages(userId);
            loadChatUsers();
        }

        function loadChatMessages(userId) {
            if (chatMessagesListener) chatMessagesListener();

            db.collection('chats')
                .where('userId', '==', userId)
                .limit(1)
                .get()
                .then(snapshot => {
                    if (!snapshot.empty) {
                        const userData = snapshot.docs[0].data();
                        document.getElementById('selectedUserInfo').innerHTML = `
                            <div style="font-weight: 600; font-size: 16px;">${userData.userName}</div>
                            <div style="font-size: 12px; color: #aaa;">ID: ${userData.userIdNumber} | ${userData.userEmail}</div>
                        `;
                    }
                });
            
            chatMessagesListener = db.collection('chats')
                .where('userId', '==', userId)
                .onSnapshot(snapshot => {
                    const adminChatMessages = document.getElementById('adminChatMessages');
                    
                    if (snapshot.empty) {
                        adminChatMessages.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No messages yet</div>';
                        return;
                    }

                    const messages = [];
                    snapshot.forEach(doc => {
                        messages.push({ id: doc.id, ...doc.data() });
                    });
                    
                    messages.sort((a, b) => {
                        const timeA = a.timestamp?.toMillis() || 0;
                        const timeB = b.timestamp?.toMillis() || 0;
                        return timeA - timeB;
                    });

                    let html = '';
                    messages.forEach(msg => {
                        const isUser = msg.senderType === 'user';
                        const time = msg.timestamp ? new Date(msg.timestamp.toMillis()).toLocaleTimeString() : '';
                        
                        html += `
                            <div style="margin-bottom: 15px; text-align: ${isUser ? 'left' : 'right'};">
                                <div style="display: inline-block; max-width: 70%; padding: 10px 15px; border-radius: 12px; background: ${isUser ? '#333' : '#4285f4'}; color: #fff; text-align: left;">
                                    <div style="font-weight: 600; font-size: 12px; margin-bottom: 5px; opacity: 0.8;">${isUser ? msg.userName : 'Admin'}</div>
                                    <div>${msg.message}</div>
                                    <div style="font-size: 10px; margin-top: 5px; opacity: 0.7;">${time}</div>
                                </div>
                            </div>
                        `;

                        if (isUser && !msg.read) {
                            db.collection('chats').doc(msg.id).update({ read: true });
                        }
                    });

                    adminChatMessages.innerHTML = html;
                    adminChatMessages.scrollTop = adminChatMessages.scrollHeight;
                });
        }

        async function sendAdminMessage() {
            if (!selectedChatUserId) {
                alert('Please select a user first');
                return;
            }

            const input = document.getElementById('adminChatInput');
            const message = input.value.trim();

            if (!message) return;

            try {
                const userChats = await db.collection('chats')
                    .where('userId', '==', selectedChatUserId)
                    .limit(1)
                    .get();

                let userData = { userName: 'User', userIdNumber: 'N/A', userEmail: 'N/A' };
                if (!userChats.empty) {
                    userData = userChats.docs[0].data();
                }

                await db.collection('chats').add({
                    userId: selectedChatUserId,
                    userIdNumber: userData.userIdNumber,
                    userName: userData.userName,
                    userEmail: userData.userEmail,
                    message: message,
                    senderType: 'admin',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false
                });

                input.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message');
            }
        }

        auth.onAuthStateChanged((user) => {
            if (user) {
                const ADMIN_EMAIL = 'dawitamene1122@gmail.com';
                if (user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                    loadDashboard();
                } else {
                    auth.signOut();
                    showLogin();
                    showMessage('loginMessage', 'Access denied. Admin account required.', 'error');
                }
            } else {
                showLogin();
            }
        });
    </script>
</body>
</html>
