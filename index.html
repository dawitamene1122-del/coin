<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hibt - Trading Platform</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: #f5f5f5;
            overflow-x: hidden;
        }
        
        /* Auth Container */
        .auth-container { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 20px; 
        }
        .auth-box { 
            background: white; 
            border-radius: 20px; 
            padding: 40px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
            width: 90%; 
            max-width: 400px; 
        }
        .auth-title { 
            font-size: 24px; 
            font-weight: 600; 
            margin-bottom: 30px; 
            text-align: center; 
            color: #333;
        }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; }
        input, select { 
            width: 100%; 
            padding: 15px; 
            border: 2px solid #e1e5e9; 
            border-radius: 12px; 
            font-size: 16px; 
        }
        input:focus, select:focus { outline: none; border-color: #667eea; }
        .btn { 
            width: 100%; 
            padding: 15px; 
            border: none; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            margin-top: 20px; 
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover:not(:disabled) { background: #5a67d8; }
        .switch-text { margin-top: 20px; color: #6c757d; text-align: center; }
        .switch-link { color: #667eea; cursor: pointer; text-decoration: underline; }
        .message { padding: 10px; border-radius: 8px; margin-bottom: 15px; font-weight: 500; }
        .error { background: #fee; color: #c33; border: 1px solid #fcc; }
        .success { background: #efe; color: #363; border: 1px solid #cfc; }
        .hidden { display: none; }
        
        /* Main App */
        .app { display: none; min-height: 100vh; background: #f5f5f5; }
        .app.active { display: block; }
        
        /* Header Banner */
        .header-banner {
            background: linear-gradient(135deg, #4285f4 0%, #1e3c72 100%);
            padding: 30px 20px;
            color: white;
            position: relative;
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .brand { font-size: 28px; font-weight: bold; }
        .header-icons {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .icon-btn {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            border: none;
            color: white;
        }
        .icon-btn:active { background: rgba(255,255,255,0.3); }
        .tagline {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        .logo-box {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #a8ff78 0%, #78ffd6 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin-left: auto;
        }
        
        /* Market Section */
        .market-section {
            padding: 20px;
        }
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }
        .coin-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .coin-card {
            background: white;
            border-radius: 16px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .coin-card:active { transform: scale(0.98); }
        .coin-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 16px;
        }
        .coin-info {
            flex: 1;
        }
        .coin-name {
            font-weight: 600;
            font-size: 15px;
            color: #333;
        }
        .coin-symbol {
            font-size: 12px;
            color: #888;
            margin-top: 2px;
        }
        .coin-graph {
            width: 60px;
            height: 30px;
        }
        .coin-price-info {
            text-align: right;
        }
        .coin-price {
            font-weight: 600;
            font-size: 15px;
            color: #333;
        }
        .coin-change {
            font-size: 11px;
            margin-top: 2px;
        }
        .coin-change.positive { color: #4caf50; }
        .coin-change.negative { color: #f44336; }
        .coin-time {
            font-size: 10px;
            color: #888;
            margin-top: 2px;
        }
        
        /* Side Menu */
        .side-menu {
            position: fixed;
            left: -100%;
            top: 0;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: left 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        .side-menu.active { left: 0; }
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        .menu-overlay.active { display: block; }
        .menu-header {
            background: linear-gradient(135deg, #4285f4 0%, #1e3c72 100%);
            padding: 30px 20px;
            color: white;
        }
        .menu-brand {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .menu-uid {
            font-size: 13px;
            opacity: 0.9;
        }
        .menu-wallet-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 12px;
            width: 100%;
            font-size: 15px;
            font-weight: 600;
            margin-top: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .menu-section {
            padding: 20px;
        }
        .menu-section-title {
            font-size: 13px;
            color: #888;
            margin-bottom: 15px;
            font-weight: 600;
        }
        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.2s;
            margin-bottom: 5px;
        }
        .menu-item:hover { background: #f5f5f5; }
        .menu-item-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .menu-item-text {
            font-size: 15px;
            color: #333;
        }
        
        /* Page Container */
        .page {
            display: none;
            min-height: 100vh;
            background: #f5f5f5;
        }
        .page.active { display: block; }
        .page-header {
            background: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .back-btn {
            width: 36px;
            height: 36px;
            background: #f5f5f5;
            border-radius: 10px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }
        .page-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        .page-content {
            padding: 20px;
        }
        
        /* Card */
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }
        
        /* Crypto Balance Item */
        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .balance-item:active { background: #f0f0f0; }
        
        /* Wallet Detail View */
        .wallet-detail {
            background: white;
            min-height: 100vh;
        }
        .wallet-header {
            background: white;
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }
        .wallet-balance {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .wallet-crypto-info {
            font-size: 14px;
            color: #666;
        }
        .wallet-tabs {
            display: flex;
            background: #f5f5f5;
            padding: 5px;
            border-radius: 12px;
            margin: 20px;
            gap: 5px;
        }
        .wallet-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .wallet-tab.active {
            background: white;
            color: #4285f4;
        }
        .wallet-tab-content {
            display: none;
            padding: 20px;
        }
        .wallet-tab-content.active {
            display: block;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            overflow-y: auto;
        }
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #888;
            line-height: 1;
        }
        
        /* Trade Modal */
        .trade-section { margin-bottom: 20px; }
        .trade-label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #666;
            font-size: 14px;
        }
        .direction-btns { display: flex; gap: 10px; }
        .direction-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .direction-btn.up { background: #4caf50; color: white; }
        .direction-btn.down { background: #f44336; color: white; }
        .direction-btn.inactive { background: #e0e0e0; color: #999; }
        .trade-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 15px;
            background: #f9f9f9;
        }
        .trade-input:focus { outline: none; border-color: #4285f4; }
        .info-text {
            color: #888;
            font-size: 13px;
            margin-top: 8px;
        }
        .trade-btn {
            width: 100%;
            padding: 16px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }
        .trade-btn:hover:not(:disabled) { background: #3367d6; }
        .trade-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Amount with Max Button */
        .amount-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .amount-input-wrapper input {
            flex: 1;
        }
        .max-btn {
            padding: 15px 20px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Crypto Selector */
        .crypto-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
        }
        .crypto-selector:active { background: #f0f0f0; }
        
        /* Crypto List Modal */
        .crypto-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        .crypto-list-item:active { background: #f9f9f9; }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-value.green { color: #4caf50; }
        .stat-value.red { color: #f44336; }
        .stat-label {
            color: #888;
            font-size: 13px;
        }
        
        /* History Item */
        .history-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            border-left: 4px solid #e0e0e0;
        }
        .history-item.pending { border-left-color: #ff9800; }
        .history-item.win { border-left-color: #4caf50; }
        .history-item.loss { border-left-color: #f44336; }
        .history-item.deposit { border-left-color: #2196F3; }
        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        /* Trade Detail Modal */
        .detail-modal {
            background: #1a1a1a;
            color: white;
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #333;
        }
        .detail-label {
            color: #999;
            font-size: 14px;
        }
        .detail-value {
            font-weight: 600;
            font-size: 14px;
        }
        .result-win {
            color: #4caf50;
            font-size: 18px;
            font-weight: bold;
        }
        .result-loss {
            color: #f44336;
            font-size: 18px;
            font-weight: bold;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 3000;
            animation: slideDown 0.3s ease;
            max-width: 90%;
            text-align: center;
        }
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        /* Coin Colors */
        .btc { background: #f7931a; }
        .eth { background: #627eea; }
        .usdt { background: #26a17b; }
        .xrp { background: #23292f; }
        .doge { background: #c2a633; }
        .ada { background: #0033ad; }
        .bnb { background: #f3ba2f; }
        .sol { background: #9945FF; }
        .link { background: #375BD2; }
        .dot { background: #E6007A; }
        .ltc { background: #345D9D; }
        .matic { background: #8247E5; }
        .avax { background: #E84142; }
        .atom { background: #2E3148; }
        .uni { background: #FF007A; }
        .shib { background: #FFA409; }
    </style>
</head>
<body>
    <!-- Auth Container -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <!-- Register Form -->
            <div id="registerForm">
                <h2 class="auth-title">Create Account</h2>
                <div id="authMessage"></div>
                <div class="input-group">
                    <label>Full Name</label>
                    <input type="text" id="regName" placeholder="Enter your name">
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="regEmail" placeholder="Enter email">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="regPassword" placeholder="Enter password">
                </div>
                <div class="input-group">
                    <label>Confirm Password</label>
                    <input type="password" id="regConfirmPassword" placeholder="Confirm password">
                </div>
                <button class="btn btn-primary" onclick="register()">Register</button>
                <div class="switch-text">
                    Already have an account? <span class="switch-link" onclick="showLogin()">Sign In</span>
                </div>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="hidden">
                <h2 class="auth-title">Sign In</h2>
                <div id="loginMessage"></div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="Enter email">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password">
                </div>
                <button class="btn btn-primary" onclick="login()">Sign In</button>
                <div class="switch-text">
                    <span class="switch-link" onclick="forgotPassword()">Forgot Password?</span>
                </div>
                <div class="switch-text">
                    Don't have an account? <span class="switch-link" onclick="showRegister()">Register</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app" id="mainApp">
        <!-- Header Banner -->
        <div class="header-banner">
            <div class="header-top">
                <div class="brand">Hibt</div>
                <div class="header-icons">
                    <button class="icon-btn" onclick="openNotifications()">🔔</button>
                    <button class="icon-btn" onclick="toggleMenu()">☰</button>
                </div>
            </div>
            <div class="tagline">Start making money plan.</div>
            <div class="logo-box">👥</div>
        </div>

        <!-- Market Section -->
        <div class="market-section">
            <h2 class="section-title">Market</h2>
            <div class="coin-list" id="coinList"></div>
        </div>
    </div>

    <!-- Side Menu -->
    <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
    <div class="side-menu" id="sideMenu">
        <div class="menu-header">
            <div class="menu-brand">Hibt</div>
            <div class="menu-uid">UID: <span id="menuUserId"></span></div>
            <button class="menu-wallet-btn" onclick="openWallet()">👛 Wallet</button>
        </div>
        <div class="menu-section">
            <div class="menu-section-title">Functions</div>
            <div class="menu-item" onclick="openAccount()">
                <div class="menu-item-icon">👤</div>
                <div class="menu-item-text">Account</div>
            </div>
            <div class="menu-item" onclick="openOverview()">
                <div class="menu-item-icon">📊</div>
                <div class="menu-item-text">Overview</div>
            </div>
            <div class="menu-item" onclick="openHistory()">
                <div class="menu-item-icon">📜</div>
                <div class="menu-item-text">History</div>
            </div>
            <div class="menu-item" onclick="openChat()">
                <div class="menu-item-icon">💬</div>
                <div class="menu-item-text">Customer Service Support</div>
            </div>
            <div class="menu-item" onclick="logout()">
                <div class="menu-item-icon">🚪</div>
                <div class="menu-item-text">Logout</div>
            </div>
        </div>
    </div>

    <!-- Wallet Page -->
    <div class="page" id="walletPage">
        <div class="page-header">
            <button class="back-btn" onclick="goBack()">←</button>
            <div class="page-title">Select a wallet</div>
        </div>
        <div class="page-content">
            <div id="walletCryptoList"></div>
        </div>
    </div>

    <!-- Wallet Detail Page -->
    <div class="page" id="walletDetailPage">
        <div class="page-header">
            <button class="back-btn" onclick="goBack()">←</button>
            <div class="page-title" id="walletDetailTitle">BTC wallet</div>
        </div>
        <div class="wallet-detail">
            <div class="wallet-header">
                <div class="wallet-balance" id="walletDetailBalance">US$ 0.0000</div>
                <div class="wallet-crypto-info">
                    <div>Available: <span id="walletDetailAvailable">0.00000000</span> <span id="walletDetailCrypto">BTC</span></div>
                    <div>Frozen: 0.00000000 <span id="walletDetailCryptoFrozen">BTC</span></div>
                </div>
            </div>
            
            <div class="wallet-tabs">
                <button class="wallet-tab" onclick="switchWalletTab('swap')">Swap</button>
                <button class="wallet-tab" onclick="switchWalletTab('deposit')">Deposit</button>
                <button class="wallet-tab" onclick="switchWalletTab('withdraw')">Withdraw</button>
            </div>
            
            <!-- Swap Tab -->
            <div class="wallet-tab-content" id="swapTab">
                <div class="card">
                    <div class="trade-section">
                        <div class="trade-label">From</div>
                        <div class="crypto-selector" onclick="openCryptoList('swapFrom')">
                            <div class="coin-icon" id="swapFromIcon"></div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;" id="swapFromName">BTC</div>
                            </div>
                            <div>▼</div>
                        </div>
                    </div>
                    <div class="trade-section">
                        <div class="trade-label">To</div>
                        <div class="crypto-selector" onclick="openCryptoList('swapTo')">
                            <div class="coin-icon" id="swapToIcon"></div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;" id="swapToName">USDT</div>
                            </div>
                            <div>▼</div>
                        </div>
                    </div>
                    <div class="trade-section">
                        <div class="trade-label">Amount</div>
                        <div class="amount-input-wrapper">
                            <input type="number" class="trade-input" id="swapAmount" placeholder="0" oninput="calculateSwapAmount()">
                            <button class="max-btn" onclick="fillMaxSwap()">Max</button>
                        </div>
                        <div class="info-text">Available: <span id="swapFromBalance">0.00</span></div>
                        <div class="info-text">Fee: 0%</div>
                    </div>
                    <button class="trade-btn" onclick="executeSwap()">Proceed to swap</button>
                </div>
            </div>
            
            <!-- Deposit Tab -->
            <div class="wallet-tab-content" id="depositTab">
                <div class="card">
                    <div class="trade-section">
                        <div class="trade-label">Select Cryptocurrency</div>
                        <div class="crypto-selector" onclick="openCryptoList('deposit')">
                            <div class="coin-icon" id="depositCryptoIcon"></div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;" id="depositCryptoName">BTC</div>
                            </div>
                            <div>▼</div>
                        </div>
                    </div>
                    <div class="trade-section">
                        <div class="trade-label">Deposit Address</div>
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 12px; word-break: break-all; font-family: monospace; font-size: 13px; margin-bottom: 10px;" id="depositAddress"></div>
                        <button class="trade-btn" onclick="copyDepositAddress()">Copy address</button>
                    </div>
                </div>
            </div>
            
            <!-- Withdraw Tab -->
            <div class="wallet-tab-content" id="withdrawTab">
                <div class="card">
                    <div class="trade-section">
                        <div class="trade-label">Select Method</div>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button class="direction-btn" id="cryptoWithdrawBtn" onclick="selectWithdrawMethod('crypto')" style="background: #4285f4; color: white;">Crypto</button>
                            <button class="direction-btn inactive" id="bankWithdrawBtn" onclick="selectWithdrawMethod('bank')">Bank</button>
                        </div>
                    </div>
                    
                    <div id="cryptoWithdrawForm">
                        <div class="trade-section">
                            <div class="trade-label">Select Cryptocurrency</div>
                            <div class="crypto-selector" onclick="openCryptoList('withdraw')">
                                <div class="coin-icon" id="withdrawCryptoIcon"></div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600;" id="withdrawCryptoName">BTC</div>
                                </div>
                                <div>▼</div>
                            </div>
                        </div>
                        <div class="trade-section">
                            <div class="trade-label">Receiving Address</div>
                            <input type="text" class="trade-input" id="withdrawAddress" placeholder="Enter wallet address">
                        </div>
                        <div class="trade-section">
                            <div class="trade-label">Amount</div>
                            <div class="amount-input-wrapper">
                                <input type="number" class="trade-input" id="withdrawAmount" placeholder="0">
                                <button class="max-btn" onclick="fillMaxWithdraw()">Max</button>
                            </div>
                            <div class="info-text">Available: <span id="withdrawAvailable">0.00</span></div>
                            <div class="info-text">Withdrawal fee is 0%</div>
                        </div>
                        <button class="trade-btn" onclick="submitWithdrawal()">Send now</button>
                    </div>
                    
                    <div id="bankWithdrawForm" class="hidden">
                        <div class="trade-section">
                            <div class="trade-label">Bank Name</div>
                            <input type="text" class="trade-input" id="bankName" placeholder="Enter bank name">
                        </div>
                        <div class="trade-section">
                            <div class="trade-label">Account Number</div>
                            <input type="text" class="trade-input" id="accountNumber" placeholder="Enter account number">
                        </div>
                        <div class="trade-section">
                            <div class="trade-label">Account Name</div>
                            <input type="text" class="trade-input" id="accountName" placeholder="Enter account holder name">
                        </div>
                        <div class="trade-section">
                            <div class="trade-label">Amount (USDT)</div>
                            <input type="number" class="trade-input" id="bankWithdrawAmount" placeholder="0">
                            <div class="info-text">Available: <span id="bankWithdrawAvailable">0.00</span> USDT</div>
                        </div>
                        <button class="trade-btn" onclick="submitBankWithdrawal()">Send now</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Crypto List Modal -->
    <div class="modal" id="cryptoListModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Select Cryptocurrency</h3>
                <button class="close-btn" onclick="closeCryptoList()">&times;</button>
            </div>
            <div id="cryptoListContent"></div>
        </div>
    </div>

    <!-- Trade Modal -->
    <div class="modal" id="tradeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="tradeModalTitle">Trade</h3>
                <button class="close-btn" onclick="closeTradeModal()">&times;</button>
            </div>
            <div id="tradeMessage"></div>
            <div class="trade-section">
                <div class="trade-label">Direction</div>
                <div class="direction-btns">
                    <button class="direction-btn up" id="upBtn" onclick="selectDirection('up')">Buy Up</button>
                    <button class="direction-btn down inactive" id="downBtn" onclick="selectDirection('down')">Buy Down</button>
                </div>
            </div>
            <div class="trade-section">
                <div class="trade-label">Purchase Amount (USDT)</div>
                <input type="number" class="trade-input" id="tradeAmount" placeholder="Min 100 USDT" min="100" oninput="updateExpectedProfit()">
                <div class="info-text">Available: <span id="availableBalance">0.00</span> USDT</div>
                <div class="info-text">Expected Profit: <span id="expectedProfit">0.00</span> USDT</div>
            </div>
            <div class="trade-section">
                <div class="trade-label">Contract Time</div>
                <select class="trade-input" id="timeFrame" onchange="updateTimeFrameAndProfit()">
                    <option value="60">60 Seconds (15% Profit)</option>
                    <option value="90">90 Seconds (25% Profit) - Requires 60,000 USDT</option>
                    <option value="120">2 Minutes (35% Profit) - Requires 130,000 USDT</option>
                </select>
            </div>
            <button class="trade-btn" id="executeTradeBtn" onclick="executeTrade()">Execute Trade</button>
        </div>
    </div>

    <!-- Trade Detail Modal -->
    <div class="modal" id="tradeDetailModal">
        <div class="detail-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="detailCoinName" style="color: white;">Trade Details</h3>
                <button class="close-btn" onclick="closeTradeDetail()" style="color: white;">&times;</button>
            </div>
            <div id="tradeDetailContent"></div>
        </div>
    </div>

    <!-- Overview Page -->
    <div class="page" id="overviewPage">
        <div class="page-header">
            <button class="back-btn" onclick="goBack()">←</button>
            <div class="page-title">Overview</div>
        </div>
        <div class="page-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalTrades">0</div>
                    <div class="stat-label">Total Trades</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value green" id="totalProfit">$0</div>
                    <div class="stat-label">Total Profit</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value red" id="totalLoss">$0</div>
                    <div class="stat-label">Total Loss</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="winRate">0%</div>
                    <div class="stat-label">Win Rate</div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">Recent Activity</div>
                <div id="recentActivity"></div>
            </div>
        </div>
    </div>

    <!-- History Page -->
    <div class="page" id="historyPage">
        <div class="page-header">
            <button class="back-btn" onclick="goBack()">←</button>
            <div class="page-title">History</div>
        </div>
        <div class="page-content">
            <div class="card">
                <div class="card-title">Trade History</div>
                <div id="tradeHistory"></div>
            </div>
            <div class="card">
                <div class="card-title">Transaction History</div>
                <div id="transactionHistory"></div>
            </div>
        </div>
    </div>

    <!-- Account Page -->
    <div class="page" id="accountPage">
        <div class="page-header">
            <button class="back-btn" onclick="goBack()">←</button>
            <div class="page-title">Account</div>
        </div>
        <div class="page-content">
            <div class="card">
                <div class="card-title">Profile Information</div>
                <div style="padding: 10px 0;">
                    <div style="margin-bottom: 15px;">
                        <div style="color: #888; font-size: 12px;">User ID</div>
                        <div style="font-size: 15px; font-weight: 600;" id="profileUserId"></div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <div style="color: #888; font-size: 12px;">Name</div>
                        <div style="font-size: 15px; font-weight: 600;" id="profileName"></div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <div style="color: #888; font-size: 12px;">Email</div>
                        <div style="font-size: 15px; font-weight: 600;" id="profileEmail"></div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <div style="color: #888; font-size: 12px;">Balance</div>
                        <div style="font-size: 15px; font-weight: 600; color: #4285f4;"><span id="profileBalance">0.00</span> USDT</div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="openChangePassword()">Change Password</button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Change Password</h3>
                <button class="close-btn" onclick="closeChangePassword()">&times;</button>
            </div>
            <div id="changePasswordMessage"></div>
            <div class="input-group">
                <label>Current Password</label>
                <input type="password" id="currentPassword" placeholder="Enter current password">
            </div>
            <div class="input-group">
                <label>New Password</label>
                <input type="password" id="newPassword" placeholder="Enter new password">
            </div>
            <div class="input-group">
                <label>Confirm New Password</label>
                <input type="password" id="confirmNewPassword" placeholder="Confirm new password">
            </div>
            <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
        </div>
    </div>

    <!-- Chat Modal -->
    <div class="modal" id="chatModal">
        <div class="modal-content" style="height: 600px; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3 class="modal-title">Customer Service Support</h3>
                <button class="close-btn" onclick="closeChat()">&times;</button>
            </div>
            <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 15px; background: #f9f9f9; border-radius: 12px; margin-bottom: 15px;"></div>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="chatInput" placeholder="Type your message..." style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 12px;" onkeypress="if(event.key==='Enter') sendMessage()">
                <button class="btn btn-primary" style="width: auto; padding: 12px 24px; margin: 0;" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDWQBTrvvxCL5Qd23iSMTQlWkaPKZgjhqw",
            authDomain: "trading-dapp-d5aa4.firebaseapp.com",
            projectId: "trading-dapp-d5aa4",
            storageBucket: "trading-dapp-d5aa4.firebasestorage.app",
            messagingSenderId: "690266747119",
            appId: "1:690266747119:web:0f22d45fbee53ee3c3eb1a"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let userBalance = 0;
        let userName = '';
        let userId = '';
        let userEmail = '';
        let cryptoBalances = {};
        let selectedCoin = null;
        let tradeDirection = 'up';
        let selectedPercentage = 15;
        let currentSwapFrom = 'btc';
        let currentSwapTo = 'usdt';
        let currentDepositCrypto = 'btc';
        let currentWithdrawCrypto = 'btc';
        let withdrawMethod = 'crypto';
        let tradeCheckInterval = null;
        let tradeDetailInterval = null;
        let balanceUpdateListener = null;
        let chatListener = null;
        let navigationStack = [];
        let cryptoListTarget = '';

        const WALLET_ADDRESSES = {
            btc: "bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh",
            eth: "0xd3B617d4009573DeB612C7126043AB7F6D050025",
            usdt: "11111111111",
            xrp: "11111111111",
            doge: "11111111111",
            ada: "11111111111",
            bnb: "11111111111",
            sol: "11111111111",
            link: "11111111111",
            dot: "11111111111",
            ltc: "11111111111",
            matic: "11111111111",
            avax: "11111111111",
            atom: "11111111111",
            uni: "11111111111",
            shib: "11111111111"
        };

        const coins = [
            { name: 'BTC', fullName: 'Bitcoin', symbol: 'USDT', class: 'btc', price: 109770.33 },
            { name: 'ETH', fullName: 'Ethereum', symbol: 'USDT', class: 'eth', price: 4030.81 },
            { name: 'USDT', fullName: 'Tether', symbol: 'USDT', class: 'usdt', price: 1 },
            { name: 'XRP', fullName: 'Ripple', symbol: 'USDT', class: 'xrp', price: 2.8131 },
            { name: 'DOGE', fullName: 'Dogecoin', symbol: 'USDT', class: 'doge', price: 0.2309 },
            { name: 'ADA', fullName: 'Cardano', symbol: 'USDT', class: 'ada', price: 1.2456 },
            { name: 'BNB', fullName: 'Binance Coin', symbol: 'USDT', class: 'bnb', price: 692.45 },
            { name: 'SOL', fullName: 'Solana', symbol: 'USDT', class: 'sol', price: 245.67 },
            { name: 'LINK', fullName: 'Chainlink', symbol: 'USDT', class: 'link', price: 28.91 },
            { name: 'DOT', fullName: 'Polkadot', symbol: 'USDT', class: 'dot', price: 8.92 },
            { name: 'LTC', fullName: 'Litecoin', symbol: 'USDT', class: 'ltc', price: 156.78 },
            { name: 'MATIC', fullName: 'Polygon', symbol: 'USDT', class: 'matic', price: 0.8934 },
            { name: 'AVAX', fullName: 'Avalanche', symbol: 'USDT', class: 'avax', price: 38.45 },
            { name: 'ATOM', fullName: 'Cosmos', symbol: 'USDT', class: 'atom', price: 12.34 },
            { name: 'UNI', fullName: 'Uniswap', symbol: 'USDT', class: 'uni', price: 15.67 },
            { name: 'SHIB', fullName: 'Shiba Inu', symbol: 'USDT', class: 'shib', price: 0.00002456 }
        ];

        function getCoinData(symbol) {
            return coins.find(c => c.name.toLowerCase() === symbol.toLowerCase());
        }

        function getCryptoPrice(symbol) {
            const coin = getCoinData(symbol);
            return coin ? coin.price : 0;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function generateUserId() {
            return Math.floor(10000 + Math.random() * 90000).toString();
        }

        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            if (el) {
                el.innerHTML = `<div class="message ${type}">${message}</div>`;
                setTimeout(() => { el.innerHTML = ''; }, 4000);
            }
        }

        function showRegister() {
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('loginForm').classList.add('hidden');
        }

        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function navigateToPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('mainApp').style.display = 'none';
            
            const page = document.getElementById(pageId);
            if (page) {
                page.classList.add('active');
                navigationStack.push(pageId);
            }
        }

        function goBack() {
            if (navigationStack.length > 0) {
                const currentPage = navigationStack.pop();
                document.getElementById(currentPage).classList.remove('active');
                
                if (navigationStack.length > 0) {
                    const previousPage = navigationStack[navigationStack.length - 1];
                    document.getElementById(previousPage).classList.add('active');
                } else {
                    document.getElementById('mainApp').style.display = 'block';
                }
            } else {
                document.getElementById('mainApp').style.display = 'block';
            }
        }

        async function register() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;

            if (!name || !email || !password || !confirmPassword) {
                showMessage('authMessage', 'Please fill all fields', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('authMessage', 'Password must be at least 6 characters', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showMessage('authMessage', 'Passwords do not match', 'error');
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                const newUserId = generateUserId();

                await db.collection('users').doc(user.uid).set({
                    userId: newUserId,
                    name: name,
                    email: email,
                    balance: 0,
                    cryptoBalances: {
                        btc: 0, eth: 0, xrp: 0, doge: 0, ada: 0,
                        bnb: 0, sol: 0, link: 0, dot: 0, ltc: 0,
                        matic: 0, avax: 0, atom: 0, uni: 0, shib: 0, usdt: 0
                    },
                    tradingMode: 'loss',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showMessage('authMessage', 'Account created successfully!', 'success');
            } catch (error) {
                showMessage('authMessage', error.message, 'error');
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showMessage('loginMessage', 'Please fill all fields', 'error');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                showMessage('loginMessage', error.message, 'error');
            }
        }

        function logout() {
            if (balanceUpdateListener) balanceUpdateListener();
            if (chatListener) chatListener();
            if (tradeCheckInterval) clearInterval(tradeCheckInterval);
            if (tradeDetailInterval) clearInterval(tradeDetailInterval);
            auth.signOut();
        }

        async function forgotPassword() {
            const email = document.getElementById('loginEmail').value.trim();
            
            if (!email) {
                showMessage('loginMessage', 'Please enter your email address', 'error');
                return;
            }

            try {
                await auth.sendPasswordResetEmail(email);
                showMessage('loginMessage', 'Password reset email sent!', 'success');
            } catch (error) {
                showMessage('loginMessage', error.message, 'error');
            }
        }

        async function loadUserData() {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                userBalance = userData.balance || 0;
                userName = userData.name || 'User';
                userId = userData.userId || '00000';
                userEmail = currentUser.email;
                cryptoBalances = userData.cryptoBalances || {};
                
                document.getElementById('menuUserId').textContent = userId;
                document.getElementById('profileUserId').textContent = userId;
                document.getElementById('profileName').textContent = userName;
                document.getElementById('profileEmail').textContent = userEmail;
                document.getElementById('profileBalance').textContent = userBalance.toFixed(2);
                
                if (balanceUpdateListener) balanceUpdateListener();
                balanceUpdateListener = db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        userBalance = doc.data().balance || 0;
                        cryptoBalances = doc.data().cryptoBalances || {};
                        document.getElementById('profileBalance').textContent = userBalance.toFixed(2);
                    }
                });

                renderCoins();
                startTradeChecker();
            }
        }

        function startTradeChecker() {
            if (tradeCheckInterval) clearInterval(tradeCheckInterval);
            
            tradeCheckInterval = setInterval(async () => {
                await checkAndCompleteTrades();
            }, 1000);
        }

        async function checkAndCompleteTrades() {
            try {
                const now = Date.now();
                const tradesSnapshot = await db.collection('trades')
                    .where('userId', '==', currentUser.uid)
                    .where('status', '==', 'pending')
                    .get();

                for (const doc of tradesSnapshot.docs) {
                    const trade = doc.data();
                    const tradeTime = trade.createdAt?.toMillis() || 0;
                    const endTime = tradeTime + (trade.timeFrame * 1000);

                    if (now >= endTime) {
                        const userDoc = await db.collection('users').doc(currentUser.uid).get();
                        const userMode = userDoc.exists ? (userDoc.data().tradingMode || 'loss') : 'loss';
                        
                        const winResult = userMode === 'win';
                        const profit = winResult ? trade.amount * (trade.percentage / 100) : 0;
                        const finalStatus = winResult ? 'win' : 'loss';

                        await db.collection('trades').doc(doc.id).update({
                            status: finalStatus,
                            profit: profit,
                            result: userMode,
                            completedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        if (winResult) {
                            const currentBalance = userDoc.data().balance || 0;
                            const newBalance = currentBalance + trade.amount + profit;
                            await db.collection('users').doc(currentUser.uid).update({
                                balance: newBalance
                            });
                            showNotification(`✅ ${trade.coinFull} Trade Won! +$${profit.toFixed(2)} profit`);
                        } else {
                            showNotification(`❌ ${trade.coinFull} Trade Lost! -$${trade.amount.toFixed(2)}`);
                        }
                        
                        if (document.getElementById('historyPage').classList.contains('active')) {
                            loadHistoryData();
                        }
                        if (document.getElementById('overviewPage').classList.contains('active')) {
                            loadOverviewData();
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking trades:', error);
            }
        }

        function renderCoins() {
            const coinList = document.getElementById('coinList');
            coinList.innerHTML = coins.map((coin, index) => {
                const change = (Math.random() * 10 - 5).toFixed(2);
                const isPositive = change > 0;
                const changeClass = isPositive ? 'positive' : 'negative';
                
                return `
                    <div class="coin-card" onclick="openTrade(${index})">
                        <div class="coin-icon ${coin.class}">${coin.name}</div>
                        <div class="coin-info">
                            <div class="coin-name">${coin.name} Coin</div>
                            <div class="coin-symbol">${coin.symbol}</div>
                        </div>
                        <svg class="coin-graph" viewBox="0 0 60 30">
                            <polyline
                                fill="none"
                                stroke="${isPositive ? '#4caf50' : '#f44336'}"
                                stroke-width="2"
                                points="0,15 15,${Math.random()*20+5} 30,${Math.random()*20+5} 45,${Math.random()*20+5} 60,${isPositive ? 5 : 25}"
                            />
                        </svg>
                        <div class="coin-price-info">
                            <div class="coin-price">US$ ${coin.price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 8})}</div>
                            <div class="coin-change ${changeClass}">${isPositive ? '+' : ''}${change}%</div>
                            <div class="coin-time">24 Hrs</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleMenu() {
            document.getElementById('sideMenu').classList.toggle('active');
            document.getElementById('menuOverlay').classList.toggle('active');
        }

        function openWallet() {
            toggleMenu();
            navigationStack = [];
            navigateToPage('walletPage');
            loadWalletList();
        }

        function loadWalletList() {
            const html = coins.map(coin => {
                const balance = coin.name.toLowerCase() === 'usdt' ? userBalance : (cryptoBalances[coin.name.toLowerCase()] || 0);
                const usdValue = balance * coin.price;
                
                return `
                    <div class="balance-item" onclick="openWalletDetail('${coin.name.toLowerCase()}')">
                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                            <div class="coin-icon ${coin.class}">${coin.name}</div>
                            <div>
                                <div style="font-weight: 600;">${coin.name} wallet</div>
                                <div style="font-size: 12px; color: #888;">${coin.name} Coin</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600;">US$ ${usdValue.toFixed(4)}</div>
                            <div style="font-size: 12px; color: #888;">${balance.toFixed(8)} ${coin.name}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('walletCryptoList').innerHTML = html;
        }

        function openWalletDetail(crypto) {
            const coin = getCoinData(crypto);
            if (!coin) return;
            
            currentSwapFrom = crypto;
            currentDepositCrypto = crypto;
            currentWithdrawCrypto = crypto;
            
            const balance = crypto === 'usdt' ? userBalance : (cryptoBalances[crypto] || 0);
            const usdValue = balance * coin.price;
            
            document.getElementById('walletDetailTitle').textContent = `${coin.name} wallet`;
            document.getElementById('walletDetailBalance').textContent = `US$ ${usdValue.toFixed(4)}`;
            document.getElementById('walletDetailAvailable').textContent = balance.toFixed(8);
            document.getElementById('walletDetailCrypto').textContent = coin.name;
            document.getElementById('walletDetailCryptoFrozen').textContent = coin.name;
            
            navigateToPage('walletDetailPage');
            switchWalletTab('swap');
            updateSwapUI();
            updateDepositUI();
            updateWithdrawUI();
        }

        function switchWalletTab(tab) {
            document.querySelectorAll('.wallet-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.wallet-tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function updateSwapUI() {
            const fromCoin = getCoinData(currentSwapFrom);
            const toCoin = getCoinData(currentSwapTo);
            
            if (!fromCoin || !toCoin) return;
            
            document.getElementById('swapFromIcon').className = `coin-icon ${fromCoin.class}`;
            document.getElementById('swapFromIcon').textContent = fromCoin.name;
            document.getElementById('swapFromName').textContent = fromCoin.name;
            
            document.getElementById('swapToIcon').className = `coin-icon ${toCoin.class}`;
            document.getElementById('swapToIcon').textContent = toCoin.name;
            document.getElementById('swapToName').textContent = toCoin.name;
            
            const fromBalance = currentSwapFrom === 'usdt' ? userBalance : (cryptoBalances[currentSwapFrom] || 0);
            document.getElementById('swapFromBalance').textContent = fromBalance.toFixed(8) + ' ' + currentSwapFrom.toUpperCase();
        }

        function updateDepositUI() {
            const coin = getCoinData(currentDepositCrypto);
            if (!coin) return;
            
            document.getElementById('depositCryptoIcon').className = `coin-icon ${coin.class}`;
            document.getElementById('depositCryptoIcon').textContent = coin.name;
            document.getElementById('depositCryptoName').textContent = coin.name;
            document.getElementById('depositAddress').textContent = WALLET_ADDRESSES[currentDepositCrypto];
        }

        function updateWithdrawUI() {
            const coin = getCoinData(currentWithdrawCrypto);
            if (!coin) return;
            
            document.getElementById('withdrawCryptoIcon').className = `coin-icon ${coin.class}`;
            document.getElementById('withdrawCryptoIcon').textContent = coin.name;
            document.getElementById('withdrawCryptoName').textContent = coin.name;
            
            const balance = currentWithdrawCrypto === 'usdt' ? userBalance : (cryptoBalances[currentWithdrawCrypto] || 0);
            document.getElementById('withdrawAvailable').textContent = balance.toFixed(8) + ' ' + currentWithdrawCrypto.toUpperCase();
            document.getElementById('bankWithdrawAvailable').textContent = userBalance.toFixed(2);
        }

        function openCryptoList(target) {
            cryptoListTarget = target;
            
            const html = coins.map(coin => {
                return `
                    <div class="crypto-list-item" onclick="selectCrypto('${coin.name.toLowerCase()}')">
                        <div class="coin-icon ${coin.class}">${coin.name}</div>
                        <div>
                            <div style="font-weight: 600;">${coin.name}</div>
                            <div style="font-size: 12px; color: #888;">${coin.fullName}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('cryptoListContent').innerHTML = html;
            document.getElementById('cryptoListModal').classList.add('active');
        }

        function closeCryptoList() {
            document.getElementById('cryptoListModal').classList.remove('active');
        }

        function selectCrypto(crypto) {
            if (cryptoListTarget === 'swapFrom') {
                currentSwapFrom = crypto;
                updateSwapUI();
            } else if (cryptoListTarget === 'swapTo') {
                currentSwapTo = crypto;
                updateSwapUI();
            } else if (cryptoListTarget === 'deposit') {
                currentDepositCrypto = crypto;
                updateDepositUI();
            } else if (cryptoListTarget === 'withdraw') {
                currentWithdrawCrypto = crypto;
                updateWithdrawUI();
            }
            
            closeCryptoList();
            calculateSwapAmount();
        }

        function calculateSwapAmount() {
        }

        function fillMaxSwap() {
            const fromBalance = currentSwapFrom === 'usdt' ? userBalance : (cryptoBalances[currentSwapFrom] || 0);
            document.getElementById('swapAmount').value = fromBalance.toFixed(8);
            calculateSwapAmount();
        }

        function fillMaxWithdraw() {
            const balance = currentWithdrawCrypto === 'usdt' ? userBalance : (cryptoBalances[currentWithdrawCrypto] || 0);
            document.getElementById('withdrawAmount').value = balance.toFixed(8);
        }

        async function executeSwap() {
            const amount = parseFloat(document.getElementById('swapAmount').value);
            
            if (!amount || amount <= 0) {
                showNotification('⚠️ Please enter a valid amount');
                return;
            }

            const fromBalance = currentSwapFrom === 'usdt' ? userBalance : (cryptoBalances[currentSwapFrom] || 0);

            if (amount > fromBalance) {
                showNotification('⚠️ Insufficient balance');
                return;
            }

            try {
                const fromPrice = getCryptoPrice(currentSwapFrom);
                const toPrice = currentSwapTo === 'usdt' ? 1 : getCryptoPrice(currentSwapTo);
                
                const usdtValue = amount * fromPrice;
                const toAmount = usdtValue / toPrice;

                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const currentCryptoBalances = userDoc.data().cryptoBalances || {};
                const currentBalance = userDoc.data().balance || 0;

                if (currentSwapFrom === 'usdt') {
                    currentCryptoBalances[currentSwapTo] = (currentCryptoBalances[currentSwapTo] || 0) + toAmount;
                    await db.collection('users').doc(currentUser.uid).update({
                        balance: currentBalance - amount,
                        cryptoBalances: currentCryptoBalances
                    });
                } else if (currentSwapTo === 'usdt') {
                    currentCryptoBalances[currentSwapFrom] = (currentCryptoBalances[currentSwapFrom] || 0) - amount;
                    await db.collection('users').doc(currentUser.uid).update({
                        balance: currentBalance + toAmount,
                        cryptoBalances: currentCryptoBalances
                    });
                } else {
                    currentCryptoBalances[currentSwapFrom] = (currentCryptoBalances[currentSwapFrom] || 0) - amount;
                    currentCryptoBalances[currentSwapTo] = (currentCryptoBalances[currentSwapTo] || 0) + toAmount;
                    await db.collection('users').doc(currentUser.uid).update({
                        cryptoBalances: currentCryptoBalances
                    });
                }

                userBalance = currentBalance + (currentSwapTo === 'usdt' ? toAmount : 0) - (currentSwapFrom === 'usdt' ? amount : 0);
                cryptoBalances = currentCryptoBalances;

                showNotification(`✅ Swapped ${amount.toFixed(8)} ${currentSwapFrom.toUpperCase()} to ${toAmount.toFixed(8)} ${currentSwapTo.toUpperCase()}`);
                document.getElementById('swapAmount').value = '';
                
                openWalletDetail(currentSwapFrom);

            } catch (error) {
                console.error('Swap error:', error);
                showNotification('❌ Swap failed: ' + error.message);
            }
        }

        function copyDepositAddress() {
            const address = document.getElementById('depositAddress').textContent;
            navigator.clipboard.writeText(address).then(() => {
                showNotification('Address copied to clipboard!');
            });
        }

        function selectWithdrawMethod(method) {
            withdrawMethod = method;
            document.getElementById('cryptoWithdrawBtn').className = method === 'crypto' ? 'direction-btn' : 'direction-btn inactive';
            document.getElementById('cryptoWithdrawBtn').style = method === 'crypto' ? 'background: #4285f4; color: white;' : '';
            document.getElementById('bankWithdrawBtn').className = method === 'bank' ? 'direction-btn' : 'direction-btn inactive';
            document.getElementById('bankWithdrawBtn').style = method === 'bank' ? 'background: #4285f4; color: white;' : '';
            document.getElementById('cryptoWithdrawForm').classList.toggle('hidden', method !== 'crypto');
            document.getElementById('bankWithdrawForm').classList.toggle('hidden', method !== 'bank');
        }

        async function submitWithdrawal() {
            const address = document.getElementById('withdrawAddress').value.trim();
            const amount = parseFloat(document.getElementById('withdrawAmount').value);

            if (!address || !amount) {
                showNotification('⚠️ Please fill all fields');
                return;
            }

            if (amount < 50) {
                showNotification('⚠️ Minimum withdrawal amount is 50');
                return;
            }

            const availableBalance = currentWithdrawCrypto === 'usdt' ? userBalance : (cryptoBalances[currentWithdrawCrypto] || 0);

            if (amount > availableBalance) {
                showNotification('⚠️ Insufficient balance');
                return;
            }

            try {
                await db.collection('withdrawals').add({
                    userId: currentUser.uid,
                    userIdNumber: userId,
                    userName: userName,
                    userEmail: userEmail,
                    method: 'crypto',
                    crypto: currentWithdrawCrypto,
                    address: address,
                    amount: amount,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                await db.collection('transactions').add({
                    userId: currentUser.uid,
                    userIdNumber: userId,
                    type: 'withdrawal',
                    method: 'crypto',
                    crypto: currentWithdrawCrypto,
                    amount: amount,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showNotification('✅ Withdrawal request submitted! Your request is under review and will be processed within 24 working hours.');
                document.getElementById('withdrawAddress').value = '';
                document.getElementById('withdrawAmount').value = '';
            } catch (error) {
                showNotification('❌ Error: ' + error.message);
            }
        }

        async function submitBankWithdrawal() {
            const bankName = document.getElementById('bankName').value.trim();
            const accountNumber = document.getElementById('accountNumber').value.trim();
            const accountName = document.getElementById('accountName').value.trim();
            const amount = parseFloat(document.getElementById('bankWithdrawAmount').value);

            if (!bankName || !accountNumber || !accountName || !amount) {
                showNotification('⚠️ Please fill all fields');
                return;
            }

            if (amount < 50) {
                showNotification('⚠️ Minimum withdrawal amount is 50 USDT');
                return;
            }

            if (amount > userBalance) {
                showNotification('⚠️ Insufficient balance');
                return;
            }

            try {
                await db.collection('withdrawals').add({
                    userId: currentUser.uid,
                    userIdNumber: userId,
                    userName: userName,
                    userEmail: userEmail,
                    method: 'bank',
                    bankName: bankName,
                    accountNumber: accountNumber,
                    accountName: accountName,
                    amount: amount,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                await db.collection('transactions').add({
                    userId: currentUser.uid,
                    userIdNumber: userId,
                    type: 'withdrawal',
                    method: 'bank',
                    amount: amount,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showNotification('✅ Withdrawal request submitted! Your request is under review and will be processed within 24 working hours.');
                document.getElementById('bankName').value = '';
                document.getElementById('accountNumber').value = '';
                document.getElementById('accountName').value = '';
                document.getElementById('bankWithdrawAmount').value = '';
            } catch (error) {
                showNotification('❌ Error: ' + error.message);
            }
        }

        function openTrade(index) {
            selectedCoin = coins[index];
            document.getElementById('tradeModalTitle').textContent = `${selectedCoin.fullName}/USDT`;
            document.getElementById('availableBalance').textContent = userBalance.toFixed(2);
            document.getElementById('tradeAmount').value = '';
            document.getElementById('expectedProfit').textContent = '0.00';
            document.getElementById('timeFrame').value = '60';
            updateTimeFrameAndProfit();
            document.getElementById('tradeModal').classList.add('active');
            document.getElementById('executeTradeBtn').disabled = false;
            
            tradeDirection = 'up';
            document.getElementById('upBtn').className = 'direction-btn up';
            document.getElementById('downBtn').className = 'direction-btn down inactive';
        }

        function closeTradeModal() {
            document.getElementById('tradeModal').classList.remove('active');
        }

        function selectDirection(direction) {
            tradeDirection = direction;
            document.getElementById('upBtn').className = direction === 'up' ? 'direction-btn up' : 'direction-btn up inactive';
            document.getElementById('downBtn').className = direction === 'down' ? 'direction-btn down' : 'direction-btn down inactive';
        }

        function updateTimeFrameAndProfit() {
            const timeFrame = parseInt(document.getElementById('timeFrame').value);
            
            if (timeFrame === 60) selectedPercentage = 15;
            else if (timeFrame === 90) selectedPercentage = 25;
            else if (timeFrame === 120) selectedPercentage = 35;
            
            updateExpectedProfit();
        }

        function updateExpectedProfit() {
            const amount = parseFloat(document.getElementById('tradeAmount').value) || 0;
            const profit = amount * (selectedPercentage / 100);
            document.getElementById('expectedProfit').textContent = profit.toFixed(2);
        }

        async function executeTrade() {
            const amount = parseFloat(document.getElementById('tradeAmount').value);
            const timeFrame = parseInt(document.getElementById('timeFrame').value);
            const executeBtn = document.getElementById('executeTradeBtn');

            if (!amount || amount < 100) {
                showMessage('tradeMessage', 'Minimum trade amount is 100 USDT', 'error');
                return;
            }

            if (timeFrame === 90 && userBalance < 60000) {
                showMessage('tradeMessage', 'You need at least 60,000 USDT balance to trade with 90 seconds contract', 'error');
                return;
            }

            if (timeFrame === 120 && userBalance < 130000) {
                showMessage('tradeMessage', 'You need at least 130,000 USDT balance to trade with 120 seconds contract', 'error');
                return;
            }

            if (amount > userBalance) {
                showMessage('tradeMessage', 'Insufficient balance', 'error');
                return;
            }

            executeBtn.disabled = true;
            executeBtn.textContent = 'Processing...';

            try {
                const pendingTrades = await db.collection('trades')
                    .where('userId', '==', currentUser.uid)
                    .where('status', '==', 'pending')
                    .get();

                if (!pendingTrades.empty) {
                    showMessage('tradeMessage', 'Please wait for your current trade to finish', 'error');
                    executeBtn.disabled = false;
                    executeBtn.textContent = 'Execute Trade';
                    return;
                }

                const newBalance = userBalance - amount;
                await db.collection('users').doc(currentUser.uid).update({ balance: newBalance });

                await db.collection('trades').add({
                    userId: currentUser.uid,
                    userIdNumber: userId,
                    userName: userName,
                    userEmail: userEmail,
                    coin: selectedCoin.name,
                    coinFull: selectedCoin.fullName,
                    purchasePrice: selectedCoin.price,
                    amount: amount,
                    direction: tradeDirection,
                    percentage: selectedPercentage,
                    timeFrame: timeFrame,
                    status: 'pending',
                    result: null,
                    profit: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                userBalance = newBalance;
                
                showMessage('tradeMessage', `Trade executed! Wait ${timeFrame} seconds for result.`, 'success');
                showNotification(`✅ Trade started! ${timeFrame}s countdown...`);
                
                setTimeout(() => {
                    closeTradeModal();
                    executeBtn.disabled = false;
                    executeBtn.textContent = 'Execute Trade';
                }, 2000);

            } catch (error) {
                showMessage('tradeMessage', 'Trade failed: ' + error.message, 'error');
                executeBtn.disabled = false;
                executeBtn.textContent = 'Execute Trade';
            }
        }

        function openAccount() {
            toggleMenu();
            navigationStack = [];
            navigateToPage('accountPage');
        }

        function openOverview() {
            toggleMenu();
            navigationStack = [];
            navigateToPage('overviewPage');
            loadOverviewData();
        }

        function openHistory() {
            toggleMenu();
            navigationStack = [];
            navigateToPage('historyPage');
            loadHistoryData();
        }

        async function loadOverviewData() {
            try {
                const tradesSnapshot = await db.collection('trades')
                    .where('userId', '==', currentUser.uid)
                    .get();

                let totalTrades = 0;
                let wins = 0;
                let totalProfit = 0;
                let totalLoss = 0;

                tradesSnapshot.forEach(doc => {
                    const trade = doc.data();
                    if (trade.status === 'win' || trade.status === 'loss') {
                        totalTrades++;
                    }
                    if (trade.status === 'win') {
                        wins++;
                        totalProfit += trade.profit || 0;
                    } else if (trade.status === 'loss') {
                        totalLoss += trade.amount;
                    }
                });

                const winRate = totalTrades > 0 ? ((wins / totalTrades) * 100).toFixed(1) : 0;

                document.getElementById('totalTrades').textContent = totalTrades;
                document.getElementById('totalProfit').textContent = '$' + totalProfit.toFixed(2);
                document.getElementById('totalLoss').textContent = '$' + totalLoss.toFixed(2);
                document.getElementById('winRate').textContent = winRate + '%';

                const recentTrades = [];
                tradesSnapshot.forEach(doc => {
                    recentTrades.push({ id: doc.id, ...doc.data() });
                });
                recentTrades.sort((a, b) => {
                    const timeA = a.createdAt?.toMillis() || 0;
                    const timeB = b.createdAt?.toMillis() || 0;
                    return timeB - timeA;
                });

                const recentHtml = recentTrades.slice(0, 5).map(trade => {
                    const statusClass = trade.status === 'win' ? 'win' : trade.status === 'loss' ? 'loss' : 'pending';
                    return `
                        <div class="history-item ${statusClass}">
                            <div class="history-header">
                                <div>${trade.coinFull}/USDT</div>
                                <div>${trade.status.toUpperCase()}</div>
                            </div>
                            <div style="font-size: 13px; color: #666;">Amount: ${trade.amount.toFixed(2)} USDT</div>
                        </div>
                    `;
                }).join('');

                document.getElementById('recentActivity').innerHTML = recentHtml || '<div style="color: #888; padding: 20px; text-align: center;">No recent activity</div>';

            } catch (error) {
                console.error('Error loading overview:', error);
            }
        }

        async function loadHistoryData() {
            try {
                const tradesSnapshot = await db.collection('trades')
                    .where('userId', '==', currentUser.uid)
                    .get();

                const trades = [];
                tradesSnapshot.forEach(doc => {
                    trades.push({ id: doc.id, ...doc.data() });
                });

                trades.sort((a, b) => {
                    const timeA = a.createdAt?.toMillis() || 0;
                    const timeB = b.createdAt?.toMillis() || 0;
                    return timeB - timeA;
                });

                const now = Date.now();
                const tradeHtml = trades.map(trade => {
                    const statusClass = trade.status === 'win' ? 'win' : trade.status === 'loss' ? 'loss' : 'pending';
                    const dateStr = trade.createdAt ? new Date(trade.createdAt.toMillis()).toLocaleString() : 'N/A';
                    
                    let statusText = trade.status.toUpperCase();
                    if (trade.status === 'pending') {
                        const tradeTime = trade.createdAt?.toMillis() || 0;
                        const endTime = tradeTime + (trade.timeFrame * 1000);
                        const remainingMs = Math.max(0, endTime - now);
                        const remainingSec = Math.floor(remainingMs / 1000);
                        statusText = `${remainingSec}s`;
                    }
                    
                    const profitLossText = trade.status === 'win' ? 
                        `<div style="color: #4caf50; font-weight: 600; font-size: 13px;">+${trade.profit.toFixed(2)} USDT</div>` :
                        trade.status === 'loss' ?
                        `<div style="color: #f44336; font-weight: 600; font-size: 13px;">-${trade.amount.toFixed(2)} USDT</div>` : '';
                    
                    return `
                        <div class="history-item ${statusClass}" onclick="openTradeDetail('${trade.id}')">
                            <div class="history-header">
                                <div>${trade.coinFull}/USDT</div>
                                <div>${statusText}</div>
                            </div>
                            <div style="font-size: 13px; color: #666;">
                                Purchase Amount: ${trade.amount.toFixed(2)} USDT | ${trade.direction === 'up' ? 'Buy Up' : 'Buy Down'}
                            </div>
                            ${profitLossText}
                            <div style="font-size: 11px; color: #888; margin-top: 5px;">${dateStr}</div>
                        </div>
                    `;
                }).join('');

                document.getElementById('tradeHistory').innerHTML = tradeHtml || '<div style="color: #888; padding: 20px; text-align: center;">No trade history</div>';
            } catch (error) {
                console.error('Error loading trade history:', error);
            }

            try {
                const transSnapshot = await db.collection('transactions')
                    .where('userId', '==', currentUser.uid)
                    .where('type', 'in', ['deposit', 'withdrawal'])
                    .get();

                const transactions = [];
                transSnapshot.forEach(doc => {
                    transactions.push({ id: doc.id, ...doc.data() });
                });

                transactions.sort((a, b) => {
                    const timeA = a.createdAt?.toMillis() || 0;
                    const timeB = b.createdAt?.toMillis() || 0;
                    return timeB - timeA;
                });

                const transHtml = transactions.map(trans => {
                    const dateStr = trans.createdAt ? new Date(trans.createdAt.toMillis()).toLocaleString() : 'N/A';
                    let statusClass = 'deposit';
                    
                    if (trans.type === 'withdrawal') {
                        statusClass = trans.status === 'approved' ? 'win' : trans.status === 'rejected' ? 'loss' : 'pending';
                    }

                    const cryptoLabel = trans.crypto ? ` (${trans.crypto.toUpperCase()})` : '';
                    
                    return `
                        <div class="history-item ${statusClass}">
                            <div class="history-header">
                                <div>${trans.type.toUpperCase()}${cryptoLabel}</div>
                                <div>${trans.status.toUpperCase()}</div>
                            </div>
                            <div style="font-size: 13px; color: #666;">Amount: ${trans.amount.toFixed(2)} ${trans.crypto ? trans.crypto.toUpperCase() : 'USDT'}</div>
                            <div style="font-size: 11px; color: #888; margin-top: 5px;">${dateStr}</div>
                        </div>
                    `;
                }).join('');

                document.getElementById('transactionHistory').innerHTML = transHtml || '<div style="color: #888; padding: 20px; text-align: center;">No transaction history</div>';
            } catch (error) {
                console.error('Error loading transaction history:', error);
            }
        }

        async function openTradeDetail(tradeId) {
            if (tradeDetailInterval) {
                clearInterval(tradeDetailInterval);
                tradeDetailInterval = null;
            }

            const tradeDoc = await db.collection('trades').doc(tradeId).get();
            if (!tradeDoc.exists) return;

            const trade = tradeDoc.data();
            
            const renderTradeDetail = async () => {
                const currentTradeDoc = await db.collection('trades').doc(tradeId).get();
                if (!currentTradeDoc.exists) return;
                
                const currentTrade = currentTradeDoc.data();
                const tradeTime = currentTrade.createdAt?.toMillis() || 0;
                const endTime = tradeTime + (currentTrade.timeFrame * 1000);
                const now = Date.now();
                const remainingMs = Math.max(0, endTime - now);
                const remainingSec = Math.floor(remainingMs / 1000);
                
                const purchaseTimeStr = new Date(tradeTime).toLocaleString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }).replace(/\//g, '/').replace(',', ',');
                const deliveryTimeStr = new Date(endTime).toLocaleString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }).replace(/\//g, '/').replace(',', ',');

                document.getElementById('detailCoinName').textContent = `${currentTrade.coinFull}/USDT`;

                let resultHtml;
                if (currentTrade.status === 'pending' && remainingSec > 0) {
                    resultHtml = `<div class="detail-row">
                        <div class="detail-label">Countdown</div>
                        <div class="detail-value" style="color: #ff9800; font-size: 24px; font-weight: bold;">${remainingSec}s</div>
                    </div>`;
                } else if (currentTrade.status === 'win') {
                    resultHtml = `<div class="detail-row">
                        <div class="detail-label">Result</div>
                        <div class="result-win">WIN +${currentTrade.profit.toFixed(2)} USDT</div>
                    </div>`;
                    if (tradeDetailInterval) {
                        clearInterval(tradeDetailInterval);
                        tradeDetailInterval = null;
                    }
                } else if (currentTrade.status === 'loss') {
                    resultHtml = `<div class="detail-row">
                        <div class="detail-label">Result</div>
                        <div class="result-loss">LOSS -${currentTrade.amount.toFixed(2)} USDT</div>
                    </div>`;
                    if (tradeDetailInterval) {
                        clearInterval(tradeDetailInterval);
                        tradeDetailInterval = null;
                    }
                } else {
                    resultHtml = `<div class="detail-row">
                        <div class="detail-label">Status</div>
                        <div class="detail-value" style="color: #ff9800;">PENDING</div>
                    </div>`;
                }

                document.getElementById('tradeDetailContent').innerHTML = `
                    <div class="detail-row">
                        <div class="detail-label">Purchase Amount</div>
                        <div class="detail-value">${currentTrade.amount.toFixed(2)} USDT</div>
                    </div>
                    ${resultHtml}
                    <div class="detail-row">
                        <div class="detail-label">Purchase Price</div>
                        <div class="detail-value">${currentTrade.purchasePrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 8})}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Direction</div>
                        <div class="detail-value" style="color: ${currentTrade.direction === 'up' ? '#4caf50' : '#f44336'};">${currentTrade.direction === 'up' ? 'Buy Up' : 'Buy Down'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Contract Time</div>
                        <div class="detail-value">${currentTrade.timeFrame} Seconds</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Profit Rate</div>
                        <div class="detail-value">${currentTrade.percentage}%</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Purchase Time</div>
                        <div class="detail-value">${purchaseTimeStr}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Delivery Time</div>
                        <div class="detail-value">${deliveryTimeStr}</div>
                    </div>
                `;
            };

            await renderTradeDetail();
            
            document.getElementById('tradeDetailModal').classList.add('active');
            
            if (trade.status === 'pending') {
                tradeDetailInterval = setInterval(async () => {
                    await renderTradeDetail();
                }, 1000);
            }
        }

        function closeTradeDetail() {
            if (tradeDetailInterval) {
                clearInterval(tradeDetailInterval);
                tradeDetailInterval = null;
            }
            document.getElementById('tradeDetailModal').classList.remove('active');
        }

        function openChangePassword() {
            document.getElementById('changePasswordModal').classList.add('active');
        }

        function closeChangePassword() {
            document.getElementById('changePasswordModal').classList.remove('active');
        }

        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (!currentPassword || !newPassword || !confirmNewPassword) {
                showMessage('changePasswordMessage', 'Please fill all fields', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showMessage('changePasswordMessage', 'New password must be at least 6 characters', 'error');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showMessage('changePasswordMessage', 'New passwords do not match', 'error');
                return;
            }

            try {
                const user = auth.currentUser;
                const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);

                await user.reauthenticateWithCredential(credential);
                await user.updatePassword(newPassword);

                showMessage('changePasswordMessage', 'Password changed successfully!', 'success');
                setTimeout(() => {
                    closeChangePassword();
                }, 2000);
            } catch (error) {
                showMessage('changePasswordMessage', error.message, 'error');
            }
        }

        function openNotifications() {
            showNotification('No new notifications');
        }

        function openChat() {
            toggleMenu();
            document.getElementById('chatModal').classList.add('active');
            loadChatMessages();
        }

        function closeChat() {
            document.getElementById('chatModal').classList.remove('active');
            if (chatListener) {
                chatListener();
                chatListener = null;
            }
        }

        function loadChatMessages() {
            const chatMessages = document.getElementById('chatMessages');
            
            if (chatListener) {
                chatListener();
                chatListener = null;
            }
            
            chatListener = db.collection('chats')
                .where('userId', '==', currentUser.uid)
                .onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        chatMessages.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No messages yet</div>';
                        return;
                    }

                    const messages = [];
                    snapshot.forEach(doc => {
                        messages.push({ id: doc.id, ...doc.data() });
                    });
                    
                    messages.sort((a, b) => {
                        const timeA = a.timestamp?.toMillis() || 0;
                        const timeB = b.timestamp?.toMillis() || 0;
                        return timeA - timeB;
                    });

                    let html = '';
                    messages.forEach(msg => {
                        const isUser = msg.senderType === 'user';
                        const time = msg.timestamp ? new Date(msg.timestamp.toMillis()).toLocaleTimeString() : '';
                        
                        html += `
                            <div style="margin-bottom: 15px; text-align: ${isUser ? 'right' : 'left'};">
                                <div style="display: inline-block; max-width: 70%; padding: 10px 15px; border-radius: 12px; background: ${isUser ? '#4285f4' : '#e0e0e0'}; color: ${isUser ? '#fff' : '#333'}; text-align: left;">
                                    <div style="font-weight: 600; font-size: 11px; margin-bottom: 5px; opacity: 0.8;">${isUser ? 'You' : 'Support'}</div>
                                    <div>${msg.message}</div>
                                    <div style="font-size: 9px; margin-top: 5px; opacity: 0.7;">${time}</div>
                                </div>
                            </div>
                        `;
                    });

                    chatMessages.innerHTML = html;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            try {
                await db.collection('chats').add({
                    userId: currentUser.uid,
                    userIdNumber: userId,
                    userName: userName,
                    userEmail: userEmail,
                    message: message,
                    senderType: 'user',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false
                });

                input.value = '';
            } catch (error) {
                showNotification('❌ Failed to send message');
            }
        }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('mainApp').classList.add('active');
            } else {
                currentUser = null;
                document.getElementById('authContainer').style.display = 'flex';
                document.getElementById('mainApp').classList.remove('active');
                if (tradeCheckInterval) clearInterval(tradeCheckInterval);
                if (tradeDetailInterval) clearInterval(tradeDetailInterval);
            }
        });
    </script>
</body>
</html>
