<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hibt - Trading Platform</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8f9fa; }
    
    .auth-container { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
    .auth-box { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); width: 90%; max-width: 400px; }
    .auth-title { font-size: 24px; font-weight: 600; margin-bottom: 30px; text-align: center; }
    .input-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; }
    input, select { width: 100%; padding: 15px; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 16px; }
    input:focus, select:focus { outline: none; border-color: #667eea; }
    .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 20px; }
    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover { background: #5a67d8; }
    .switch-text { margin-top: 20px; color: #6c757d; text-align: center; }
    .switch-link { color: #667eea; cursor: pointer; text-decoration: underline; }
    .message { padding: 10px; border-radius: 8px; margin-bottom: 15px; font-weight: 500; }
    .error { background: #fee; color: #c33; border: 1px solid #fcc; }
    .success { background: #efe; color: #363; border: 1px solid #cfc; }
    .hidden { display: none; }
    
    .dashboard { display: none; min-height: 100vh; }
    .dashboard.active { display: block; }
    .header { background: linear-gradient(135deg, #4285f4 0%, #3367d6 100%); color: white; padding: 20px; }
    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .brand { font-size: 36px; font-weight: bold; }
    .user-info-box { background: rgba(255,255,255,0.2); padding: 15px; border-radius: 12px; margin-top: 15px; }
    .user-id { font-size: 14px; opacity: 0.9; margin-bottom: 5px; }
    .user-name { font-size: 18px; font-weight: 600; margin-bottom: 10px; }
    .balance-display { font-size: 32px; font-weight: bold; margin: 10px 0; }
    .btn-group { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .btn-small { padding: 8px 16px; background: rgba(255,255,255,0.2); border: none; border-radius: 20px; color: white; cursor: pointer; font-size: 14px; }
    .btn-small:hover { background: rgba(255,255,255,0.3); }

    .market-section { padding: 20px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .section-title { font-size: 24px; font-weight: bold; }
    .coin-list { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .coin-item { display: flex; align-items: center; padding: 16px 20px; border-bottom: 1px solid #f1f3f4; cursor: pointer; }
    .coin-item:hover { background: #f8f9fb; }
    .coin-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 15px; font-size: 14px; }
    .coin-info { flex: 1; }
    .coin-name { font-weight: 600; font-size: 16px; }
    .coin-price { text-align: right; font-weight: 600; font-size: 16px; }
    .btc { background: #f7931a; }
    .eth { background: #627eea; }
    .xrp { background: #23292f; }
    .doge { background: #c2a633; }
    .ada { background: #0033ad; }
    .bnb { background: #f3ba2f; }
    .sol { background: #9945FF; }
    .link { background: #375BD2; }
    .dot { background: #E6007A; }
    .ltc { background: #345D9D; }
  </style>
</head>

<body>
  <div class="auth-container" id="authContainer">
    <div class="auth-box">
      <div id="registerForm">
        <h2 class="auth-title">Create Account</h2>
        <div id="authMessage"></div>
        <div class="input-group">
          <label>Full Name</label>
          <input type="text" id="regName" placeholder="Enter your name">
        </div>
        <div class="input-group">
          <label>Email</label>
          <input type="email" id="regEmail" placeholder="Enter email">
        </div>
        <div class="input-group">
          <label>Password</label>
          <input type="password" id="regPassword" placeholder="Enter password">
        </div>
        <button class="btn btn-primary" onclick="register()">Register</button>
        <div class="switch-text">
          Already have an account? <span class="switch-link" onclick="showLogin()">Sign In</span>
        </div>
      </div>

      <div id="loginForm" class="hidden">
        <h2 class="auth-title">Sign In</h2>
        <div id="loginMessage"></div>
        <div class="input-group">
          <label>Email</label>
          <input type="email" id="loginEmail" placeholder="Enter email">
        </div>
        <div class="input-group">
          <label>Password</label>
          <input type="password" id="loginPassword" placeholder="Enter password">
        </div>
        <button class="btn btn-primary" onclick="login()">Sign In</button>
        <div class="switch-text">
          <span class="switch-link" onclick="forgotPassword()">Forgot Password?</span>
        </div>
        <div class="switch-text">
          Don't have an account? <span class="switch-link" onclick="showRegister()">Register</span>
        </div>
      </div>
    </div>
  </div>

  <div class="dashboard" id="dashboard">
    <div class="header">
      <div class="header-top">
        <div class="brand">Hibt</div>
        <button class="btn-small" onclick="logout()">Logout</button>
      </div>
      <div class="user-info-box">
        <div class="user-id">ID: <span id="userId"></span></div>
        <div class="user-name" id="userName"></div>
        <div class="balance-display">
          <span id="userBalance">0.00</span> USDT
          <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">Available Balance</div>
        </div>
        <div class="btn-group">
          <button class="btn-small" onclick="openProfile()">Profile</button>
          <button class="btn-small" onclick="openHistory()">My Contract</button>
          <button class="btn-small" onclick="openDeposit()">Deposit</button>
          <button class="btn-small" onclick="openAnalytics()">Analytics</button>
        </div>
      </div>
    </div>
    <!-- Market Section continues -->
    <div class="market-section">
      <div class="section-header">
        <h2 class="section-title">Markets</h2>
      </div>
      <div class="coin-list" id="coinList"></div>
    </div>
  </div>

  <!-- Trading Modal -->
  <div class="modal" id="tradingModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Trade</h2>
        <button class="close-btn" onclick="closeTradeModal()">&times;</button>
      </div>
      <div id="tradeMessage"></div>

      <div class="trade-section">
        <div class="trade-label">Direction</div>
        <div class="direction-btns">
          <button class="direction-btn up" id="upBtn" onclick="selectDirection('up')">Buy Up</button>
          <button class="direction-btn down inactive" id="downBtn" onclick="selectDirection('down')">Buy Down</button>
        </div>
      </div>

      <div class="trade-section">
        <div class="trade-label">Profit Percentage (Auto-set by time)</div>
        <div class="percentage-btns">
          <button class="percentage-btn active" id="profit15" disabled>15%</button>
          <button class="percentage-btn" id="profit25" disabled>25%</button>
          <button class="percentage-btn" id="profit35" disabled>35%</button>
        </div>
        <div class="info-text">Profit percentage auto-adjusts with time frame</div>
      </div>

      <div class="trade-section">
        <div class="trade-label">Amount (USDT)</div>
        <input type="number" class="trade-input" id="tradeAmount" placeholder="Enter amount (min 100 USDT)" min="100" oninput="updateExpectedProfit()">
        <div class="info-text">Available: <span id="availableBalance">0.00</span> USDT</div>
        <div class="info-text">Expected Profit: <span id="expectedProfit">0.00</span> USDT</div>
      </div>

      <div class="trade-section">
        <div class="trade-label">Contract Time</div>
        <select class="trade-input" id="timeFrame" onchange="updateTimeFrameAndProfit()">
          <option value="60">60 Seconds (15% Profit)</option>
          <option value="90">90 Seconds (25% Profit) - Requires 100K+ Balance</option>
          <option value="120">2 Minutes (35% Profit) - Requires 500K+ Balance</option>
        </select>
        <div class="info-text" id="timeFrameWarning" style="color: #f44336; display: none;">Insufficient balance for this timeframe</div>
      </div>

      <button class="trade-btn" onclick="executeTrade()">Execute Trade</button>
    </div>
  </div>

  <!-- History Modal -->
  <div class="modal" id="historyModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">My Contract</h2>
        <button class="close-btn" onclick="closeHistory()">&times;</button>
      </div>

      <div class="tab-container">
        <button class="tab active" id="waitTab" onclick="switchHistoryTab('wait')">Wait</button>
        <button class="tab" id="finishedTab" onclick="switchHistoryTab('finished')">Finished</button>
      </div>

      <div class="history-list" id="historyList"></div>
    </div>
  </div>

  <!-- Trade Detail Modal -->
  <div class="modal" id="tradeDetailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="detailCoinName">BTC/USDT</h2>
        <button class="close-btn" onclick="closeTradeDetail()">&times;</button>
      </div>
      <div id="tradeDetailContent"></div>
    </div>
  </div>

  <script>
    // --- Trade Handling and Fixed History Logic ---

    function openTrade(index) {
      selectedCoin = coins[index];
      document.getElementById('modalTitle').textContent = `Trade ${selectedCoin.fullName}`;
      document.getElementById('availableBalance').textContent = userBalance.toFixed(2);
      document.getElementById('tradeAmount').value = '';
      document.getElementById('expectedProfit').textContent = '0.00';
      document.getElementById('timeFrame').value = '60';
      updateTimeFrameAndProfit();
      document.getElementById('tradingModal').classList.add('active');
      tradeDirection = 'up';
      document.getElementById('upBtn').className = 'direction-btn up';
      document.getElementById('downBtn').className = 'direction-btn down inactive';
    }

    function executeTrade() {
      const amount = parseFloat(document.getElementById('tradeAmount').value);
      const timeFrame = parseInt(document.getElementById('timeFrame').value);

      if (!amount || amount < 100) {
        showMessage('tradeMessage', 'Minimum trade amount is 100 USDT', 'error');
        return;
      }
      if (amount > userBalance) {
        showMessage('tradeMessage', 'Insufficient balance', 'error');
        return;
      }

      db.collection('trades').add({
        userId: currentUser.uid,
        userIdNumber: userId,
        userName: userName,
        userEmail: currentUser.email,
        coin: selectedCoin.name,
        coinFull: selectedCoin.fullName,
        amount: amount,
        direction: tradeDirection,
        percentage: selectedPercentage,
        timeFrame: timeFrame,
        status: 'pending',
        profit: 0,
        result: null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        db.collection('users').doc(currentUser.uid).update({
          balance: userBalance - amount
        });
        showMessage('tradeMessage', 'Trade executed successfully!', 'success');
        setTimeout(closeTradeModal, 2000);
      }).catch(err => {
        showMessage('tradeMessage', 'Error: ' + err.message, 'error');
      });
    }

    function switchHistoryTab(tab) {
      historyFilter = tab;
      document.getElementById('waitTab').classList.toggle('active', tab === 'wait');
      document.getElementById('finishedTab').classList.toggle('active', tab === 'finished');
      loadTradeHistory();
    }

    async function loadTradeHistory() {
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = '<div style="text-align:center; padding:20px;">Loading...</div>';

      const trades = await db.collection('trades')
        .where('userId', '==', currentUser.uid)
        .orderBy('createdAt', 'desc')
        .get();

      const now = Date.now();
      const waitList = [];
      const finishedList = [];

      trades.forEach(doc => {
        const trade = doc.data();
        const id = doc.id;
        if (!trade.createdAt) return;
        const tradeTime = trade.createdAt.toMillis();
        const endTime = tradeTime + (trade.timeFrame * 1000);
        const expired = now >= endTime;
        if (trade.status === 'pending' && !expired) waitList.push({ id, ...trade });
        else if (trade.status === 'win' || trade.status === 'loss' || expired) finishedList.push({ id, ...trade });
      });

      const renderTradeItem = (trade, isWait) => {
        const color = trade.direction === 'up' ? '#4caf50' : '#f44336';
        if (isWait) {
          return `
            <div class="history-item wait">
              <div class="history-header">
                <div class="history-coin">${trade.coinFull}/USDT</div>
                <div class="history-time">${new Date(trade.createdAt.toMillis()).toLocaleString()}</div>
              </div>
              <div>Amount: ${trade.amount.toFixed(2)} | Direction: <span style="color:${color};">${trade.direction.toUpperCase()}</span></div>
              <div class="countdown">Waiting...</div>
            </div>`;
        } else {
          const isWin = trade.status === 'win';
          const profitValue = isWin ? `+${trade.profit.toFixed(2)} USDT` : `-${trade.amount.toFixed(2)} USDT`;
          const profitClass = isWin ? 'history-profit' : 'history-loss';
          return `
            <div class="history-item finished ${isWin ? 'win' : 'loss'}">
              <div class="history-header">
                <div class="history-coin">${trade.coinFull}/USDT</div>
                <div class="history-time">${new Date(trade.createdAt.toMillis()).toLocaleString()}</div>
              </div>
              <div>Amount: ${trade.amount.toFixed(2)} | Direction: <span style="color:${color};">${trade.direction.toUpperCase()}</span></div>
              <div class="${profitClass}">${isWin ? 'WIN' : 'LOSS'} â€” ${profitValue}</div>
            </div>`;
        }
      };

      const displayList = historyFilter === 'wait' ? waitList : finishedList;
      if (displayList.length === 0) {
        historyList.innerHTML = `<div style="text-align:center; padding:20px; color:#666;">No contracts</div>`;
        return;
      }

      historyList.innerHTML = displayList.map(t => renderTradeItem(t, historyFilter === 'wait')).join('');
    }
  </script>
  <!-- Profile Modal -->
  <div class="modal" id="profileModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Profile</h2>
        <button class="close-btn" onclick="closeProfile()">&times;</button>
      </div>
      <div style="text-align:center; padding:20px;">
        <div style="font-size:18px; margin-bottom:5px;">UID: <span id="profileUserId"></span></div>
        <div style="font-size:16px; font-weight:600;" id="profileUserName"></div>
        <button class="btn btn-primary" onclick="openDeposit()">Deposit</button>
        <div style="margin-top:25px; border-top:1px solid #ddd; padding-top:15px;">
          <div style="padding:10px; background:#f8f9fa; border-radius:8px; margin-bottom:10px;" onclick="openChat()">Contact Support</div>
          <div style="padding:10px; background:#f8f9fa; border-radius:8px;" onclick="openChangePassword()">Change Password</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Modal -->
  <div class="modal" id="chatModal">
    <div class="modal-content" style="max-width:600px; height:600px; display:flex; flex-direction:column;">
      <div class="modal-header">
        <h2 class="modal-title">Support Chat</h2>
        <button class="close-btn" onclick="closeChat()">&times;</button>
      </div>
      <div id="chatMessages" style="flex:1; overflow-y:auto; padding:15px; background:#f8f9fa; border-radius:12px; margin-bottom:15px;">
        <div style="text-align:center; color:#666; padding:20px;">Loading messages...</div>
      </div>
      <div style="display:flex; gap:10px;">
        <input type="text" id="chatInput" placeholder="Type your message..." style="flex:1; padding:12px; border:2px solid #e9ecef; border-radius:12px;" onkeypress="if(event.key==='Enter') sendMessage()">
        <button class="btn btn-primary" style="width:auto; padding:12px 24px; margin:0;" onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDWQBTrvvxCL5Qd23iSMTQlWkaPKZgjhqw",
      authDomain: "trading-dapp-d5aa4.firebaseapp.com",
      projectId: "trading-dapp-d5aa4",
      storageBucket: "trading-dapp-d5aa4.firebasestorage.app",
      messagingSenderId: "690266747119",
      appId: "1:690266747119:web:0f22d45fbee53ee3c3eb1a"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let chatListener = null;

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        showDashboard();
        loadUserData();
      } else {
        showAuth();
      }
    });

    async function loadUserData() {
      const userDoc = await db.collection('users').doc(currentUser.uid).get();
      if (userDoc.exists) {
        const data = userDoc.data();
        document.getElementById('userName').textContent = data.name;
        document.getElementById('userId').textContent = data.userId;
        document.getElementById('userBalance').textContent = (data.balance || 0).toFixed(2);
      }
    }

    function showDashboard() {
      document.getElementById('authContainer').style.display = 'none';
      document.getElementById('dashboard').classList.add('active');
      renderCoins();
    }

    function showAuth() {
      document.getElementById('authContainer').style.display = 'flex';
      document.getElementById('dashboard').classList.remove('active');
    }

    function logout() {
      if (chatListener) chatListener();
      auth.signOut();
    }

    // --- Chat System ---
    function openChat() {
      document.getElementById('chatModal').classList.add('active');
      loadChatMessages();
    }

    function closeChat() {
      document.getElementById('chatModal').classList.remove('active');
      if (chatListener) chatListener();
    }

    function sendMessage() {
      const messageInput = document.getElementById('chatInput');
      const text = messageInput.value.trim();
      if (!text) return;
      messageInput.value = '';
      db.collection('chats').add({
        userId: currentUser.uid,
        sender: 'user',
        message: text,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    function loadChatMessages() {
      const chatContainer = document.getElementById('chatMessages');
      chatContainer.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">Loading messages...</div>';

      if (chatListener) chatListener();

      chatListener = db.collection('chats')
        .where('userId', '==', currentUser.uid)
        .orderBy('timestamp', 'asc')
        .onSnapshot(snapshot => {
          if (snapshot.empty) {
            chatContainer.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">Start the conversation with support.</div>';
            return;
          }
          chatContainer.innerHTML = '';
          snapshot.forEach(doc => {
            const chat = doc.data();
            const isUser = chat.sender === 'user';
            const msgDiv = document.createElement('div');
            msgDiv.style.textAlign = isUser ? 'right' : 'left';
            msgDiv.innerHTML = `
              <div style="
                display:inline-block;
                background:${isUser ? '#4285f4' : '#e9ecef'};
                color:${isUser ? 'white' : '#333'};
                padding:10px 15px;
                border-radius:12px;
                margin:5px 0;
                max-width:80%;
                word-wrap:break-word;
              ">${chat.message}</div>`;
            chatContainer.appendChild(msgDiv);
          });
          chatContainer.scrollTop = chatContainer.scrollHeight;
        });
    }

    // --- Utility Functions ---
    function showMessage(id, msg, type) {
      const el = document.getElementById(id);
      if (!el) return;
      el.innerHTML = `<div class="message ${type}">${msg}</div>`;
      setTimeout(() => { el.innerHTML = ''; }, 3000);
    }

    function showLogin() {
      document.getElementById('registerForm').classList.add('hidden');
      document.getElementById('loginForm').classList.remove('hidden');
    }

    function showRegister() {
      document.getElementById('registerForm').classList.remove('hidden');
      document.getElementById('loginForm').classList.add('hidden');
    }

    function renderCoins() {
      const list = document.getElementById('coinList');
      list.innerHTML = coins.map((coin, i) => `
        <div class="coin-item" onclick="openTrade(${i})">
          <div class="coin-icon ${coin.class}">${coin.name}</div>
          <div class="coin-info">
            <div class="coin-name">${coin.fullName}</div>
          </div>
          <div class="coin-price">${coin.price.toLocaleString()}</div>
        </div>`).join('');
    }
  </script>
</body>
</html>
