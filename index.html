<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hibt - Trading Platform</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: #f5f5f5;
            overflow-x: hidden;
        }
        
        /* Auth Container */
        .auth-container { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 20px; 
        }
        .auth-box { 
            background: white; 
            border-radius: 20px; 
            padding: 40px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
            width: 90%; 
            max-width: 400px; 
        }
        .auth-title { 
            font-size: 24px; 
            font-weight: 600; 
            margin-bottom: 30px; 
            text-align: center; 
            color: #333;
        }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; }
        input, select { 
            width: 100%; 
            padding: 15px; 
            border: 2px solid #e1e5e9; 
            border-radius: 12px; 
            font-size: 16px; 
        }
        input:focus, select:focus { outline: none; border-color: #667eea; }
        .btn { 
            width: 100%; 
            padding: 15px; 
            border: none; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            margin-top: 20px; 
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover:not(:disabled) { background: #5a67d8; }
        .switch-text { margin-top: 20px; color: #6c757d; text-align: center; }
        .switch-link { color: #667eea; cursor: pointer; text-decoration: underline; }
        .message { padding: 10px; border-radius: 8px; margin-bottom: 15px; font-weight: 500; }
        .error { background: #fee; color: #c33; border: 1px solid #fcc; }
        .success { background: #efe; color: #363; border: 1px solid #cfc; }
        .hidden { display: none; }
        
        /* Main App */
        .app { display: none; min-height: 100vh; background: #f5f5f5; }
        .app.active { display: block; }
        
        /* Header Banner */
        .header-banner {
            background: linear-gradient(135deg, #4285f4 0%, #1e3c72 100%);
            padding: 30px 20px;
            color: white;
            position: relative;
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .brand { font-size: 28px; font-weight: bold; }
        .header-icons {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .icon-btn {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            border: none;
            color: white;
        }
        .icon-btn:active { background: rgba(255,255,255,0.3); }
        
        /* Total Assets Section */
        .total-assets-section {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
        }
        .total-assets-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        .total-assets-amount {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .total-assets-value {
            font-size: 32px;
            font-weight: bold;
        }
        .eye-icon {
            cursor: pointer;
            font-size: 24px;
            opacity: 0.8;
        }
        .eye-icon:active {
            opacity: 1;
        }
        
        .tagline {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        .logo-box {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #a8ff78 0%, #78ffd6 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin-left: auto;
        }
        
        /* Market Section */
        .market-section {
            padding: 20px;
        }
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }
        .coin-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .coin-card {
            background: white;
            border-radius: 16px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .coin-card:active { transform: scale(0.98); }
        .coin-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 16px;
        }
        .coin-info {
            flex: 1;
        }
        .coin-name {
            font-weight: 600;
            font-size: 15px;
            color: #333;
        }
        .coin-symbol {
            font-size: 12px;
            color: #888;
            margin-top: 2px;
        }
        .coin-graph {
            width: 60px;
            height: 30px;
        }
        .coin-price-info {
            text-align: right;
        }
        .coin-price {
            font-weight: 600;
            font-size: 15px;
            color: #333;
        }
        .coin-change {
            font-size: 11px;
            margin-top: 2px;
        }
        .coin-change.positive { color: #4caf50; }
        .coin-change.negative { color: #f44336; }
        .coin-time {
            font-size: 10px;
            color: #888;
            margin-top: 2px;
        }
        
        /* Side Menu */
        .side-menu {
            position: fixed;
            left: -100%;
            top: 0;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: left 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        .side-menu.active { left: 0; }
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 999;
        }
        .menu-overlay.active { display: block; }
        .menu-header {
            padding: 30px 20px;
            background: linear-gradient(135deg, #4285f4 0%, #1e3c72 100%);
            color: white;
        }
        .menu-title {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        .menu-user-id {
            font-size: 20px;
            font-weight: bold;
        }
        .menu-list {
            padding: 10px 0;
        }
        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.2s;
            color: #333;
        }
        .menu-item:hover { background: #f5f5f5; }
        .menu-item:active { background: #e8e8e8; }
        .menu-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #4285f4;
        }
        .menu-text {
            font-size: 15px;
            font-weight: 500;
        }
        
        /* Pages */
        .page {
            display: none;
            min-height: 100vh;
            background: #f5f5f5;
            padding-bottom: 20px;
        }
        .page.active { display: block; }
        .page-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: #f5f5f5;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
        }
        .back-btn:active { background: #e8e8e8; }
        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }
        .page-content {
            padding: 20px;
        }
        
        /* Wallet Page */
        .wallet-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .wallet-item {
            background: white;
            border-radius: 16px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .wallet-item:active { transform: scale(0.98); }
        .wallet-info {
            flex: 1;
        }
        .wallet-name {
            font-weight: 600;
            font-size: 15px;
            color: #333;
        }
        .wallet-symbol {
            font-size: 12px;
            color: #888;
            margin-top: 2px;
        }
        .wallet-balance {
            text-align: right;
        }
        .wallet-usd {
            font-weight: 600;
            font-size: 15px;
            color: #333;
        }
        .wallet-crypto {
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }
        
        /* Wallet Detail Page */
        .balance-card {
            background: linear-gradient(135deg, #4285f4 0%, #1e3c72 100%);
            border-radius: 20px;
            padding: 25px;
            color: white;
            margin-bottom: 20px;
        }
        .balance-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        .balance-amount {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .balance-crypto {
            font-size: 14px;
            opacity: 0.8;
        }
        .action-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .action-tab {
            flex: 1;
            padding: 12px;
            background: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .action-tab.active {
            background: #4285f4;
            color: white;
        }
        .action-tab:not(.active):active {
            background: #e8e8e8;
        }
        
        /* Swap Form */
        .swap-form {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }
        .coin-select {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 12px;
            cursor: pointer;
        }
        .coin-select:active { background: #e8e8e8; }
        .swap-arrow-container {
            display: flex;
            justify-content: center;
            margin: -10px 0;
            position: relative;
            z-index: 1;
        }
        .swap-arrow-btn {
            width: 40px;
            height: 40px;
            background: #4285f4;
            border: 4px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: white;
            transition: all 0.3s;
        }
        .swap-arrow-btn:active {
            transform: rotate(180deg);
            background: #1e3c72;
        }
        .amount-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
        }
        .amount-input:focus {
            outline: none;
            border-color: #4285f4;
        }
        .max-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 10px;
        }
        .max-btn:active {
            background: #1e3c72;
        }
        .available-text {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
        }
        .fee-text {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }
        .submit-btn:active {
            background: #1e3c72;
        }
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Contract Buttons */
        .contract-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .contract-btn {
            padding: 15px;
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .contract-btn.active {
            background: #4285f4;
            color: white;
            border-color: #4285f4;
        }
        .contract-btn:not(.active):not(:disabled):active {
            background: #f5f5f5;
        }
        .contract-btn:disabled {
            background: #f5f5f5;
            color: #ccc;
            border-color: #e1e5e9;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        /* Trade Buttons */
        .trade-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .trade-btn {
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .trade-btn.buy {
            background: #4caf50;
            color: white;
        }
        .trade-btn.buy:active {
            background: #388e3c;
        }
        .trade-btn.sell {
            background: #f44336;
            color: white;
        }
        .trade-btn.sell:active {
            background: #d32f2f;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }
        .close-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f5f5f5;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }
        .close-btn:active { background: #e8e8e8; }
        
        /* History */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .history-item {
            background: white;
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
        }
        .history-item:active {
            background: #f5f5f5;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .history-type {
            font-weight: 600;
            font-size: 15px;
            color: #333;
        }
        .history-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-win {
            background: #e8f5e9;
            color: #4caf50;
        }
        .status-loss {
            background: #ffebee;
            color: #f44336;
        }
        .status-pending {
            background: #fff3e0;
            color: #ff9800;
        }
        .history-details {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }
        
        /* Detail Modal */
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .detail-row:last-child {
            border-bottom: none;
        }
        .detail-label {
            color: #666;
            font-size: 14px;
        }
        .detail-value {
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }
        .result-win {
            color: #4caf50;
            font-weight: 600;
            font-size: 16px;
        }
        .result-loss {
            color: #f44336;
            font-weight: 600;
            font-size: 16px;
        }
        
        /* Chat */
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        .chat-input-area {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 15px;
            resize: none;
            font-family: inherit;
            max-height: 100px;
        }
        .chat-input:focus {
            outline: none;
            border-color: #4285f4;
        }
        .file-upload-btn {
            width: 44px;
            height: 44px;
            background: #4285f4;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .file-upload-btn:active {
            background: #1e3c72;
        }
        .send-btn {
            width: 44px;
            height: 44px;
            background: #4285f4;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .send-btn:active {
            background: #1e3c72;
        }
        .file-input-hidden {
            display: none;
        }
        .chat-image {
            max-width: 200px;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
        }
        .image-preview {
            position: relative;
            display: inline-block;
            margin-top: 10px;
        }
        .image-preview img {
            max-width: 150px;
            border-radius: 8px;
        }
        .remove-image-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* Withdrawal Form */
        .withdrawal-fields {
            margin-top: 20px;
        }
        
        /* Account Frozen Banner */
        .frozen-banner {
            background: #f44336;
            color: white;
            padding: 15px 20px;
            text-align: center;
            font-weight: 600;
            display: none;
        }
        .frozen-banner.active {
            display: block;
        }
        
        /* Overview Stats */
        .overview-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4285f4;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 13px;
            color: #888;
        }
    </style>
</head>
<body>
    <!-- Auth Container -->
    <div id="authContainer" class="auth-container">
        <div class="auth-box">
            <div class="auth-title" id="authTitle">Login</div>
            <div id="authMessage"></div>
            
            <div id="loginForm">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password">
                </div>
                <button class="btn btn-primary" onclick="loginUser()">Login</button>
                <div class="switch-text">
                    Don't have an account? <span class="switch-link" onclick="showRegister()">Register</span>
                </div>
            </div>
            
            <div id="registerForm" class="hidden">
                <div class="input-group">
                    <label>Full Name</label>
                    <input type="text" id="registerName" placeholder="Enter your full name">
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" placeholder="Enter your email">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="registerPassword" placeholder="Create a password (min 6 characters)">
                </div>
                <div class="input-group">
                    <label>Confirm Password</label>
                    <input type="password" id="registerConfirmPassword" placeholder="Confirm your password">
                </div>
                <button class="btn btn-primary" onclick="registerUser()">Register</button>
                <div class="switch-text">
                    Already have an account? <span class="switch-link" onclick="showLogin()">Login</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="app">
        <!-- Frozen Banner -->
        <div id="frozenBanner" class="frozen-banner">
            ⚠️ Your account is currently frozen. Please contact support.
        </div>
        
        <!-- Home Page -->
        <div id="homePage" class="page active">
            <div class="header-banner">
                <div class="header-top">
                    <div class="brand">Hibt</div>
                    <div class="header-icons">
                        <button class="icon-btn" onclick="openNotifications()">🔔</button>
                        <button class="icon-btn" onclick="toggleMenu()">☰</button>
                    </div>
                </div>
                <div class="tagline">Start making money plan.</div>
                
                <!-- Total Assets Section -->
                <div class="total-assets-section">
                    <div class="total-assets-label">Total Assets (USDT)</div>
                    <div class="total-assets-amount">
                        <div class="total-assets-value" id="totalAssetsValue">••••••</div>
                        <span class="eye-icon" id="eyeIcon" onclick="toggleAssetsVisibility()">👁️</span>
                    </div>
                </div>
                
                <div class="logo-box">👥</div>
            </div>
            
            <div class="market-section">
                <div class="section-title">Market</div>
                <div class="coin-list" id="coinList"></div>
            </div>
        </div>
        
        <!-- Side Menu -->
        <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
        <div class="side-menu" id="sideMenu">
            <div class="menu-header">
                <div class="menu-title">👤 Wallet</div>
                <div class="menu-user-id" id="menuUserId">ID: Loading...</div>
            </div>
            <div class="menu-list">
                <div class="menu-item" onclick="openWallet()">
                    <div class="menu-icon">👥</div>
                    <div class="menu-text">Account</div>
                </div>
                <div class="menu-item" onclick="openOverview()">
                    <div class="menu-icon">📊</div>
                    <div class="menu-text">Overview</div>
                </div>
                <div class="menu-item" onclick="openHistory()">
                    <div class="menu-icon">📋</div>
                    <div class="menu-text">History</div>
                </div>
                <div class="menu-item" onclick="openChat()">
                    <div class="menu-icon">💬</div>
                    <div class="menu-text">Customer Service Support</div>
                </div>
                <div class="menu-item" onclick="logoutUser()">
                    <div class="menu-icon">🚪</div>
                    <div class="menu-text">Logout</div>
                </div>
            </div>
        </div>
        
        <!-- Wallet Selection Page -->
        <div id="walletPage" class="page">
            <div class="page-header">
                <button class="back-btn" onclick="backToMenu()">←</button>
                <div class="page-title">Select a wallet</div>
            </div>
            <div class="page-content">
                <div class="wallet-list" id="walletList"></div>
            </div>
        </div>
        
        <!-- Wallet Detail Page -->
        <div id="walletDetailPage" class="page">
            <div class="page-header">
                <button class="back-btn" onclick="backToWalletSelection()">←</button>
                <div class="page-title" id="walletDetailTitle">BTC wallet</div>
            </div>
            <div class="page-content">
                <div class="balance-card">
                    <div class="balance-label" id="walletDetailLabel">US$ 0.0000</div>
                    <div class="balance-amount" id="walletDetailBalance">0.00000000 BTC</div>
                    <div class="balance-crypto">
                        <span id="walletDetailAvailable">Available: 0.00000000 BTC</span><br>
                        <span id="walletDetailFrozen">Frozen: 0.00000000 BTC</span>
                    </div>
                </div>
                
                <div class="action-tabs">
                    <button class="action-tab active" id="swapTab" onclick="switchTab('swap')">Swap</button>
                    <button class="action-tab" id="depositTab" onclick="switchTab('deposit')">Deposit</button>
                    <button class="action-tab" id="withdrawTab" onclick="switchTab('withdraw')">Withdraw</button>
                </div>
                
                <!-- Swap Form -->
                <div id="swapForm" class="swap-form">
                    <div class="form-group">
                        <div class="form-label">From</div>
                        <div class="coin-select" onclick="alert('Select from coin')">
                            <div class="coin-icon" id="swapFromIcon" style="background: #f7931a;">BTC</div>
                            <div style="flex: 1;">
                                <div class="coin-name" id="swapFromName">BTC</div>
                            </div>
                            <div>▼</div>
                        </div>
                    </div>
                    
                    <!-- Swap Arrow -->
                    <div class="swap-arrow-container">
                        <div class="swap-arrow-btn" onclick="swapCoins()">⇅</div>
                    </div>
                    
                    <div class="form-group">
                        <div class="form-label">To</div>
                        <div class="coin-select" onclick="alert('Select to coin')">
                            <div class="coin-icon" id="swapToIcon" style="background: #26a17b; color: white; font-size: 14px;">USDT</div>
                            <div style="flex: 1;">
                                <div class="coin-name" id="swapToName">USDT</div>
                            </div>
                            <div>▼</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="form-label">Amount</div>
                        <div style="display: flex; align-items: center;">
                            <input type="number" class="amount-input" id="swapAmount" placeholder="0" step="any">
                            <button class="max-btn" onclick="setMaxAmount()">Max</button>
                        </div>
                        <div class="available-text">Available: <span id="swapAvailable">0.00</span></div>
                        <div class="fee-text">Fee: <span id="swapFee">0%</span></div>
                    </div>
                    
                    <!-- Contract Time Selection -->
                    <div class="form-group">
                        <div class="form-label">Contract Time</div>
                        <div class="contract-buttons">
                            <button class="contract-btn" id="contract30" onclick="selectContract(30, 5)">30 Seconds</button>
                            <button class="contract-btn" id="contract60" onclick="selectContract(60, 10)">60 Seconds</button>
                            <button class="contract-btn" id="contract90" onclick="selectContract(90, 20)">90 Seconds</button>
                            <button class="contract-btn" id="contract120" onclick="selectContract(120, 20)">2 Minutes</button>
                        </div>
                    </div>
                    
                    <!-- Trade Buttons -->
                    <div class="trade-buttons">
                        <button class="trade-btn buy" onclick="executeTrade('up')">Buy Up 📈</button>
                        <button class="trade-btn sell" onclick="executeTrade('down')">Buy Down 📉</button>
                    </div>
                </div>
                
                <!-- Deposit Form -->
                <div id="depositForm" class="swap-form" style="display: none;">
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 16px; color: #666; margin-bottom: 15px;">Deposit Address</div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 12px; word-break: break-all; font-size: 14px; color: #333;" id="depositAddress">Loading...</div>
                        <div style="margin-top: 20px; font-size: 14px; color: #888;">Send only <span id="depositCoin">BTC</span> to this address</div>
                    </div>
                </div>
                
                <!-- Withdraw Form -->
                <div id="withdrawForm" class="swap-form" style="display: none;">
                    <div class="form-group">
                        <div class="form-label">Amount</div>
                        <input type="number" class="amount-input" id="withdrawAmount" placeholder="Enter amount" step="any">
                        <div class="available-text">Available: <span id="withdrawAvailable">0.00</span> USDT</div>
                    </div>
                    
                    <div class="withdrawal-fields">
                        <div class="form-group">
                            <div class="form-label">Bank Routing Number</div>
                            <input type="text" class="amount-input" id="bankRouting" placeholder="Enter bank routing number">
                        </div>
                        
                        <div class="form-group">
                            <div class="form-label">Bank Address</div>
                            <input type="text" class="amount-input" id="bankAddress" placeholder="Enter bank address">
                        </div>
                        
                        <div class="form-group">
                            <div class="form-label">Bank Code</div>
                            <input type="text" class="amount-input" id="bankCode" placeholder="Enter bank code">
                        </div>
                        
                        <div class="form-group">
                            <div class="form-label">Recipient Address</div>
                            <input type="text" class="amount-input" id="recipientAddress" placeholder="Enter recipient address">
                        </div>
                    </div>
                    
                    <button class="submit-btn" onclick="requestWithdrawal()">Request Withdrawal</button>
                </div>
            </div>
        </div>
        
        <!-- Overview Page -->
        <div id="overviewPage" class="page">
            <div class="page-header">
                <button class="back-btn" onclick="backToMenu()">←</button>
                <div class="page-title">Account Overview</div>
            </div>
            <div class="page-content">
                <div class="overview-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="overviewBalance">$0.00</div>
                        <div class="stat-label">Total Balance</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="overviewTrades">0</div>
                        <div class="stat-label">Total Trades</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="overviewWins">0</div>
                        <div class="stat-label">Wins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="overviewLosses">0</div>
                        <div class="stat-label">Losses</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <button class="submit-btn" onclick="openChangePassword()">Change Password</button>
                </div>
            </div>
        </div>
        
        <!-- History Page -->
        <div id="historyPage" class="page">
            <div class="page-header">
                <button class="back-btn" onclick="backToMenu()">←</button>
                <div class="page-title">Trade History</div>
            </div>
            <div class="page-content">
                <div class="history-list" id="historyList"></div>
            </div>
        </div>
    </div>
    
    <!-- Chat Modal -->
    <div id="chatModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Customer Support</div>
                <button class="close-btn" onclick="closeChat()">×</button>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div id="imagePreviewContainer"></div>
            <div class="chat-input-area">
                <input type="file" id="chatFileInput" class="file-input-hidden" accept="image/*" onchange="handleFileSelect(event)">
                <button class="file-upload-btn" onclick="document.getElementById('chatFileInput').click()">📎</button>
                <textarea class="chat-input" id="chatInput" placeholder="Type your message..." rows="1"></textarea>
                <button class="send-btn" onclick="sendMessage()">➤</button>
            </div>
        </div>
    </div>
    
    <!-- Trade Detail Modal -->
    <div id="tradeDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Trade Details</div>
                <button class="close-btn" onclick="closeTradeDetail()">×</button>
            </div>
            <div id="tradeDetailContent"></div>
        </div>
    </div>
    
    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Change Password</div>
                <button class="close-btn" onclick="closeChangePassword()">×</button>
            </div>
            <div id="changePasswordMessage"></div>
            <div class="input-group">
                <label>Current Password</label>
                <input type="password" id="currentPassword" placeholder="Enter current password">
            </div>
            <div class="input-group">
                <label>New Password</label>
                <input type="password" id="newPassword" placeholder="Enter new password">
            </div>
            <div class="input-group">
                <label>Confirm New Password</label>
                <input type="password" id="confirmNewPassword" placeholder="Confirm new password">
            </div>
            <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.x/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x/firebase-storage-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDUC47xmMHSLfqBEtsGwTRUqOnaglziWes",
            authDomain: "hibt-c2e6c.firebaseapp.com",
            projectId: "hibt-c2e6c",
            storageBucket: "hibt-c2e6c.firebasestorage.app",
            messagingSenderId: "331023163089",
            appId: "1:331023163089:web:e1bd8e5dfab2fccec98b0e"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        let currentUser = null;
        let userId = null;
        let userName = null;
        let userEmail = null;
        let userBalance = { USDT: 0, BTC: 0, ETH: 0, XRP: 0, DOGE: 0, ADA: 0 };
        let selectedCoin = 'BTC';
        let selectedTimeFrame = null;
        let selectedPercentage = 0;
        let tradeCheckInterval = null;
        let chatListener = null;
        let currentTab = 'swap';
        let assetsVisible = false;
        let selectedImageFile = null;
        let navigationHistory = ['home'];
        let isAccountFrozen = false;

        const coins = {
            BTC: { name: 'BTC Coin', symbol: 'USDT', color: '#f7931a', price: 109770.33 },
            ETH: { name: 'ETH Coin', symbol: 'USDT', color: '#627eea', price: 4030.81 },
            XRP: { name: 'XRP Coin', symbol: 'USDT', color: '#23292f', price: 2.8131 },
            DOGE: { name: 'DOGE Coin', symbol: 'USDT', color: '#c2a633', price: 0.2309 },
            ADA: { name: 'ADA Coin', symbol: 'USDT', color: '#0033ad', price: 1.2456 }
        };

        function showMessage(elementId, message, type) {
            const messageEl = document.getElementById(elementId);
            messageEl.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => messageEl.innerHTML = '', 5000);
        }

        function showNotification(message) {
            alert(message);
        }

        function showLogin() {
            document.getElementById('authTitle').textContent = 'Login';
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('authTitle').textContent = 'Register';
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        async function registerUser() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;

            if (!name || !email || !password || !confirmPassword) {
                showMessage('authMessage', 'Please fill all fields', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('authMessage', 'Password must be at least 6 characters', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showMessage('authMessage', 'Passwords do not match', 'error');
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const newUserId = Math.floor(100000 + Math.random() * 900000);

                await db.collection('users').doc(userCredential.user.uid).set({
                    userId: newUserId,
                    name: name,
                    email: email,
                    balance: {
                        USDT: 0,
                        BTC: 0,
                        ETH: 0,
                        XRP: 0,
                        DOGE: 0,
                        ADA: 0
                    },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    frozen: false
                });

                showMessage('authMessage', 'Registration successful!', 'success');
            } catch (error) {
                showMessage('authMessage', error.message, 'error');
            }
        }

        async function loginUser() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showMessage('authMessage', 'Please fill all fields', 'error');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                showMessage('authMessage', error.message, 'error');
            }
        }

        async function logoutUser() {
            await auth.signOut();
            toggleMenu();
        }

        async function loadUserData() {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                userId = userData.userId;
                userName = userData.name;
                userEmail = userData.email;
                userBalance = userData.balance || { USDT: 0, BTC: 0, ETH: 0, XRP: 0, DOGE: 0, ADA: 0 };
                isAccountFrozen = userData.frozen || false;

                document.getElementById('menuUserId').textContent = `ID: ${userId}`;
                
                if (isAccountFrozen) {
                    document.getElementById('frozenBanner').classList.add('active');
                } else {
                    document.getElementById('frozenBanner').classList.remove('active');
                }
                
                renderCoinList();
                updateTotalAssets();
                startTradeChecker();
            }
        }

        function renderCoinList() {
            const coinList = document.getElementById('coinList');
            let html = '';
            
            for (let [key, coin] of Object.entries(coins)) {
                const change = (Math.random() * 10 - 5).toFixed(2);
                const changeClass = change >= 0 ? 'positive' : 'negative';
                const changeSymbol = change >= 0 ? '+' : '';
                
                html += `
                    <div class="coin-card" onclick="openCoinDetail('${key}')">
                        <div class="coin-icon" style="background: ${coin.color};">${key}</div>
                        <div class="coin-info">
                            <div class="coin-name">${coin.name}</div>
                            <div class="coin-symbol">${coin.symbol}</div>
                        </div>
                        <svg class="coin-graph" viewBox="0 0 60 30">
                            <path d="M 0 15 Q 15 ${15 + Math.random() * 10} 30 ${15 + Math.random() * 10} T 60 ${15 + Math.random() * 10}" 
                                  stroke="${change >= 0 ? '#4caf50' : '#f44336'}" 
                                  stroke-width="2" 
                                  fill="none"/>
                        </svg>
                        <div class="coin-price-info">
                            <div class="coin-price">US$ ${coin.price}</div>
                            <div class="coin-change ${changeClass}">${changeSymbol}${change}%</div>
                            <div class="coin-time">24 Hrs</div>
                        </div>
                    </div>
                `;
            }
            
            coinList.innerHTML = html;
        }

        function toggleMenu() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('menuOverlay');
            menu.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function openWallet() {
            toggleMenu();
            showPage('wallet');
            renderWalletList();
        }

        function renderWalletList() {
            const walletList = document.getElementById('walletList');
            let html = '';
            
            for (let [key, coin] of Object.entries(coins)) {
                const balance = userBalance[key] || 0;
                const usdValue = (balance * coin.price).toFixed(4);
                
                html += `
                    <div class="wallet-item" onclick="openWalletDetail('${key}')">
                        <div class="coin-icon" style="background: ${coin.color};">${key}</div>
                        <div class="wallet-info">
                            <div class="wallet-name">${key} wallet</div>
                            <div class="wallet-symbol">${coin.name}</div>
                        </div>
                        <div class="wallet-balance">
                            <div class="wallet-usd">US$ ${usdValue}</div>
                            <div class="wallet-crypto">${balance.toFixed(8)} ${key}</div>
                        </div>
                    </div>
                `;
            }
            
            html += `
                <div class="wallet-item" onclick="openWalletDetail('USDT')">
                    <div class="coin-icon" style="background: #26a17b; color: white; font-size: 14px;">USDT</div>
                    <div class="wallet-info">
                        <div class="wallet-name">USDT wallet</div>
                        <div class="wallet-symbol">Tether</div>
                    </div>
                    <div class="wallet-balance">
                        <div class="wallet-usd">US$ ${(userBalance.USDT || 0).toFixed(4)}</div>
                        <div class="wallet-crypto">${(userBalance.USDT || 0).toFixed(8)} USDT</div>
                    </div>
                </div>
            `;
            
            walletList.innerHTML = html;
        }

        function openCoinDetail(coin) {
            selectedCoin = coin;
            openWalletDetail(coin);
        }

        function openWalletDetail(coin) {
            selectedCoin = coin;
            showPage('walletDetail');
            updateWalletDetail();
            switchTab('swap');
        }

        function updateWalletDetail() {
            const coin = coins[selectedCoin] || { name: 'USDT', color: '#26a17b' };
            const balance = userBalance[selectedCoin] || 0;
            const usdValue = selectedCoin === 'USDT' ? balance : (balance * (coin.price || 1));
            
            document.getElementById('walletDetailTitle').textContent = `${selectedCoin} wallet`;
            document.getElementById('walletDetailLabel').textContent = `US$ ${usdValue.toFixed(4)}`;
            document.getElementById('walletDetailBalance').textContent = `${balance.toFixed(8)} ${selectedCoin}`;
            document.getElementById('walletDetailAvailable').textContent = `Available: ${balance.toFixed(8)} ${selectedCoin}`;
            document.getElementById('walletDetailFrozen').textContent = `Frozen: 0.00000000 ${selectedCoin}`;
            
            document.getElementById('swapAvailable').textContent = `${balance.toFixed(4)}`;
            document.getElementById('withdrawAvailable').textContent = `${(userBalance.USDT || 0).toFixed(4)}`;
            
            document.getElementById('swapFromIcon').style.background = coin.color || '#26a17b';
            document.getElementById('swapFromIcon').textContent = selectedCoin;
            document.getElementById('swapFromName').textContent = selectedCoin;
            
            updateContractButtons();
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.action-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
            
            document.getElementById('swapForm').style.display = tab === 'swap' ? 'block' : 'none';
            document.getElementById('depositForm').style.display = tab === 'deposit' ? 'block' : 'none';
            document.getElementById('withdrawForm').style.display = tab === 'withdraw' ? 'block' : 'none';
            
            if (tab === 'deposit') {
                document.getElementById('depositAddress').textContent = `${selectedCoin}-${userId}-${Date.now()}`;
                document.getElementById('depositCoin').textContent = selectedCoin;
            }
        }

        function swapCoins() {
            const fromIcon = document.getElementById('swapFromIcon');
            const fromName = document.getElementById('swapFromName');
            const toIcon = document.getElementById('swapToIcon');
            const toName = document.getElementById('swapToName');
            
            const tempIcon = fromIcon.style.background;
            const tempName = fromName.textContent;
            const tempIconText = fromIcon.textContent;
            
            fromIcon.style.background = toIcon.style.background;
            fromIcon.textContent = toIcon.textContent;
            fromName.textContent = toName.textContent;
            
            toIcon.style.background = tempIcon;
            toIcon.textContent = tempIconText;
            toName.textContent = tempName;
        }

        function setMaxAmount() {
            const balance = userBalance[selectedCoin] || 0;
            document.getElementById('swapAmount').value = balance.toFixed(8);
        }

        function selectContract(timeFrame, percentage) {
            selectedTimeFrame = timeFrame;
            selectedPercentage = percentage;
            
            document.querySelectorAll('.contract-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`contract${timeFrame}`).classList.add('active');
        }

        function updateContractButtons() {
            const usdtBalance = userBalance.USDT || 0;
            
            const contract90 = document.getElementById('contract90');
            const contract120 = document.getElementById('contract120');
            
            if (usdtBalance < 20) {
                contract90.disabled = true;
                contract120.disabled = true;
            } else {
                contract90.disabled = false;
                contract120.disabled = false;
            }
        }

        async function executeTrade(direction) {
            if (isAccountFrozen) {
                showNotification('❌ Your account is frozen. Please contact support.');
                return;
            }
            
            const amount = parseFloat(document.getElementById('swapAmount').value);
            
            if (!amount || amount <= 0) {
                showNotification('❌ Please enter a valid amount');
                return;
            }
            
            if (!selectedTimeFrame) {
                showNotification('❌ Please select a contract time');
                return;
            }
            
            const balance = userBalance[selectedCoin] || 0;
            if (amount > balance) {
                showNotification('❌ Insufficient balance');
                return;
            }
            
            const usdtBalance = userBalance.USDT || 0;
            if ((selectedTimeFrame === 90 || selectedTimeFrame === 120) && usdtBalance < 20) {
                showNotification('❌ You need at least 20 USDT to use this contract time');
                return;
            }
            
            try {
                userBalance[selectedCoin] -= amount;
                await db.collection('users').doc(currentUser.uid).update({
                    [`balance.${selectedCoin}`]: userBalance[selectedCoin]
                });
                
                const currentPrice = coins[selectedCoin]?.price || 1;
                const tradeDoc = await db.collection('trades').add({
                    userId: currentUser.uid,
                    userIdNumber: userId,
                    coin: selectedCoin,
                    amount: amount,
                    direction: direction,
                    timeFrame: selectedTimeFrame,
                    percentage: selectedPercentage,
                    purchasePrice: currentPrice,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await db.collection('transactions').add({
                    userId: currentUser.uid,
                    type: 'trade',
                    coin: selectedCoin,
                    amount: amount,
                    direction: direction,
                    status: 'pending',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('✅ Trade placed successfully!');
                document.getElementById('swapAmount').value = '';
                updateWalletDetail();
                updateTotalAssets();
            } catch (error) {
                showNotification('❌ Trade failed: ' + error.message);
            }
        }

        async function requestWithdrawal() {
            if (isAccountFrozen) {
                showNotification('❌ Your account is frozen. Please contact support.');
                return;
            }
            
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const bankRouting = document.getElementById('bankRouting').value.trim();
            const bankAddress = document.getElementById('bankAddress').value.trim();
            const bankCode = document.getElementById('bankCode').value.trim();
            const recipientAddress = document.getElementById('recipientAddress').value.trim();
            
            if (!amount || amount <= 0) {
                showNotification('❌ Please enter a valid amount');
                return;
            }
            
            if (!bankRouting || !bankAddress || !bankCode || !recipientAddress) {
                showNotification('❌ Please fill all bank details');
                return;
            }
            
            const usdtBalance = userBalance.USDT || 0;
            if (amount > usdtBalance) {
                showNotification('❌ Insufficient USDT balance');
                return;
            }
            
            try {
                userBalance.USDT -= amount;
                await db.collection('users').doc(currentUser.uid).update({
                    'balance.USDT': userBalance.USDT
                });
                
                await db.collection('withdrawals').add({
                    userId: currentUser.uid,
                    userIdNumber: userId,
                    userName: userName,
                    userEmail: userEmail,
                    amount: amount,
                    bankRouting: bankRouting,
                    bankAddress: bankAddress,
                    bankCode: bankCode,
                    recipientAddress: recipientAddress,
                    status: 'pending',
                    requestedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await db.collection('transactions').add({
                    userId: currentUser.uid,
                    type: 'withdrawal',
                    amount: amount,
                    status: 'pending',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('✅ Withdrawal request submitted!');
                document.getElementById('withdrawAmount').value = '';
                document.getElementById('bankRouting').value = '';
                document.getElementById('bankAddress').value = '';
                document.getElementById('bankCode').value = '';
                document.getElementById('recipientAddress').value = '';
                updateWalletDetail();
                updateTotalAssets();
            } catch (error) {
                showNotification('❌ Withdrawal request failed: ' + error.message);
            }
        }

        function openOverview() {
            toggleMenu();
            showPage('overview');
            loadOverviewData();
        }

        async function loadOverviewData() {
            let totalUSDT = userBalance.USDT || 0;
            for (let [key, coin] of Object.entries(coins)) {
                const balance = userBalance[key] || 0;
                totalUSDT += balance * coin.price;
            }
            
            const tradesSnapshot = await db.collection('trades')
                .where('userId', '==', currentUser.uid)
                .get();
            
            let totalTrades = tradesSnapshot.size;
            let wins = 0;
            let losses = 0;
            
            tradesSnapshot.forEach(doc => {
                const trade = doc.data();
                if (trade.status === 'win') wins++;
                if (trade.status === 'loss') losses++;
            });
            
            document.getElementById('overviewBalance').textContent = `$${totalUSDT.toFixed(2)}`;
            document.getElementById('overviewTrades').textContent = totalTrades;
            document.getElementById('overviewWins').textContent = wins;
            document.getElementById('overviewLosses').textContent = losses;
        }

        function openHistory() {
            toggleMenu();
            showPage('history');
            loadHistoryData();
        }

        async function loadHistoryData() {
            const tradesSnapshot = await db.collection('trades')
                .where('userId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .get();
            
            const historyList = document.getElementById('historyList');
            
            if (tradesSnapshot.empty) {
                historyList.innerHTML = '<div style="text-align: center; color: #888; padding: 40px;">No trade history yet</div>';
                return;
            }
            
            let html = '';
            tradesSnapshot.forEach(doc => {
                const trade = { id: doc.id, ...doc.data() };
                const date = trade.createdAt ? new Date(trade.createdAt.toMillis()).toLocaleString() : 'N/A';
                const statusClass = trade.status === 'win' ? 'status-win' : trade.status === 'loss' ? 'status-loss' : 'status-pending';
                const statusText = trade.status.toUpperCase();
                
                html += `
                    <div class="history-item" onclick="showTradeDetail('${trade.id}')">
                        <div class="history-header">
                            <div class="history-type">${trade.coin} ${trade.direction === 'up' ? '📈' : '📉'}</div>
                            <div class="history-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="history-details">
                            <div>Amount: ${trade.amount.toFixed(2)} USDT</div>
                            <div>${trade.timeFrame}s</div>
                        </div>
                        <div class="history-details">
                            <div>${date}</div>
                        </div>
                    </div>
                `;
            });
            
            historyList.innerHTML = html;
        }

        async function showTradeDetail(tradeId) {
            const tradeDoc = await db.collection('trades').doc(tradeId).get();
            if (!tradeDoc.exists) return;
            
            const trade = tradeDoc.data();
            const purchaseTime = trade.createdAt ? new Date(trade.createdAt.toMillis()) : new Date();
            const endTime = new Date(purchaseTime.getTime() + trade.timeFrame * 1000);
            const purchaseTimeStr = purchaseTime.toLocaleString();
            const deliveryTimeStr = endTime.toLocaleString();
            
            const resultHtml = trade.status === 'win' ?
                `<div class="detail-row">
                    <div class="detail-label">Result</div>
                    <div class="result-win">WIN +${(trade.amount * trade.percentage / 100).toFixed(2)} USDT</div>
                </div>` :
                trade.status === 'loss' ?
                `<div class="detail-row">
                    <div class="detail-label">Result</div>
                    <div class="result-loss">LOSS -${trade.amount.toFixed(2)} USDT</div>
                </div>` :
                `<div class="detail-row">
                    <div class="detail-label">Status</div>
                    <div class="detail-value" style="color: #ff9800;">PENDING</div>
                </div>`;

            document.getElementById('tradeDetailContent').innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">Purchase Amount</div>
                    <div class="detail-value">${trade.amount.toFixed(2)} USDT</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Direction</div>
                    <div class="detail-value" style="color: ${trade.direction === 'up' ? '#4caf50' : '#f44336'};">${trade.direction === 'up' ? 'Buy Up' : 'Buy Down'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Purchase Price</div>
                    <div class="detail-value">${trade.purchasePrice ? trade.purchasePrice.toFixed(2) : 'N/A'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Contract Time</div>
                    <div class="detail-value">${trade.timeFrame} Seconds</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Profit Percentage</div>
                    <div class="detail-value">${trade.percentage}%</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Purchase Time</div>
                    <div class="detail-value">${purchaseTimeStr}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Delivery Time</div>
                    <div class="detail-value">${deliveryTimeStr}</div>
                </div>
                ${resultHtml}
            `;

            document.getElementById('tradeDetailModal').classList.add('active');
            
            if (trade.status === 'pending') {
                const countdownInterval = setInterval(() => {
                    const nowMs = Date.now();
                    const remainingMs = Math.max(0, endTime - nowMs);
                    const remainingSec = Math.floor(remainingMs / 1000);
                    
                    if (remainingSec <= 0) {
                        clearInterval(countdownInterval);
                        closeTradeDetail();
                        loadHistoryData();
                    }
                }, 1000);
            }
        }

        function closeTradeDetail() {
            document.getElementById('tradeDetailModal').classList.remove('active');
        }

        function startTradeChecker() {
            if (tradeCheckInterval) clearInterval(tradeCheckInterval);
            
            tradeCheckInterval = setInterval(async () => {
                const now = Date.now();
                const tradesSnapshot = await db.collection('trades')
                    .where('userId', '==', currentUser.uid)
                    .where('status', '==', 'pending')
                    .get();
                
                tradesSnapshot.forEach(async (doc) => {
                    const trade = doc.data();
                    const createdAt = trade.createdAt ? trade.createdAt.toMillis() : now;
                    const endTime = createdAt + (trade.timeFrame * 1000);
                    
                    if (now >= endTime) {
                        const isWin = Math.random() > 0.5;
                        
                        if (isWin) {
                            const profit = trade.amount * (trade.percentage / 100);
                            const totalReturn = trade.amount + profit;
                            
                            userBalance.USDT += totalReturn;
                            await db.collection('users').doc(currentUser.uid).update({
                                'balance.USDT': userBalance.USDT
                            });
                            
                            await db.collection('trades').doc(doc.id).update({
                                status: 'win',
                                profit: profit,
                                completedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            await db.collection('transactions').add({
                                userId: currentUser.uid,
                                type: 'trade_win',
                                coin: trade.coin,
                                amount: profit,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        } else {
                            await db.collection('trades').doc(doc.id).update({
                                status: 'loss',
                                completedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            await db.collection('transactions').add({
                                userId: currentUser.uid,
                                type: 'trade_loss',
                                coin: trade.coin,
                                amount: trade.amount,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                        
                        await loadUserData();
                        updateTotalAssets();
                    }
                });
            }, 5000);
        }

        function openChangePassword() {
            document.getElementById('changePasswordModal').classList.add('active');
        }

        function closeChangePassword() {
            document.getElementById('changePasswordModal').classList.remove('active');
        }

        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (!currentPassword || !newPassword || !confirmNewPassword) {
                showMessage('changePasswordMessage', 'Please fill all fields', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showMessage('changePasswordMessage', 'New password must be at least 6 characters', 'error');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showMessage('changePasswordMessage', 'New passwords do not match', 'error');
                return;
            }

            try {
                const user = auth.currentUser;
                const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);

                await user.reauthenticateWithCredential(credential);
                await user.updatePassword(newPassword);

                showMessage('changePasswordMessage', 'Password changed successfully!', 'success');
                setTimeout(() => {
                    closeChangePassword();
                }, 2000);
            } catch (error) {
                showMessage('changePasswordMessage', error.message, 'error');
            }
        }

        function openNotifications() {
            showNotification('No new notifications');
        }

        function openChat() {
            toggleMenu();
            document.getElementById('chatModal').classList.add('active');
            loadChatMessages();
        }

        function closeChat() {
            document.getElementById('chatModal').classList.remove('active');
            if (chatListener) {
                chatListener();
                chatListener = null;
            }
            selectedImageFile = null;
            document.getElementById('imagePreviewContainer').innerHTML = '';
        }

        function loadChatMessages() {
            const chatMessages = document.getElementById('chatMessages');
            
            if (chatListener) {
                chatListener();
                chatListener = null;
            }
            
            chatListener = db.collection('chats')
                .where('userId', '==', currentUser.uid)
                .onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        chatMessages.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No messages yet</div>';
                        return;
                    }

                    const messages = [];
                    snapshot.forEach(doc => {
                        messages.push({ id: doc.id, ...doc.data() });
                    });
                    
                    messages.sort((a, b) => {
                        const timeA = a.timestamp?.toMillis() || 0;
                        const timeB = b.timestamp?.toMillis() || 0;
                        return timeA - timeB;
                    });

                    let html = '';
                    messages.forEach(msg => {
                        const isUser = msg.senderType === 'user';
                        const time = msg.timestamp ? new Date(msg.timestamp.toMillis()).toLocaleTimeString() : '';
                        
                        html += `
                            <div style="margin-bottom: 15px; text-align: ${isUser ? 'right' : 'left'};">
                                <div style="display: inline-block; max-width: 70%; padding: 10px 15px; border-radius: 12px; background: ${isUser ? '#4285f4' : '#e0e0e0'}; color: ${isUser ? '#fff' : '#333'}; text-align: left;">
                                    <div style="font-weight: 600; font-size: 11px; margin-bottom: 5px; opacity: 0.8;">${isUser ? 'You' : 'Support'}</div>
                                    <div>${msg.message}</div>
                                    ${msg.imageUrl ? `<img src="${msg.imageUrl}" class="chat-image" onclick="window.open('${msg.imageUrl}', '_blank')" />` : ''}
                                    <div style="font-size: 9px; margin-top: 5px; opacity: 0.7;">${time}</div>
                                </div>
                            </div>
                        `;
                    });

                    chatMessages.innerHTML = html;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                selectedImageFile = file;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreviewContainer').innerHTML = `
                        <div class="image-preview">
                            <img src="${e.target.result}" />
                            <button class="remove-image-btn" onclick="removeImage()">×</button>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            }
        }

        function removeImage() {
            selectedImageFile = null;
            document.getElementById('imagePreviewContainer').innerHTML = '';
            document.getElementById('chatFileInput').value = '';
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message && !selectedImageFile) return;

            try {
                let imageUrl = null;
                
                if (selectedImageFile) {
                    const storageRef = storage.ref();
                    const imageRef = storageRef.child(`chat-images/${currentUser.uid}/${Date.now()}_${selectedImageFile.name}`);
                    await imageRef.put(selectedImageFile);
                    imageUrl = await imageRef.getDownloadURL();
                }

                await db.collection('chats').add({
                    userId: currentUser.uid,
                    userIdNumber: userId,
                    userName: userName,
                    userEmail: userEmail,
                    message: message || '📎 Image',
                    imageUrl: imageUrl,
                    senderType: 'user',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false
                });

                input.value = '';
                removeImage();
            } catch (error) {
                showNotification('❌ Failed to send message');
            }
        }

        function toggleAssetsVisibility() {
            assetsVisible = !assetsVisible;
            updateTotalAssets();
        }

        function updateTotalAssets() {
            let totalUSDT = userBalance.USDT || 0;
            for (let [key, coin] of Object.entries(coins)) {
                const balance = userBalance[key] || 0;
                totalUSDT += balance * coin.price;
            }
            
            const valueElement = document.getElementById('totalAssetsValue');
            const eyeIcon = document.getElementById('eyeIcon');
            
            if (assetsVisible) {
                valueElement.textContent = `$${totalUSDT.toFixed(2)}`;
                eyeIcon.textContent = '👁️';
            } else {
                valueElement.textContent = '••••••';
                eyeIcon.textContent = '👁️';
            }
        }

        function showPage(pageName) {
            navigationHistory.push(pageName);
            
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            
            if (pageName === 'home') {
                document.getElementById('homePage').classList.add('active');
            } else if (pageName === 'wallet') {
                document.getElementById('walletPage').classList.add('active');
            } else if (pageName === 'walletDetail') {
                document.getElementById('walletDetailPage').classList.add('active');
            } else if (pageName === 'overview') {
                document.getElementById('overviewPage').classList.add('active');
            } else if (pageName === 'history') {
                document.getElementById('historyPage').classList.add('active');
            }
        }

        function backToHome() {
            navigationHistory = ['home'];
            showPage('home');
        }

        function backToMenu() {
            if (navigationHistory.length > 1) {
                navigationHistory.pop();
                const previousPage = navigationHistory[navigationHistory.length - 1];
                
                navigationHistory.pop();
                
                if (previousPage === 'home') {
                    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                    document.getElementById('homePage').classList.add('active');
                    toggleMenu();
                } else {
                    showPage(previousPage);
                }
            } else {
                document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                document.getElementById('homePage').classList.add('active');
                toggleMenu();
            }
        }

        function backToWalletSelection() {
            if (navigationHistory.length > 1) {
                navigationHistory.pop();
                showPage('wallet');
            } else {
                showPage('wallet');
            }
        }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('mainApp').classList.add('active');
            } else {
                currentUser = null;
                document.getElementById('authContainer').style.display = 'flex';
                document.getElementById('mainApp').classList.remove('active');
                if (tradeCheckInterval) clearInterval(tradeCheckInterval);
            }
        });
        
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
