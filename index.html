<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hibt - Trading Platform v4</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: #f8f9fa; 
            overflow-x: hidden;
        }
        
        /* Authentication Styles */
        .auth-container { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 20px; 
        }
        .auth-box { 
            background: white; 
            border-radius: 20px; 
            padding: 40px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
            width: 90%; 
            max-width: 400px; 
        }
        .auth-title { 
            font-size: 24px; 
            font-weight: 600; 
            margin-bottom: 30px; 
            text-align: center; 
        }
        .input-group { margin-bottom: 20px; }
        label { 
            display: block; 
            margin-bottom: 8px; 
            color: #555; 
            font-weight: 500; 
        }
        input, select { 
            width: 100%; 
            padding: 15px; 
            border: 2px solid #e1e5e9; 
            border-radius: 12px; 
            font-size: 16px; 
        }
        input:focus, select:focus { 
            outline: none; 
            border-color: #667eea; 
        }
        .btn { 
            width: 100%; 
            padding: 15px; 
            border: none; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            margin-top: 20px; 
            transition: all 0.3s;
        }
        .btn-primary { 
            background: #667eea; 
            color: white; 
        }
        .btn-primary:hover { 
            background: #5a67d8; 
        }
        .btn-primary:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
        }
        .switch-text { 
            margin-top: 20px; 
            color: #6c757d; 
            text-align: center; 
        }
        .switch-link { 
            color: #667eea; 
            cursor: pointer; 
            text-decoration: underline; 
        }
        .message { 
            padding: 10px; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            font-weight: 500; 
        }
        .error { 
            background: #fee; 
            color: #c33; 
            border: 1px solid #fcc; 
        }
        .success { 
            background: #efe; 
            color: #363; 
            border: 1px solid #cfc; 
        }
        .hidden { display: none; }
        
        /* Dashboard Styles */
        .dashboard { display: none; min-height: 100vh; }
        .dashboard.active { display: block; }
        .header { 
            background: linear-gradient(135deg, #4285f4 0%, #3367d6 100%); 
            color: white; 
            padding: 20px; 
        }
        .header-top { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        .brand { font-size: 36px; font-weight: bold; }
        .user-info-box { 
            background: rgba(255,255,255,0.2); 
            padding: 15px; 
            border-radius: 12px; 
            margin-top: 15px; 
        }
        .user-id { 
            font-size: 14px; 
            opacity: 0.9; 
            margin-bottom: 5px; 
        }
        .user-name { 
            font-size: 18px; 
            font-weight: 600; 
            margin-bottom: 10px; 
        }
        .balance-display { 
            font-size: 32px; 
            font-weight: bold; 
            margin: 10px 0; 
        }
        .btn-small { 
            padding: 8px 16px; 
            background: rgba(255,255,255,0.2); 
            border: none; 
            border-radius: 20px; 
            color: white; 
            cursor: pointer; 
            font-size: 14px; 
            transition: all 0.3s;
        }
        .btn-small:hover { 
            background: rgba(255,255,255,0.3); 
        }
        
        /* Bottom Navigation */
        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: white; 
            display: flex; 
            justify-content: space-around; 
            padding: 10px 0; 
            border-top: 1px solid #e1e5e9; 
            z-index: 100; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); 
        }
        .nav-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 8px 20px; 
            cursor: pointer; 
            color: #888; 
            transition: all 0.3s; 
        }
        .nav-item.active { color: #4285f4; }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }
        .nav-label { font-size: 11px; font-weight: 600; }
        
        /* Page Styles */
        .page { display: none; padding: 20px; padding-bottom: 80px; }
        .page.active { display: block; }
        
        /* Market Section */
        .section-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
        }
        .section-title { font-size: 24px; font-weight: bold; }
        .live-indicator { 
            display: inline-block; 
            width: 8px; 
            height: 8px; 
            background: #4caf50; 
            border-radius: 50%; 
            margin-left: 10px; 
            animation: pulse 2s infinite; 
        }
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.3; } 
        }
        .coin-list { 
            background: white; 
            border-radius: 15px; 
            overflow: hidden; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        }
        .coin-item { 
            display: flex; 
            align-items: center; 
            padding: 16px 20px; 
            border-bottom: 1px solid #f1f3f4; 
            cursor: pointer; 
            transition: all 0.3s;
        }
        .coin-item:hover { background: #f8f9fb; }
        .coin-icon { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-weight: bold; 
            margin-right: 15px; 
            font-size: 14px; 
        }
        .coin-info { flex: 1; }
        .coin-name { font-weight: 600; font-size: 16px; }
        .coin-price { 
            text-align: right; 
            font-weight: 600; 
            font-size: 16px; 
        }
        
        /* Portfolio Styles */
        .portfolio-card { 
            background: white; 
            border-radius: 15px; 
            padding: 20px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        }
        .portfolio-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        .crypto-icon { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-weight: bold; 
            font-size: 18px; 
        }
        .crypto-amount { font-size: 24px; font-weight: bold; }
        .crypto-value { color: #666; font-size: 14px; }
        
        /* Swap Styles */
        .swap-container { 
            background: white; 
            border-radius: 15px; 
            padding: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        }
        .swap-box { 
            background: #f8f9fa; 
            border-radius: 12px; 
            padding: 15px; 
            margin-bottom: 10px; 
        }
        .swap-header { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px; 
        }
        .swap-input { 
            width: 100%; 
            border: none; 
            background: transparent; 
            font-size: 24px; 
            font-weight: 600; 
        }
        .swap-input:focus { outline: none; }
        .swap-icon { 
            text-align: center; 
            margin: 10px 0; 
            font-size: 24px; 
            color: #4285f4; 
        }
        
        /* Modal Styles */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.5); 
            z-index: 1000; 
            overflow-y: auto; 
        }
        .modal.active { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 20px; 
        }
        .modal-content { 
            background: white; 
            border-radius: 20px; 
            padding: 30px; 
            width: 90%; 
            max-width: 500px; 
            max-height: 90vh; 
            overflow-y: auto; 
        }
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
        }
        .modal-title { font-size: 24px; font-weight: 600; }
        .close-btn { 
            background: none; 
            border: none; 
            font-size: 32px; 
            cursor: pointer; 
            color: #666; 
            line-height: 1; 
        }
        
        /* Trade Modal Styles */
        .trade-section { margin-bottom: 20px; }
        .trade-label { font-weight: 600; margin-bottom: 10px; }
        .direction-btns { display: flex; gap: 10px; margin-top: 10px; }
        .direction-btn { 
            flex: 1; 
            padding: 15px; 
            border: none; 
            border-radius: 12px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s;
        }
        .direction-btn.up { background: #4caf50; color: white; }
        .direction-btn.down { background: #f44336; color: white; }
        .direction-btn.inactive { 
            background: #e9ecef; 
            color: #666; 
            opacity: 0.6;
        }
        .trade-input { 
            width: 100%; 
            padding: 15px; 
            border: 2px solid #e9ecef; 
            border-radius: 12px; 
            font-size: 16px; 
            margin-top: 10px; 
        }
        .info-text { 
            color: #666; 
            font-size: 14px; 
            margin-top: 10px; 
        }
        .trade-btn { 
            width: 100%; 
            padding: 18px; 
            background: #4285f4; 
            color: white; 
            border: none; 
            border-radius: 12px; 
            font-size: 18px; 
            font-weight: 600; 
            cursor: pointer; 
            margin-top: 20px; 
            transition: all 0.3s;
        }
        .trade-btn:hover { background: #3367d6; }
        .trade-btn:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
        }
        
        /* Withdraw Styles */
        .withdraw-option { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 12px; 
            margin-bottom: 10px; 
            cursor: pointer; 
            border: 2px solid transparent; 
            transition: all 0.3s;
        }
        .withdraw-option:hover { border-color: #4285f4; }
        .withdraw-option.active { 
            background: #e3f2fd; 
            border-color: #4285f4; 
        }
        
        /* History Styles */
        .history-item { 
            background: white; 
            padding: 15px; 
            border-radius: 12px; 
            margin-bottom: 10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .history-item.wait { 
            border-left: 4px solid #ff9800; 
            background: #fff8f0; 
        }
        .history-item.finished.win { 
            border-left: 4px solid #4caf50; 
            background: #f1f8f4; 
        }
        .history-item.finished.loss { 
            border-left: 4px solid #f44336; 
            background: #fef1f1; 
        }
        .history-item.withdraw { 
            border-left: 4px solid #2196f3; 
            background: #f0f8ff; 
        }
        .history-item.withdraw.approved { 
            border-left: 4px solid #4caf50; 
            background: #f1f8f4; 
        }
        .history-item.withdraw.rejected { 
            border-left: 4px solid #f44336; 
            background: #fef1f1; 
        }
        
        /* Crypto Colors */
        .btc { background: #f7931a; }
        .eth { background: #627eea; }
        .usdt { background: #26a17b; }
        .xrp { background: #23292f; }
        .doge { background: #c2a633; }
        .ada { background: #0033ad; }
        .bnb { background: #f3ba2f; }
        .sol { background: #9945FF; }
        .link { background: #375BD2; }
        .dot { background: #E6007A; }
        .ltc { background: #345D9D; }
    </style>
</head>
<body>
    <!-- Authentication Container -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <!-- Register Form -->
            <div id="registerForm">
                <h2 class="auth-title">Create Account</h2>
                <div id="authMessage"></div>
                <div class="input-group">
                    <label>Full Name</label>
                    <input type="text" id="regName" placeholder="Enter your name">
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="regEmail" placeholder="Enter email">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="regPassword" placeholder="Enter password (min 6 characters)">
                </div>
                <div class="input-group">
                    <label>Repeat Password</label>
                    <input type="password" id="regRepeatPassword" placeholder="Repeat password">
                </div>
                <button class="btn btn-primary" onclick="register()">Register</button>
                <div class="switch-text">
                    Already have an account? <span class="switch-link" onclick="showLogin()">Sign In</span>
                </div>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="hidden">
                <h2 class="auth-title">Sign In</h2>
                <div id="loginMessage"></div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="Enter email">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password">
                </div>
                <button class="btn btn-primary" onclick="login()">Sign In</button>
                <div class="switch-text">
                    <span class="switch-link" onclick="forgotPassword()">Forgot Password?</span>
                </div>
                <div class="switch-text">
                    Don't have an account? <span class="switch-link" onclick="showRegister()">Register</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <div class="brand">Hibt</div>
                <button class="btn-small" onclick="logout()">Logout</button>
            </div>
            <div class="user-info-box">
                <div class="user-id">ID: <span id="userId"></span></div>
                <div class="user-name" id="userName"></div>
                <div class="balance-display">
                    <span id="userBalance">0.00</span> USDT
                    <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">Available Balance</div>
                </div>
            </div>
        </div>

        <!-- Home Page -->
        <div class="page active" id="homePage">
            <div class="section-header">
                <h2 class="section-title">Markets <span class="live-indicator"></span></h2>
            </div>
            <div class="coin-list" id="coinList"></div>
        </div>

        <!-- Portfolio Page -->
        <div class="page" id="portfolioPage">
            <div class="section-header">
                <h2 class="section-title">My Portfolio</h2>
            </div>
            <div class="portfolio-card">
                <h3 style="margin-bottom: 15px;">Total Portfolio Value</h3>
                <div style="font-size: 36px; font-weight: bold; color: #4285f4;" id="totalPortfolioValue">$0.00</div>
            </div>
            <div id="portfolioList"></div>
        </div>

        <!-- Swap Page -->
        <div class="page" id="swapPage">
            <div class="section-header">
                <h2 class="section-title">Swap Crypto</h2>
            </div>
            <div class="swap-container">
                <div class="swap-box">
                    <div class="swap-header">
                        <label>From</label>
                        <div id="fromBalance">Balance: 0</div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" class="swap-input" id="swapFromAmount" placeholder="0.0" oninput="calculateSwap()">
                        <select style="padding: 10px; border-radius: 8px; border: 2px solid #e9ecef; font-weight: 600;" id="swapFromCrypto" onchange="updateSwapBalances()">
                            <option value="usdt">USDT</option>
                            <option value="btc">BTC</option>
                            <option value="eth">ETH</option>
                        </select>
                    </div>
                </div>
                
                <div class="swap-icon">⇅</div>
                
                <div class="swap-box">
                    <div class="swap-header">
                        <label>To</label>
                        <div id="toBalance">Balance: 0</div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" class="swap-input" id="swapToAmount" placeholder="0.0" disabled>
                        <select style="padding: 10px; border-radius: 8px; border: 2px solid #e9ecef; font-weight: 600;" id="swapToCrypto" onchange="calculateSwap()">
                            <option value="btc">BTC</option>
                            <option value="eth">ETH</option>
                            <option value="usdt">USDT</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Exchange Rate</span>
                        <span style="font-weight: 600;" id="exchangeRate">-</span>
                    </div>
                </div>
                
                <button class="btn btn-primary" style="margin-top: 20px;" onclick="executeSwap()">Swap Now</button>
            </div>
        </div>

        <!-- History Page -->
        <div class="page" id="historyPage">
            <div class="section-header">
                <h2 class="section-title">History</h2>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-small" id="tradesFilterBtn" style="flex: 1; background: #4285f4; color: white;" onclick="filterHistory('trades')">Trades</button>
                <button class="btn btn-small" id="withdrawalsFilterBtn" style="flex: 1; background: white; color: #333; border: 2px solid #e9ecef;" onclick="filterHistory('withdrawals')">Withdrawals</button>
            </div>
            <div id="historyList"></div>
        </div>

        <!-- Profile Page -->
        <div class="page" id="profilePage">
            <div class="section-header">
                <h2 class="section-title">Profile</h2>
            </div>
            <div class="portfolio-card">
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 18px; color: #666; margin-bottom: 10px;">UID: <span id="profileUserId"></span></div>
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 20px;" id="profileUserName"></div>
                </div>
            </div>
            <div style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <div style="padding: 15px; border-bottom: 1px solid #f1f3f4; cursor: pointer;" onclick="openDeposit()">💰 Deposit Funds</div>
                <div style="padding: 15px; border-bottom: 1px solid #f1f3f4; cursor: pointer;" onclick="openWithdraw()">💸 Withdraw Funds</div>
                <div style="padding: 15px; border-bottom: 1px solid #f1f3f4; cursor: pointer;" onclick="openChangePassword()">🔒 Change Password</div>
                <div style="padding: 15px; border-bottom: 1px solid #f1f3f4; cursor: pointer;" onclick="openChat()">💬 Contact Support</div>
                <div style="padding: 15px; cursor: pointer;" onclick="logout()">🚪 Logout</div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="navigateTo('home')">
                <div class="nav-icon">🏠</div>
                <div class="nav-label">Home</div>
            </div>
            <div class="nav-item" onclick="navigateTo('portfolio')">
                <div class="nav-icon">💼</div>
                <div class="nav-label">Portfolio</div>
            </div>
            <div class="nav-item" onclick="navigateTo('swap')">
                <div class="nav-icon">🔄</div>
                <div class="nav-label">Swap</div>
            </div>
            <div class="nav-item" onclick="navigateTo('history')">
                <div class="nav-icon">📊</div>
                <div class="nav-label">History</div>
            </div>
            <div class="nav-item" onclick="navigateTo('profile')">
                <div class="nav-icon">👤</div>
                <div class="nav-label">Profile</div>
            </div>
        </div>
    </div>

    <!-- Trading Modal -->
    <div class="modal" id="tradingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Trade</h2>
                <button class="close-btn" onclick="closeTradeModal()">&times;</button>
            </div>
            
            <div id="tradeMessage"></div>
            
            <div class="trade-section">
                <div class="trade-label">Direction</div>
                <div class="direction-btns">
                    <button class="direction-btn up" id="upBtn" onclick="selectDirection('up')">Buy Up</button>
                    <button class="direction-btn down inactive" id="downBtn" onclick="selectDirection('down')">Buy Down</button>
                </div>
            </div>

            <div class="trade-section">
                <div class="trade-label">Amount (USDT)</div>
                <input type="number" class="trade-input" id="tradeAmount" placeholder="Enter amount (min 100 USDT)" min="100" oninput="updateExpectedProfit()">
                <div class="info-text">Available: <span id="availableBalance">0.00</span> USDT</div>
                <div class="info-text">Expected Profit: <span id="expectedProfit">0.00</span> USDT</div>
            </div>

            <div class="trade-section">
                <div class="trade-label">Contract Time</div>
                <select class="trade-input" id="timeFrame" onchange="updateTimeFrameAndProfit()">
                    <option value="60">60 Seconds (15% Profit)</option>
                    <option value="90">90 Seconds (25% Profit) - Requires 100K+ Balance</option>
                    <option value="120">2 Minutes (35% Profit) - Requires 500K+ Balance</option>
                </select>
                <div class="info-text" id="timeFrameWarning" style="color: #f44336; display: none;">Insufficient balance for this timeframe</div>
            </div>

            <button class="trade-btn" id="executeTradeBtn" onclick="executeTrade()">Execute Trade</button>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div class="modal" id="withdrawModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Withdraw Funds</h2>
                <button class="close-btn" onclick="closeWithdraw()">&times;</button>
            </div>
            
            <div id="withdrawMessage"></div>
            
            <div class="trade-section">
                <div class="trade-label">Select Withdrawal Method</div>
                <div class="withdraw-option active" onclick="selectWithdrawMethod('crypto')">
                    <div style="font-weight: 600; margin-bottom: 5px;">💰 Cryptocurrency</div>
                    <div style="font-size: 12px; color: #666;">Withdraw to your crypto wallet</div>
                </div>
                <div class="withdraw-option" onclick="selectWithdrawMethod('bank')">
                    <div style="font-weight: 600; margin-bottom: 5px;">🏦 Bank Transfer</div>
                    <div style="font-size: 12px; color: #666;">Withdraw to your bank account</div>
                </div>
            </div>

            <div id="cryptoWithdrawForm">
                <div class="trade-section">
                    <div class="trade-label">Select Cryptocurrency</div>
                    <select class="trade-input" id="withdrawCrypto">
                        <option value="btc">Bitcoin (BTC)</option>
                        <option value="eth">Ethereum (ETH)</option>
                        <option value="usdt">Tether (USDT)</option>
                    </select>
                </div>
                
                <div class="trade-section">
                    <div class="trade-label">Wallet Address</div>
                    <input type="text" class="trade-input" id="withdrawAddress" placeholder="Enter your wallet address">
                </div>
                
                <div class="trade-section">
                    <div class="trade-label">Amount (USDT)</div>
                    <input type="number" class="trade-input" id="withdrawAmount" placeholder="Enter amount">
                    <div class="info-text">Available: <span id="withdrawAvailable">0.00</span> USDT</div>
                    <div class="info-text">Minimum withdrawal: 50 USDT</div>
                </div>
            </div>

            <div id="bankWithdrawForm" style="display: none;">
                <div class="trade-section">
                    <div class="trade-label">Bank Name</div>
                    <input type="text" class="trade-input" id="bankName" placeholder="Enter bank name">
                </div>
                
                <div class="trade-section">
                    <div class="trade-label">Account Number</div>
                    <input type="text" class="trade-input" id="bankAccount" placeholder="Enter account number">
                </div>
                
                <div class="trade-section">
                    <div class="trade-label">Account Holder Name</div>
                    <input type="text" class="trade-input" id="accountHolder" placeholder="Enter account holder name">
                </div>
                
                <div class="trade-section">
                    <div class="trade-label">SWIFT/IBAN Code</div>
                    <input type="text" class="trade-input" id="swiftCode" placeholder="Enter SWIFT or IBAN code">
                </div>
                
                <div class="trade-section">
                    <div class="trade-label">Amount (USDT)</div>
                    <input type="number" class="trade-input" id="bankWithdrawAmount" placeholder="Enter amount">
                    <div class="info-text">Available: <span id="bankWithdrawAvailable">0.00</span> USDT</div>
                    <div class="info-text">Minimum withdrawal: 100 USDT</div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="submitWithdrawal()">Submit Withdrawal</button>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div class="modal" id="depositModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Deposit Funds</h2>
                <button class="close-btn" onclick="closeDeposit()">&times;</button>
            </div>
            <div style="padding: 20px 0;">
                <div class="trade-section">
                    <div class="trade-label">Select Cryptocurrency</div>
                    <select class="trade-input" id="depositCrypto" onchange="updateDepositAddress()">
                        <option value="btc">Bitcoin (BTC)</option>
                        <option value="eth">Ethereum (ETH)</option>
                        <option value="usdt">Tether (USDT)</option>
                    </select>
                </div>

                <div class="trade-section">
                    <div class="trade-label">Deposit Address</div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; margin: 15px 0; word-break: break-all; font-family: monospace; font-size: 13px; border: 2px dashed #ddd;" id="depositAddress">Select a cryptocurrency</div>
                    <button style="padding: 10px 20px; background: #4285f4; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;" onclick="copyAddress()">Copy Address</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Change Password</h2>
                <button class="close-btn" onclick="closeChangePassword()">&times;</button>
            </div>
            <div id="changePasswordMessage"></div>
            <div class="input-group">
                <label>Current Password</label>
                <input type="password" id="currentPassword" placeholder="Enter current password">
            </div>
            <div class="input-group">
                <label>New Password</label>
                <input type="password" id="newPassword" placeholder="Enter new password">
            </div>
            <div class="input-group">
                <label>Confirm New Password</label>
                <input type="password" id="confirmPassword" placeholder="Confirm new password">
            </div>
            <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
        </div>
    </div>

    <!-- Chat Modal -->
    <div class="modal" id="chatModal">
        <div class="modal-content" style="max-width: 600px; height: 600px; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2 class="modal-title">Support Chat</h2>
                <button class="close-btn" onclick="closeChat()">&times;</button>
            </div>
            <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 15px; background: #f8f9fa; border-radius: 12px; margin-bottom: 15px;">
                <div style="text-align: center; color: #666; padding: 20px;">Loading messages...</div>
            </div>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="chatInput" placeholder="Type your message..." style="flex: 1; padding: 12px; border: 2px solid #e9ecef; border-radius: 12px;" onkeypress="if(event.key==='Enter') sendMessage()">
                <button class="btn btn-primary" style="width: auto; padding: 12px 24px; margin: 0;" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDWQBTrvvxCL5Qd23iSMTQlWkaPKZgjhqw",
            authDomain: "trading-dapp-d5aa4.firebaseapp.com",
            projectId: "trading-dapp-d5aa4",
            storageBucket: "trading-dapp-d5aa4.firebasestorage.app",
            messagingSenderId: "690266747119",
            appId: "1:690266747119:web:0f22d45fbee53ee3c3eb1a"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let userBalance = 0;
        let userName = '';
        let userId = '';
        let selectedCoin = null;
        let tradeDirection = 'up';
        let selectedPercentage = 15;
        let balanceUpdateListener = null;
        let chatListener = null;
        let isTradeExecuting = false;
        let currentPage = 'home';
        let withdrawMethod = 'crypto';
        let historyFilter = 'trades';
        
        let btcBalance = 0;
        let ethBalance = 0;
        let usdtBalance = 0;

        const WALLET_ADDRESSES = {
            btc: "bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh",
            eth: "0xd3B617d4009573DeB612C7126043AB7F6D050025",
            usdt: "TYASr5UV6HEcXatwdFQfmLVUqQQQMUxHLS"
        };

        const coins = [
            { name: 'BTC', fullName: 'Bitcoin', class: 'btc', price: 109770.33, symbol: 'bitcoin' },
            { name: 'ETH', fullName: 'Ethereum', class: 'eth', price: 4030.81, symbol: 'ethereum' },
            { name: 'XRP', fullName: 'Ripple', class: 'xrp', price: 2.8131, symbol: 'ripple' },
            { name: 'DOGE', fullName: 'Dogecoin', class: 'doge', price: 0.2309, symbol: 'dogecoin' },
            { name: 'ADA', fullName: 'Cardano', class: 'ada', price: 1.2456, symbol: 'cardano' },
            { name: 'BNB', fullName: 'Binance Coin', class: 'bnb', price: 692.45, symbol: 'binancecoin' },
            { name: 'SOL', fullName: 'Solana', class: 'sol', price: 245.67, symbol: 'solana' },
            { name: 'LINK', fullName: 'Chainlink', class: 'link', price: 28.91, symbol: 'chainlink' },
            { name: 'DOT', fullName: 'Polkadot', class: 'dot', price: 8.92, symbol: 'polkadot' },
            { name: 'LTC', fullName: 'Litecoin', class: 'ltc', price: 156.78, symbol: 'litecoin' }
        ];

        async function fetchLivePrices() {
            try {
                const symbols = coins.map(c => c.symbol).join(',');
                const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${symbols}&vs_currencies=usd&include_24hr_change=true`);
                const data = await response.json();
                
                coins.forEach(coin => {
                    if (data[coin.symbol] && data[coin.symbol].usd) {
                        coin.price = data[coin.symbol].usd;
                        coin.change24h = data[coin.symbol].usd_24h_change || 0;
                    }
                });
                
                renderCoins();
                updatePortfolio();
            } catch (error) {
                console.log('Using cached prices');
            }
        }

        function startPriceUpdates() {
            fetchLivePrices();
            setInterval(fetchLivePrices, 60000);
        }

        function generateUserId() {
            return Math.floor(10000 + Math.random() * 90000).toString();
        }

        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            if (el) {
                el.innerHTML = `<div class="message ${type}">${message}</div>`;
                setTimeout(() => { el.innerHTML = ''; }, 4000);
            }
        }

        function showRegister() {
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('loginForm').classList.add('hidden');
        }

        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function showAuth() {
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('active');
        }

        function showDashboard() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            renderCoins();
            startPriceUpdates();
        }

        async function register() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const repeatPassword = document.getElementById('regRepeatPassword').value;

            if (!name || !email || !password || !repeatPassword) {
                showMessage('authMessage', 'Please fill all fields', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('authMessage', 'Password must be at least 6 characters', 'error');
                return;
            }

            if (password !== repeatPassword) {
                showMessage('authMessage', 'Passwords do not match', 'error');
                return;
            }

            showMessage('authMessage', 'Creating account...', 'success');

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                const newUserId = generateUserId();

                await db.collection('users').doc(user.uid).set({
                    userId: newUserId,
                    name: name,
                    email: email,
                    balance: 0,
                    btcBalance: 0,
                    ethBalance: 0,
                    usdtBalance: 0,
                    tradingMode: 'loss',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showMessage('authMessage', 'Account created successfully!', 'success');
            } catch (error) {
                showMessage('authMessage', error.message, 'error');
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showMessage('loginMessage', 'Please fill all fields', 'error');
                return;
            }

            showMessage('loginMessage', 'Logging in...', 'success');

            try {
                await auth.signInWithEmailAndPassword(email, password);
                showMessage('loginMessage', 'Login successful!', 'success');
            } catch (error) {
                showMessage('loginMessage', error.message, 'error');
            }
        }

        function logout() {
            if (balanceUpdateListener) balanceUpdateListener();
            if (chatListener) chatListener();
            auth.signOut();
        }

        async function forgotPassword() {
            const email = document.getElementById('loginEmail').value.trim();
            
            if (!email) {
                showMessage('loginMessage', 'Please enter your email address', 'error');
                return;
            }

            try {
                await auth.sendPasswordResetEmail(email);
                showMessage('loginMessage', 'Password reset email sent! Check your inbox.', 'success');
            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    showMessage('loginMessage', 'No account found with this email', 'error');
                } else {
                    showMessage('loginMessage', error.message, 'error');
                }
            }
        }

        async function loadUserData() {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                userBalance = userData.balance || 0;
                userName = userData.name || 'User';
                userId = userData.userId || '00000';
                btcBalance = userData.btcBalance || 0;
                ethBalance = userData.ethBalance || 0;
                usdtBalance = userData.usdtBalance || 0;
                
                updateBalanceDisplay();
                updatePortfolio();
                
                if (balanceUpdateListener) balanceUpdateListener();
                balanceUpdateListener = db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        userBalance = data.balance || 0;
                        btcBalance = data.btcBalance || 0;
                        ethBalance = data.ethBalance || 0;
                        usdtBalance = data.usdtBalance || 0;
                        updateBalanceDisplay();
                        updatePortfolio();
                    }
                });
            }
        }

        function updateBalanceDisplay() {
            document.getElementById('userBalance').textContent = userBalance.toFixed(2);
            document.getElementById('userName').textContent = userName;
            document.getElementById('userId').textContent = userId;
            document.getElementById('profileUserId').textContent = userId;
            document.getElementById('profileUserName').textContent = userName;
        }

        function navigateTo(page) {
            currentPage = page;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(page + 'Page').classList.add('active');
            event.target.closest('.nav-item').classList.add('active');
            
            if (page === 'portfolio') {
                updatePortfolio();
            } else if (page === 'swap') {
                updateSwapBalances();
            } else if (page === 'history') {
                loadHistory();
            }
        }

        function renderCoins() {
            const coinList = document.getElementById('coinList');
            coinList.innerHTML = coins.map((coin, index) => {
                const change24h = coin.change24h || 0;
                const changeColor = change24h >= 0 ? '#4caf50' : '#f44336';
                const changeSign = change24h >= 0 ? '+' : '';
                
                return `
                <div class="coin-item" onclick="openTrade(${index})">
                    <div class="coin-icon ${coin.class}">${coin.name}</div>
                    <div class="coin-info">
                        <div class="coin-name">${coin.fullName}</div>
                        <div style="font-size: 11px; color: ${changeColor}; font-weight: 600;">
                            ${changeSign}${change24h.toFixed(2)}% 24h
                        </div>
                    </div>
                    <div class="coin-price">
                        ${coin.price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 8})}
                        <div style="font-size: 10px; color: #888; margin-top: 3px;">Live Price</div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function updatePortfolio() {
            const btcCoin = coins.find(c => c.name === 'BTC');
            const ethCoin = coins.find(c => c.name === 'ETH');
            
            const btcValue = btcBalance * (btcCoin ? btcCoin.price : 109770);
            const ethValue = ethBalance * (ethCoin ? ethCoin.price : 4030);
            const usdtValue = usdtBalance;
            const totalValue = btcValue + ethValue + usdtValue + userBalance;
            
            document.getElementById('totalPortfolioValue').textContent = ' + totalValue.toFixed(2);
            
            const portfolioList = document.getElementById('portfolioList');
            portfolioList.innerHTML = `
                <div class="portfolio-card">
                    <div class="portfolio-header">
                        <div>
                            <div class="crypto-icon btc">BTC</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="crypto-amount">${btcBalance.toFixed(8)}</div>
                            <div class="crypto-value">${btcValue.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
                <div class="portfolio-card">
                    <div class="portfolio-header">
                        <div>
                            <div class="crypto-icon eth">ETH</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="crypto-amount">${ethBalance.toFixed(8)}</div>
                            <div class="crypto-value">${ethValue.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
                <div class="portfolio-card">
                    <div class="portfolio-header">
                        <div>
                            <div class="crypto-icon usdt">USDT</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="crypto-amount">${(usdtBalance + userBalance).toFixed(2)}</div>
                            <div class="crypto-value">${(usdtValue + userBalance).toFixed(2)}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateSwapBalances() {
            const fromCrypto = document.getElementById('swapFromCrypto').value;
            const toCrypto = document.getElementById('swapToCrypto').value;
            
            let fromBal = 0;
            if (fromCrypto === 'usdt') fromBal = userBalance + usdtBalance;
            else if (fromCrypto === 'btc') fromBal = btcBalance;
            else if (fromCrypto === 'eth') fromBal = ethBalance;
            
            let toBal = 0;
            if (toCrypto === 'usdt') toBal = userBalance + usdtBalance;
            else if (toCrypto === 'btc') toBal = btcBalance;
            else if (toCrypto === 'eth') toBal = ethBalance;
            
            document.getElementById('fromBalance').textContent = `Balance: ${fromBal.toFixed(8)}`;
            document.getElementById('toBalance').textContent = `Balance: ${toBal.toFixed(8)}`;
            calculateSwap();
        }

        function calculateSwap() {
            const fromAmount = parseFloat(document.getElementById('swapFromAmount').value) || 0;
            const fromCrypto = document.getElementById('swapFromCrypto').value;
            const toCrypto = document.getElementById('swapToCrypto').value;
            
            if (fromAmount <= 0) {
                document.getElementById('swapToAmount').value = '';
                document.getElementById('exchangeRate').textContent = '-';
                return;
            }
            
            const btcCoin = coins.find(c => c.name === 'BTC');
            const ethCoin = coins.find(c => c.name === 'ETH');
            
            const prices = {
                usdt: 1,
                btc: btcCoin ? btcCoin.price : 109770,
                eth: ethCoin ? ethCoin.price : 4030
            };
            
            const fromValueUSD = fromAmount * prices[fromCrypto];
            const toAmount = fromValueUSD / prices[toCrypto];
            
            document.getElementById('swapToAmount').value = toAmount.toFixed(8);
            document.getElementById('exchangeRate').textContent = `1 ${fromCrypto.toUpperCase()} = ${(prices[fromCrypto] / prices[toCrypto]).toFixed(8)} ${toCrypto.toUpperCase()}`;
        }

        async function executeSwap() {
            const fromAmount = parseFloat(document.getElementById('swapFromAmount').value);
            const fromCrypto = document.getElementById('swapFromCrypto').value;
            const toCrypto = document.getElementById('swapToCrypto').value;
            const toAmount = parseFloat(document.getElementById('swapToAmount').value);
            
            if (!fromAmount || fromAmount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            if (fromCrypto === toCrypto) {
                alert('Cannot swap same cryptocurrency');
                return;
            }
            
            let fromBal = 0;
            if (fromCrypto === 'usdt') fromBal = userBalance + usdtBalance;
            else if (fromCrypto === 'btc') fromBal = btcBalance;
            else if (fromCrypto === 'eth') fromBal = ethBalance;
            
            if (fromAmount > fromBal) {
                alert('Insufficient balance');
                return;
            }
            
            try {
                const updates = {};
                
                if (fromCrypto === 'usdt') {
                    if (fromAmount <= userBalance) {
                        updates.balance = userBalance - fromAmount;
                    } else {
                        const remainingFromUSDT = fromAmount - userBalance;
                        updates.balance = 0;
                        updates.usdtBalance = usdtBalance - remainingFromUSDT;
                    }
                } else if (fromCrypto === 'btc') {
                    updates.btcBalance = btcBalance - fromAmount;
                } else if (fromCrypto === 'eth') {
                    updates.ethBalance = ethBalance - fromAmount;
                }
                
                if (toCrypto === 'usdt') {
                    updates.usdtBalance = (updates.usdtBalance !== undefined ? updates.usdtBalance : usdtBalance) + toAmount;
                } else if (toCrypto === 'btc') {
                    updates.btcBalance = (updates.btcBalance !== undefined ? updates.btcBalance : btcBalance) + toAmount;
                } else if (toCrypto === 'eth') {
                    updates.ethBalance = (updates.ethBalance !== undefined ? updates.ethBalance : ethBalance) + toAmount;
                }
                
                await db.collection('users').doc(currentUser.uid).update(updates);
                
                alert(`Successfully swapped ${fromAmount.toFixed(8)} ${fromCrypto.toUpperCase()} for ${toAmount.toFixed(8)} ${toCrypto.toUpperCase()}`);
                document.getElementById('swapFromAmount').value = '';
                document.getElementById('swapToAmount').value = '';
                updateSwapBalances();
            } catch (error) {
                alert('Swap failed: ' + error.message);
            }
        }

        function openTrade(index) {
            selectedCoin = coins[index];
            document.getElementById('modalTitle').textContent = `Trade ${selectedCoin.fullName}`;
            document.getElementById('availableBalance').textContent = userBalance.toFixed(2);
            document.getElementById('tradeAmount').value = '';
            document.getElementById('expectedProfit').textContent = '0.00';
            document.getElementById('timeFrame').value = '60';
            document.getElementById('timeFrameWarning').style.display = 'none';
            updateTimeFrameAndProfit();
            document.getElementById('tradingModal').classList.add('active');
            
            tradeDirection = 'up';
            document.getElementById('upBtn').className = 'direction-btn up';
            document.getElementById('downBtn').className = 'direction-btn down inactive';
            isTradeExecuting = false;
            document.getElementById('executeTradeBtn').disabled = false;
        }

        function closeTradeModal() {
            document.getElementById('tradingModal').classList.remove('active');
        }

        function selectDirection(direction) {
            tradeDirection = direction;
            document.getElementById('upBtn').className = direction === 'up' ? 'direction-btn up' : 'direction-btn up inactive';
            document.getElementById('downBtn').className = direction === 'down' ? 'direction-btn down' : 'direction-btn down inactive';
        }

        function updateTimeFrameAndProfit() {
            const timeFrame = parseInt(document.getElementById('timeFrame').value);
            const warning = document.getElementById('timeFrameWarning');
            
            if (timeFrame === 90 && userBalance < 100000) {
                warning.style.display = 'block';
                warning.textContent = 'Requires balance above 100,000 USDT';
                document.getElementById('timeFrame').value = '60';
                return;
            }
            
            if (timeFrame === 120 && userBalance < 500000) {
                warning.style.display = 'block';
                warning.textContent = 'Requires balance above 500,000 USDT';
                document.getElementById('timeFrame').value = '60';
                return;
            }
            
            warning.style.display = 'none';
            
            if (timeFrame === 60) selectedPercentage = 15;
            else if (timeFrame === 90) selectedPercentage = 25;
            else if (timeFrame === 120) selectedPercentage = 35;
            
            updateExpectedProfit();
        }

        function updateExpectedProfit() {
            const amount = parseFloat(document.getElementById('tradeAmount').value) || 0;
            const profit = amount * (selectedPercentage / 100);
            document.getElementById('expectedProfit').textContent = profit.toFixed(2);
        }

        async function executeTrade() {
            if (isTradeExecuting) {
                return;
            }
            
            isTradeExecuting = true;
            document.getElementById('executeTradeBtn').disabled = true;
            
            const amount = parseFloat(document.getElementById('tradeAmount').value);
            const timeFrame = parseInt(document.getElementById('timeFrame').value);

            if (!amount || amount < 100) {
                showMessage('tradeMessage', 'Minimum trade amount is 100 USDT', 'error');
                isTradeExecuting = false;
                document.getElementById('executeTradeBtn').disabled = false;
                return;
            }

            if (amount > userBalance) {
                showMessage('tradeMessage', 'Insufficient balance', 'error');
                isTradeExecuting = false;
                document.getElementById('executeTradeBtn').disabled = false;
                return;
            }

            try {
                const pendingTrades = await db.collection('trades')
                    .where('userId', '==', currentUser.uid)
                    .where('status', '==', 'pending')
                    .get();

                if (!pendingTrades.empty) {
                    showMessage('tradeMessage', 'Please wait for your current trade to finish', 'error');
                    isTradeExecuting = false;
                    document.getElementById('executeTradeBtn').disabled = false;
                    return;
                }

                const newBalance = userBalance - amount;
                await db.collection('users').doc(currentUser.uid).update({ balance: newBalance });

                await db.collection('trades').add({
                    userId: currentUser.uid,
                    userIdNumber: userId,
                    userName: userName,
                    userEmail: currentUser.email,
                    coin: selectedCoin.name,
                    coinFull: selectedCoin.fullName,
                    purchasePrice: selectedCoin.price,
                    amount: amount,
                    direction: tradeDirection,
                    percentage: selectedPercentage,
                    timeFrame: timeFrame,
                    status: 'pending',
                    result: null,
                    profit: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                userBalance = newBalance;
                updateBalanceDisplay();
                
                showMessage('tradeMessage', 'Trade executed successfully!', 'success');
                
                setTimeout(() => {
                    closeTradeModal();
                    isTradeExecuting = false;
                }, 2000);

            } catch (error) {
                showMessage('tradeMessage', 'Trade failed: ' + error.message, 'error');
                isTradeExecuting = false;
                document.getElementById('executeTradeBtn').disabled = false;
            }
        }

        function openWithdraw() {
            document.getElementById('withdrawModal').classList.add('active');
            document.getElementById('withdrawAvailable').textContent = userBalance.toFixed(2);
            document.getElementById('bankWithdrawAvailable').textContent = userBalance.toFixed(2);
            withdrawMethod = 'crypto';
        }

        function closeWithdraw() {
            document.getElementById('withdrawModal').classList.remove('active');
        }

        function selectWithdrawMethod(method) {
            withdrawMethod = method;
            document.querySelectorAll('.withdraw-option').forEach(opt => opt.classList.remove('active'));
            event.target.closest('.withdraw-option').classList.add('active');
            
            if (method === 'crypto') {
                document.getElementById('cryptoWithdrawForm').style.display = 'block';
                document.getElementById('bankWithdrawForm').style.display = 'none';
            } else {
                document.getElementById('cryptoWithdrawForm').style.display = 'none';
                document.getElementById('bankWithdrawForm').style.display = 'block';
            }
        }

        async function submitWithdrawal() {
            try {
                if (withdrawMethod === 'crypto') {
                    const crypto = document.getElementById('withdrawCrypto').value;
                    const address = document.getElementById('withdrawAddress').value.trim();
                    const amount = parseFloat(document.getElementById('withdrawAmount').value);
                    
                    if (!address) {
                        showMessage('withdrawMessage', 'Please enter wallet address', 'error');
                        return;
                    }
                    
                    if (!amount || amount < 50) {
                        showMessage('withdrawMessage', 'Minimum withdrawal is 50 USDT', 'error');
                        return;
                    }
                    
                    if (amount > userBalance) {
                        showMessage('withdrawMessage', 'Insufficient balance', 'error');
                        return;
                    }
                    
                    const newBalance = userBalance - amount;
                    await db.collection('users').doc(currentUser.uid).update({ balance: newBalance });
                    
                    await db.collection('withdrawals').add({
                        userId: currentUser.uid,
                        userIdNumber: userId,
                        userName: userName,
                        userEmail: currentUser.email,
                        method: 'crypto',
                        crypto: crypto.toUpperCase(),
                        address: address,
                        amount: amount,
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    userBalance = newBalance;
                    updateBalanceDisplay();
                    
                    showMessage('withdrawMessage', 'Withdrawal request submitted successfully!', 'success');
                    setTimeout(() => closeWithdraw(), 2000);
                    
                } else {
                    const bankName = document.getElementById('bankName').value.trim();
                    const accountNumber = document.getElementById('bankAccount').value.trim();
                    const accountHolder = document.getElementById('accountHolder').value.trim();
                    const swiftCode = document.getElementById('swiftCode').value.trim();
                    const amount = parseFloat(document.getElementById('bankWithdrawAmount').value);
                    
                    if (!bankName || !accountNumber || !accountHolder || !swiftCode) {
                        showMessage('withdrawMessage', 'Please fill all bank details', 'error');
                        return;
                    }
                    
                    if (!amount || amount < 100) {
                        showMessage('withdrawMessage', 'Minimum withdrawal is 100 USDT', 'error');
                        return;
                    }
                    
                    if (amount > userBalance) {
                        showMessage('withdrawMessage', 'Insufficient balance', 'error');
                        return;
                    }
                    
                    const newBalance = userBalance - amount;
                    await db.collection('users').doc(currentUser.uid).update({ balance: newBalance });
                    
                    await db.collection('withdrawals').add({
                        userId: currentUser.uid,
                        userIdNumber: userId,
                        userName: userName,
                        userEmail: currentUser.email,
                        method: 'bank',
                        bankName: bankName,
                        accountNumber: accountNumber,
                        accountHolder: accountHolder,
                        swiftCode: swiftCode,
                        amount: amount,
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    userBalance = newBalance;
                    updateBalanceDisplay();
                    
                    showMessage('withdrawMessage', 'Withdrawal request submitted successfully!', 'success');
                    setTimeout(() => closeWithdraw(), 2000);
                }
            } catch (error) {
                showMessage('withdrawMessage', 'Withdrawal failed: ' + error.message, 'error');
            }
        }

        function openDeposit() {
            document.getElementById('depositModal').classList.add('active');
            updateDepositAddress();
        }

        function closeDeposit() {
            document.getElementById('depositModal').classList.remove('active');
        }

        function updateDepositAddress() {
            const crypto = document.getElementById('depositCrypto').value;
            document.getElementById('depositAddress').textContent = WALLET_ADDRESSES[crypto];
        }

        function copyAddress() {
            const address = document.getElementById('depositAddress').textContent;
            navigator.clipboard.writeText(address).then(() => {
                alert('Address copied to clipboard!');
            });
        }

        function openChangePassword() {
            document.getElementById('changePasswordModal').classList.add('active');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        function closeChangePassword() {
            document.getElementById('changePasswordModal').classList.remove('active');
        }

        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                showMessage('changePasswordMessage', 'Please fill all fields', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showMessage('changePasswordMessage', 'New password must be at least 6 characters', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showMessage('changePasswordMessage', 'New passwords do not match', 'error');
                return;
            }

            try {
                const user = auth.currentUser;
                const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);

                await user.reauthenticateWithCredential(credential);
                await user.updatePassword(newPassword);

                showMessage('changePasswordMessage', 'Password changed successfully!', 'success');
                setTimeout(() => {
                    closeChangePassword();
                }, 2000);
            } catch (error) {
                if (error.code === 'auth/wrong-password') {
                    showMessage('changePasswordMessage', 'Current password is incorrect', 'error');
                } else {
                    showMessage('changePasswordMessage', error.message, 'error');
                }
            }
        }

        function openChat() {
            document.getElementById('chatModal').classList.add('active');
            loadChatMessages();
        }

        function closeChat() {
            document.getElementById('chatModal').classList.remove('active');
            if (chatListener) {
                chatListener();
                chatListener = null;
            }
        }

        function loadChatMessages() {
            const chatMessages = document.getElementById('chatMessages');
            
            if (chatListener) {
                chatListener();
                chatListener = null;
            }
            
            chatListener = db.collection('chats')
                .where('userId', '==', currentUser.uid)
                .onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        chatMessages.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No messages yet. Start a conversation!</div>';
                        return;
                    }

                    const messages = [];
                    snapshot.forEach(doc => {
                        messages.push({ id: doc.id, ...doc.data() });
                    });
                    
                    messages.sort((a, b) => {
                        const timeA = a.timestamp?.toMillis() || 0;
                        const timeB = b.timestamp?.toMillis() || 0;
                        return timeA - timeB;
                    });

                    let html = '';
                    messages.forEach(msg => {
                        const isUser = msg.senderType === 'user';
                        const time = msg.timestamp ? new Date(msg.timestamp.toMillis()).toLocaleTimeString() : '';
                        
                        html += `
                            <div style="margin-bottom: 15px; text-align: ${isUser ? 'right' : 'left'};">
                                <div style="display: inline-block; max-width: 70%; padding: 10px 15px; border-radius: 12px; background: ${isUser ? '#4285f4' : '#e9ecef'}; color: ${isUser ? '#fff' : '#333'}; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                    <div style="font-weight: 600; font-size: 12px; margin-bottom: 5px; opacity: 0.8;">${isUser ? 'You' : 'Support'}</div>
                                    <div>${msg.message}</div>
                                    <div style="font-size: 10px; margin-top: 5px; opacity: 0.7;">${time}</div>
                                </div>
                            </div>
                        `;
                        
                        if (!isUser && !msg.read) {
                            db.collection('chats').doc(msg.id).update({ read: true });
                        }
                    });

                    chatMessages.innerHTML = html;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, error => {
                    console.error('Error loading chat messages:', error);
                    chatMessages.innerHTML = '<div style="text-align: center; color: #f44; padding: 20px;">Error loading messages</div>';
                });
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            try {
                await db.collection('chats').add({
                    userId: currentUser.uid,
                    userIdNumber: userId,
                    userName: userName,
                    userEmail: currentUser.email,
                    message: message,
                    senderType: 'user',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false
                });

                input.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message. Please try again.');
            }
        }

        function filterHistory(filter) {
            historyFilter = filter;
            
            const tradesBtn = document.getElementById('tradesFilterBtn');
            const withdrawalsBtn = document.getElementById('withdrawalsFilterBtn');
            
            if (filter === 'trades') {
                tradesBtn.style.background = '#4285f4';
                tradesBtn.style.color = 'white';
                tradesBtn.style.border = 'none';
                withdrawalsBtn.style.background = 'white';
                withdrawalsBtn.style.color = '#333';
                withdrawalsBtn.style.border = '2px solid #e9ecef';
            } else {
                withdrawalsBtn.style.background = '#4285f4';
                withdrawalsBtn.style.color = 'white';
                withdrawalsBtn.style.border = 'none';
                tradesBtn.style.background = 'white';
                tradesBtn.style.color = '#333';
                tradesBtn.style.border = '2px solid #e9ecef';
            }
            
            loadHistory();
        }

        async function loadHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '<div style="text-align:center; padding:20px;">Loading...</div>';

            try {
                if (historyFilter === 'trades') {
                    const tradesSnapshot = await db.collection('trades')
                        .where('userId', '==', currentUser.uid)
                        .get();

                    const trades = [];
                    tradesSnapshot.forEach(doc => {
                        trades.push({ id: doc.id, ...doc.data() });
                    });
                    
                    trades.sort((a, b) => {
                        const timeA = a.createdAt?.toMillis() || 0;
                        const timeB = b.createdAt?.toMillis() || 0;
                        return timeB - timeA;
                    });

                    if (trades.length === 0) {
                        historyList.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">No trades yet</div>';
                        return;
                    }

                    historyList.innerHTML = trades.map(trade => {
                        const date = trade.createdAt ? new Date(trade.createdAt.toMillis()).toLocaleString() : 'N/A';
                        let statusClass = 'wait';
                        let statusText = 'PENDING';
                        let resultText = '';
                        
                        if (trade.status === 'win') {
                            statusClass = 'finished win';
                            statusText = 'WIN';
                            resultText = `<div style="color: #4caf50; font-weight: 600; margin-top: 8px;">Profit: +${trade.profit.toFixed(2)}</div>`;
                        } else if (trade.status === 'loss') {
                            statusClass = 'finished loss';
                            statusText = 'LOSS';
                            resultText = `<div style="color: #f44336; font-weight: 600; margin-top: 8px;">Loss: -${trade.amount.toFixed(2)}</div>`;
                        }
                        
                        return `
                            <div class="history-item ${statusClass}">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div style="font-weight: 600; font-size: 16px;">${trade.coinFull}/USDT</div>
                                    <div style="font-size: 12px; color: #666;">${date}</div>
                                </div>
                                <div>Amount: ${trade.amount.toFixed(2)} | Direction: <span style="color: ${trade.direction === 'up' ? '#4caf50' : '#f44336'}; font-weight: 600;">${trade.direction.toUpperCase()}</span></div>
                                <div style="margin-top: 5px;">Status: <span style="font-weight: 600;">${statusText}</span></div>
                                ${resultText}
                            </div>
                        `;
                    }).join('');
                    
                } else {
                    const withdrawalsSnapshot = await db.collection('withdrawals')
                        .where('userId', '==', currentUser.uid)
                        .get();

                    const withdrawals = [];
                    withdrawalsSnapshot.forEach(doc => {
                        withdrawals.push({ id: doc.id, ...doc.data() });
                    });
                    
                    withdrawals.sort((a, b) => {
                        const timeA = a.createdAt?.toMillis() || 0;
                        const timeB = b.createdAt?.toMillis() || 0;
                        return timeB - timeA;
                    });

                    if (withdrawals.length === 0) {
                        historyList.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">No withdrawals yet</div>';
                        return;
                    }

                    historyList.innerHTML = withdrawals.map(w => {
                        const date = w.createdAt ? new Date(w.createdAt.toMillis()).toLocaleString() : 'N/A';
                        let statusClass = 'withdraw';
                        let statusText = 'PENDING';
                        let statusColor = '#ff9800';
                        
                        if (w.status === 'approved') {
                            statusClass = 'withdraw approved';
                            statusText = 'APPROVED';
                            statusColor = '#4caf50';
                        } else if (w.status === 'rejected') {
                            statusClass = 'withdraw rejected';
                            statusText = 'REJECTED';
                            statusColor = '#f44336';
                        }
                        
                        const methodText = w.method === 'crypto' ? `${w.crypto} Withdrawal` : 'Bank Transfer';
                        const detailText = w.method === 'crypto' ? `Address: ${w.address.substring(0, 20)}...` : `Bank: ${w.bankName}`;
                        
                        return `
                            <div class="history-item ${statusClass}">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div style="font-weight: 600; font-size: 16px;">${methodText}</div>
                                    <div style="font-size: 12px; color: #666;">${date}</div>
                                </div>
                                <div>Amount: ${w.amount.toFixed(2)}</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">${detailText}</div>
                                <div style="margin-top: 8px;">Status: <span style="font-weight: 600; color: ${statusColor};">${statusText}</span></div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading history:', error);
                historyList.innerHTML = '<div style="text-align:center; padding:20px; color:#f44;">Error loading history</div>';
            }
        }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
                showDashboard();
            } else {
                currentUser = null;
                showAuth();
            }
        });
    </script>
</body>
</html>
